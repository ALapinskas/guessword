var e,t,s={},i={};function n(e){var t=i[e];if(void 0!==t)return t.exports;var r=i[e]={exports:{}};return s[e](r,r.exports,n),r.exports}n.m=s,n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,s)=>(n.f[s](e,t),t)),[])),n.u=e=>e+".index.es6.min.js",n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="guessword:",n.l=(s,i,r,a)=>{if(e[s])e[s].push(i);else{var o,l;if(void 0!==r)for(var h=document.getElementsByTagName("script"),c=0;c<h.length;c++){var d=h[c];if(d.getAttribute("src")==s||d.getAttribute("data-webpack")==t+r){o=d;break}}o||(l=!0,(o=document.createElement("script")).type="module",o.charset="utf-8",o.timeout=120,n.nc&&o.setAttribute("nonce",n.nc),o.setAttribute("data-webpack",t+r),o.src=s),e[s]=[i];var u=(t,i)=>{o.onerror=o.onload=null,clearTimeout(m);var n=e[s];if(delete e[s],o.parentNode&&o.parentNode.removeChild(o),n&&n.forEach((e=>e(i))),t)return t(i)},m=setTimeout(u.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=u.bind(null,o.onerror),o.onload=u.bind(null,o.onload),l&&document.head.appendChild(o)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;if("string"==typeof import.meta.url&&(e=import.meta.url),!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),(()=>{var e={792:0};n.f.j=(t,s)=>{var i=n.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else{var r=new Promise(((s,n)=>i=e[t]=[s,n]));s.push(i[2]=r);var a=n.p+n.u(t),o=new Error;n.l(a,(s=>{if(n.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var r=s&&("load"===s.type?"missing":s.type),a=s&&s.target&&s.target.src;o.message="Loading chunk "+t+" failed.\n("+r+": "+a+")",o.name="ChunkLoadError",o.type=r,o.request=a,i[1](o)}}),"chunk-"+t,t)}};var t=(t,s)=>{var i,r,[a,o,l]=s,h=0;if(a.some((t=>0!==e[t]))){for(i in o)n.o(o,i)&&(n.m[i]=o[i]);l&&l(n)}for(t&&t(s);h<a.length;h++)r=a[h],n.o(e,r)&&e[r]&&e[r][0](),e[r]=0},s=self.webpackChunkguessword=self.webpackChunkguessword||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();const r={MODE:{DEBUG:"DEBUG",PRODUCTION:"PRODUCTION"},SCREENS:{},AUDIO:{},CONNECTION_STATUS:{DISCONNECTED:"disconnected",CONNECTED:"connected",CONNECTION_LOST:"connection lost"},EVENTS:{SYSTEM:{START_PAGE:"START_PAGE",STOP_PAGE:"STOP_PAGE",RENDER:{START:"start",END:"end"}},GAME:{BOUNDARIES_COLLISION:"BOUNDARIES_COLLISION",OBJECTS_COLLISION:"OBJECTS_COLLISION"},WEBSOCKET:{SERVER_CLIENT:{CONNECTION_STATUS_CHANGED:"CONNECTION_STATUS_CHANGED",ROOMS_INFO:"roomsInfo",CREATED:"created",JOINED:"joined",FULL:"full",DISCONNECTED:"disconnected",SERVER_MESSAGE:"message",RESTARTED:"restarted"},CLIENT_SERVER:{ROOMS_INFO_REQUEST:"gatherRoomsInfo",CREATE_OR_JOIN:"create or join",RESTART_REQUEST:"restart",CLIENT_MESSAGE:"message"}}},WEBGL:{DRAW_PROGRAMS:{PRIMITIVES:"drawPrimitives",IMAGES:"drawImages"}},DRAW_TYPE:{RECTANGLE:"rect",CONUS:"conus",CIRCLE:"circle",POLYGON:"polygon",LINE:"line",TEXT:"text",IMAGE:"image"},LAYERS:{DEFAULT:"default-view-layer",BOUNDARIES:"boundaries-view-layer"},GAME_OPTIONS:{},LIBRARY:{WEBGL:"webgl"},OPTIMIZATION:{CYCLE_TIME_CALC:{AVERAGES:"AVERAGES",CURRENT:"CURRENT"},NATIVE_JS:{NOT_OPTIMIZED:"NOT_OPTIMIZED",OPTIMIZED:"OPTIMIZED"},WEB_ASSEMBLY:{ASSEMBLY_SCRIPT:"ASSEMBLY_SCRIPT",NATIVE_WAT:"WASM"}}},a="CREATE_INSTANCE_ERROR",o="VIEW_NOT_EXIST",l="CANT_GET_THE_IMAGE",h="UNEXPECTED_INPUT_PARAMS",c="WEBGL_ERROR",d="NOT_FOUND",u="WORLD_DIMENSIONS_NOT_SET",m="UNHANDLED_DRAW_ISSUE",g="UNEXPECTED_WORLD_SIZE",f="AUDIO_NOT_REGISTERED",_="AUDIO_NOT_LOADED",E="POLYGON_VERTICES_NOT_CORRECT";function p(e,t){throw new Error(e+": "+t)}function x(e,t){console.warn(e,t)}class T{#e;#t;#s;#i;#n=0;#r=0;#a=0;#o=0;#l=0;#h=0;#c=0;#d=0;#u=0;#m=0;#g=0;#f;#_;#E;#p;#x=[];#T;#A=!1;constructor(e){}isOffsetTurnedOff(){return this.#T}set mapRotate(e){this.#l=e}#y(e){this._addBoundaryLine(e.x1,e.y1,e.x2,e.y2)}_addBoundariesArray(e){const t=e.length;for(let s=0;s<t;s++){const t=e[s];this._addBoundaryLine(t[0],t[1],t[2],t[3])}}_addBoundaryLine(e,t,s,i){this.#f[this.#u]=e,this.#u++,this.#f[this.#u]=t,this.#u++,this.#f[this.#u]=s,this.#u++,this.#f[this.#u]=i,this.#u++}_addEllipseBoundary(e,t,s,i){this.#_[this.#g]=e,this.#g++,this.#_[this.#g]=t,this.#g++,this.#_[this.#g]=s,this.#g++,this.#_[this.#g]=i,this.#g++}_addPointBoundary(e,t){this.#E[this.#m]=e,this.#m++,this.#E[this.#m]=t,this.#m++}_removeBoundaryLine(e){this.#f[e]=0,this.#f[e+1]=0,this.#f[e+2]=0,this.#f[e+3]=0}_clearBoundaries(){this.#f.fill(0),this.#_.fill(0),this.#E.fill(0),this.#u=0,this.#g=0,this.#m=0}_initiateBoundariesData(){this.#f=new Float32Array(this.#h),this.#_=new Float32Array(this.#c),this.#E=new Float32Array(this.#d)}_setMaxBoundariesSize(e,t=0,s=0){this.#h=e,this.#c=t,this.#d=s}_setWorldDimensions(e,t){this.#e=e,this.#t=t}_setCanvasDimensions(e,t){this.#s=e,this.#i=t}_setMapBoundaries(){const[e,t]=[this.#e,this.#t],[s,i]=[this.#n,this.#r],n=e-s,r=t-i;e&&t||x(u,"Can't set map boundaries."),this.#y({x1:0,y1:0,x2:n,y2:0}),this.#y({x1:n,y1:0,x2:n,y2:r}),this.#y({x1:n,y1:r,x2:0,y2:r}),this.#y({x1:0,y1:r,x2:0,y2:0})}_setWholeWorldMapBoundaries(){const[e,t]=[this.#e,this.#t];e&&t||x(u,"Can't set map boundaries."),this.#p.push([0,0,e,0]),this.#p.push([e,0,e,t]),this.#p.push([e,t,0,t]),this.#p.push([0,t,0,0])}_mergeBoundaries(e=!1){const t=e?this.getWholeWorldBoundaries():this.getBoundaries(),s=new Set(t);for(const e of s.values()){const t=e[0],i=e[1],n=e[2],r=e[3];for(const a of s.values()){const o=a[0],l=a[1],h=a[2],c=a[3];t===h&&i===c&&n===o&&r===l&&(s.delete(e),s.delete(a)),n!==o||r!==l||t!==h&&i!==c||(a[0]=t,a[1]=i,s.delete(e))}}e?this.#f=Array.from(s):this.#p=Array.from(s),s.clear()}_setWholeMapBoundaries(e){this.#p.push(...e)}_enableMapBoundaries(){this.#A=!0}getBoundaries(){const e=this.#f,t=this.#u;let s=[],i=[];for(let n=0;n<t;n++){const t=e[n];s.push(t),(n+1)%4==0&&(i.push(s),s=[])}return i}getRawBoundaries(){return this.#f}getEllipseBoundaries(){return this.#_}getPointBoundaries(){return this.#E}getWholeWorldBoundaries(){return this.#p}get isWorldBoundariesEnabled(){return this.#A}get canvasDimensions(){return[this.#s,this.#i]}get worldDimensions(){return[this.#e,this.#t]}get worldOffset(){return[this.#n,this.#r]}get mapCenter(){return[this.#a,this.#o]}get mapRotate(){return this.#l}get boundariesLen(){return this.#u}get ellipseBLen(){return this.#g}get pointBLen(){return this.#m}centerCameraPosition=(e,t)=>{let[s,i]=this.worldOffset;const[n,r]=this.canvasDimensions,[a,o]=this.worldDimensions,l=n/2,h=r/2,c=h-i;if(l-s<e)if(e<a-l){const t=e-l;t>=0&&(this.#n=Math.round(t))}else if(a>n){const e=a-n;this.#n=Math.round(e)}if(c<t)if(t<o-h){const e=t-h;e>=0&&(this.#r=Math.round(e))}else if(o>r){const e=o-r;this.#r=Math.round(e)}this.#a=e,this.#o=t};personRotatedCenterCamera=(e,t,s)=>{console.log("new centering algorithm")};get renderObjects(){return this.#x}getObjectsByInstance(e){return this.#x.filter((t=>t instanceof e))}_sortRenderObjectsBySortIndex(){this.#x=this.#x.sort(((e,t)=>e.sortIndex-t.sortIndex))}set _renderObject(e){this.#x.push(e)}set _renderObjects(e){this.#x=e}}const A={loadstart:"loadstart",progress:"progress",abort:"abort",error:"error",load:"load",timeout:"timeout"},y=" loader is not registered.",S="Too much recursion. Stop iteration.",w="uploadMethod should be instance of Promise and return upload result value",R=" AtlasXML file extension is incorrect, only .xml file supported",b=" tileset file extension is not correct, only .tsj or .json files are supported",v=" tilemap file extension is not correct, only .tmj or .json files are supported",I=" fileKey and url should be provided";class C{#S;#w;#R=new Map;#b=new Map;constructor(e,t){this.#S=e,this.#w=(e,s,...i)=>{const n=t(e,s,...i);if(n instanceof Promise)return n.then((t=>this.#v(t,e)));throw new TypeError(w)}}#v=(e,t)=>new Promise(((s,i)=>{e||null===e||O("AssetsManager: uploadMethod for "+this.#S+" returns incorrect value"),this.#I(t,e),this.#C(t),s()}));#I(e,t){this.#b.set(e,t)}#C(e){this.#R.delete(e)}get filesWaitingForUpload(){return this.#R.size}get loadingQueue(){return this.#R}get uploadMethod(){return this.#w}_addFile=(e,t)=>{this.#R.has(e)&&O("AssetsManager: File "+this.#S+" with key "+e+" is already added"),this.#R.set(e,t)};_isFileInQueue=e=>this.#R.has(e);_getFile=e=>this.#b.get(e)}class M{#M=5;#P=new EventTarget;#O=new Map;#B=0;constructor(){this.registerLoader("Audio",this._loadAudio),this.registerLoader("Image",this._loadImage),this.registerLoader("TileMap",this._loadTileMap),this.registerLoader("TileSet",this._loadTileSet),this.registerLoader("AtlasImageMap",this._loadAtlasImage),this.registerLoader("AtlasXML",this._loadAtlasXml)}get filesWaitingForUpload(){let e=0;return Array.from(this.#O.values()).map((t=>e+=t.filesWaitingForUpload)),e}registerLoader=(e,t=this._defaultUploadMethod)=>{this["add"+e]=(t,s,...i)=>{this.addFile(e,t,s,...i)},this["get"+e]=t=>this.getFile(e,t),this["is"+e+["InQueue"]]=t=>this.isFileInQueue(e,t);const s=this.#O.get(e)||new C(e,t);this.#O.set(e,s)};preload(){return this.#L(),new Promise((async(e,t)=>{this.#D().then((()=>{this.#N(),e()})).catch((e=>{t(e)}))}))}#D(e=0){return this.#W().then((t=>{if(0===this.filesWaitingForUpload)return Promise.resolve(t);if(++e>this.#M){const e=new Error(S);return this.#k(e),Promise.reject(new Error(S))}return this.#D(e)}))}#W(){return new Promise(((e,t)=>{let s=[];Array.from(this.#O.values()).forEach((e=>{Array.from(e.loadingQueue.entries()).forEach((t=>{const i=new Promise(((s,i)=>e.uploadMethod(t[0],...t[1]).then((e=>s(e)))));s.push(i)}))})),Promise.allSettled(s).then((s=>{for(const i of s){if("rejected"===i.status){const e=i.reason;this.#G(e)?t(e):(O("AssetsManager: "+e.message),this.#k(e))}e(s)}}))}))}addEventListener(e,t,...s){A[e]?this.#P.addEventListener(e,t,...s):O("AssetsManager: Event type should be one of the ProgressEvent.type")}removeEventListener(e,t,...s){this.#P.removeEventListener(e,t,...s)}_loadAtlasXml=(e,t)=>(this.#F(t),fetch(t).then((e=>e.text())).then((e=>(new window.DOMParser).parseFromString(e,"text/xml"))).then((s=>{const i=s.documentElement||s.activeElement,n=i.attributes.getNamedItem("imagePath"),r=i.children;if(n){const s=this.#U(t);return this.addAtlasImageMap(e,s+n.value,r,s),Promise.resolve(i)}{const t=new Error(e+" XML format is not correct.");return this.#k(t),Promise.resolve(t)}})));_loadAtlasImage=(e,t,s,i="anonymous")=>new Promise(((e,n)=>{const r=new Image,a=new Map,o=document.createElement("canvas"),l=o.getContext("2d");r.crossOrigin=i,r.onload=()=>{const t=[];let i=[];o.width=r.width,o.height=r.height,l.drawImage(r,0,0);for(let e of s){const s=e.attributes,n=s.getNamedItem("name").value,r=n.includes(".")?n.split(".")[0]:n,a=s.getNamedItem("x").value,o=s.getNamedItem("y").value,h=s.getNamedItem("width").value,c=s.getNamedItem("height").value;t.push(createImageBitmap(l.getImageData(a,o,h,c),{premultiplyAlpha:"premultiply"})),i.push(r)}this.#j(),Promise.all(t).then((t=>{t.forEach(((e,t)=>{const s=i[t];a.set(s,e),this.addImage(s,"empty url",e)})),o.remove(),e(a)}))},r.onerror=()=>{const s=new Error("Error loading atlas image "+t);this.#k(s),e(null)},r.src=t}));_loadTileSet=(e,t,s=1,i)=>(this.#Y(t),fetch(i?i+t:t).then((e=>e.json())).then((e=>{const{name:t,image:n,spacing:r,margin:a,tilewidth:o,tileheight:l}=e;return t&&n&&!this.isFileInQueue("Image",t)&&this.addImage(t,i?i+n:n),e.gid=s,Promise.resolve(e)})).catch((()=>{const e=new Error("Error loading related tileset "+t);return this.#k(e),Promise.resolve(null)})));_defaultUploadMethod=(e,t)=>fetch(t);_loadTileMap=(e,t,s=!0)=>(this.#V(t),fetch(t).then((e=>e.json())).then((e=>{const i=this.#U(t);if(!0===s&&e.tilesets&&e.tilesets.length>0){const t=[];return e.tilesets.forEach(((e,s)=>{const{firstgid:n,source:r}=e,a=this._loadTileSet("default-"+n,r,n,i).then((e=>(this.#j(),Promise.resolve(e))));t.push(a)})),Promise.all(t).then((t=>{for(let s=0;s<t.length;s++){const i=t[s];e.tilesets[s].data=i}return Promise.resolve(e)}))}return Promise.resolve(e)})).catch((e=>(e.message.includes("JSON.parse:")&&(e=new Error("Error loading tilemap "+t)),this.#k(e),Promise.resolve(null)))));_loadAudio=(e,t)=>new Promise((e=>{const s=new Audio(t);s.addEventListener("loadeddata",(()=>{this.#j(),e(s)})),s.addEventListener("error",(()=>{const s=new Error("Error loading audio "+t);this.#k(s),e(null)}))}));_loadImage=(e,t,s,i="anonymous")=>new Promise(((e,n)=>{if(s)e(s);else{const s=new Image;s.crossOrigin=i,s.onload=()=>{createImageBitmap(s,{premultiplyAlpha:"premultiply"}).then((t=>{this.#j(),e(t)}))},s.onerror=()=>{const s=new Error("Error loading image "+t);this.#k(s),e(null)},s.src=t}}));#F(e){e.includes(".xml")||P(e+R)}#Y(e){e.includes(".tsj")||e.includes(".json")||P(e+b)}#V(e){e.includes(".tmj")||e.includes(".json")||P(e+v)}#G(e){return e.message.includes(w)||e.message.includes(R)||e.message.includes(b)||e.message.includes(v)||e.message.includes(I)||e.message.includes(y)}#U(e){let t=e.split("/"),s=t.length,i="/";return t[s-1].includes(".tmj")||t[s-1].includes(".xml")||t[s-1].includes(".json")?(t.pop(),i=t.join("/")+"/"):(t[s-2].includes(".tmj")||t[s-2].includes(".xml")||t[s-2].includes(".json"))&&(t.splice(s-2,2),i=t.join("/")+"/"),i}addFile(e,t,s,...i){const n=this.#O.get(e);n?(this.#z(t,s,e),n._addFile(t,[s,...i])):P(e+y)}isFileInQueue(e,t){const s=this.#O.get(e);if(s)return s._isFileInQueue(t);P("Loader for "+e+" is not registered!")}getFile(e,t){const s=this.#O.get(e);if(s)return s._getFile(t);P("Loader for "+e+" is not registered!")}#z(e,t,s){const i=I;e&&0!==e.trim().length||P("add"+s+"()"+i),t&&0!==t.trim().length||P("add"+s+"()"+i)}#L(){let e=this.filesWaitingForUpload;this.#P.dispatchEvent(new ProgressEvent(A.loadstart,{total:e}))}#N(){this.#P.dispatchEvent(new ProgressEvent(A.load))}#j(){const e=this.filesWaitingForUpload;this.#B+=1,this.#P.dispatchEvent(new ProgressEvent(A.progress,{lengthComputable:!0,loaded:this.#B,total:e}))}#k(e){O("AssetsManger: "+e.message),this.#P.dispatchEvent(new ErrorEvent(A.error,{error:e}))}}function P(e){throw new Error(e)}function O(e){console.warn(e)}class B{#X;#H;#K;#Z;#J;#q=0;#Q=0;#$=function(){return Math.round(1e6*Math.random())}();#ee=!1;#te;#se;#T=!1;#ie=!1;constructor(e,t,s,i){this.#X=t,this.#H=s,this.#K=i,this.#Z=e}get bgColor(){return this.#K}set bgColor(e){this.#K=e}get type(){return this.#Z}get x(){return this.#X}get y(){return this.#H}set x(e){this.#X=e}set y(e){this.#H=e}get sortIndex(){return this.#q}set sortIndex(e){this.#q=e}get blendFunc(){return this.#J}set blendFunc(e){this.#J=e}get rotation(){return this.#Q}set rotation(e){this.#Q=e}get id(){return this.#$}get isRemoved(){return this.#ee}destroy(){this.#ee=!0}get isMaskAttached(){return!!this.#te}get _maskId(){return this.#te}setMask(e){e._isMask=!0,this.#te=e.id}removeMask(){this.#te=null}set _isMask(e){this.#se=e}get _isMask(){return this.#se}get isOffsetTurnedOff(){return this.#T}turnOffOffset(){this.#T=!0}_calculateRectVertices=(e,t)=>{const s=e/2,i=t/2;return[[-s,-i],[s,-i],[s,i],[-s,i]]};_interpolateConus(e,t=2*Math.PI,s=Math.PI/14){let i=[0,0];for(let n=0;n<=t;n+=s){let t=Math.cos(n)*e,s=Math.sin(n)*e;i.push(t,s)}return i}_calculateConusBoundaries(e,t=2*Math.PI,s=Math.PI/14){let i=[];for(let n=0;n<=t;n+=s){let t=Math.cos(n)*e,s=Math.sin(n)*e;i.push([t,s])}return i}_convertVerticesArray(e){return void 0!==e[0].x&&void 0!==e[0].y?function(e){const t=e.length,s=[];for(let i=0;i<t;i++){const t=e[i];s.push([t.x,t.y])}return s}(e):e}}class L extends B{#ne;#L;#re;constructor(e,t,s,i,n){super(r.DRAW_TYPE.RECTANGLE,e,t,n),this.#ne=s,this.#L=i,this.#re=this._calculateRectVertices(s,i)}get vertices(){return this.#re}get width(){return this.#ne}get height(){return this.#L}set width(e){this.#ne=e}set height(e){this.#L=e}}class D{#X;#H;#ne;#L;constructor(e,t,s,i){this.#X=e,this.#H=t,this.#ne=s,this.#L=i}get x(){return this.#X}get y(){return this.#H}get width(){return this.#ne}get height(){return this.#L}}class N{#X;#H;constructor(e,t,s,i){this.#X=s-e,this.#H=i-t}get x(){return this.#X}get y(){return this.#H}get length(){return Math.sqrt(Math.pow(this.#X,2)+Math.pow(this.#H,2))}get tetaAngle(){return Math.atan2(this.#H,this.#X)}}class W extends B{#ae;#oe;#le;#he;#ce;#de;#ue;#me=document.createElement("canvas");#ge;constructor(e,t,s,i,n){super(r.DRAW_TYPE.TEXT,e,t),this.#de=s,this.#ae=i,this.#he=n,this.#ue,this.#fe()}get boundariesBox(){const e=this.textMetrics?Math.floor(this.textMetrics.width):300,t=this.textMetrics?Math.floor(this.textMetrics.fontBoundingBoxAscent+this.textMetrics.fontBoundingBoxDescent):30;return new D(this.x,this.y-t,e,t)}get vertices(){const e=this.boundariesBox;return this._calculateRectVertices(e.width,e.height)}get text(){return this.#de}set text(e){e!==this.#de&&(this.#de=e,this.#fe())}get font(){return this.#ae}set font(e){e!==this.#ae&&(this.#ae=e,this.#fe())}get textAlign(){return this.#oe}set textAlign(e){e!==this.#oe&&(this.#oe=e,this.#fe())}get textBaseline(){return this.#le}set textBaseline(e){e!==this.#le&&(this.#le=e,this.#fe())}get fillStyle(){return this.#he}set fillStyle(e){e!==this.#he&&(this.#he=e,this.#fe())}get strokeStyle(){return this.#ce}set strokeStyle(e){e!==this.#ce&&(this.#ce=e,this.#fe())}get textMetrics(){return this.#ue}set _textMetrics(e){this.#ue=e}get _textureStorage(){return this.#ge}set _textureStorage(e){this.#ge=e}get _textureCanvas(){return this.#me}#fe(){const e=this.#me.getContext("2d",{willReadFrequently:!0});if(e){e.font=this.font,this._textMetrics=e.measureText(this.text);const t=this.boundariesBox.width,s=this.boundariesBox.height;e.canvas.width=t,e.canvas.height=s,e.clearRect(0,0,t,s),e.font=this.font,e.textBaseline="bottom",this.fillStyle&&(e.fillStyle=this.fillStyle,e.fillText(this.text,0,s)),this.strokeStyle&&(e.strokeStyle=this.strokeStyle,e.strokeText(this.text,0,s)),this.#ge&&(this.#ge._isTextureRecalculated=!0)}else p("UNHANDLED_EXCEPTION","can't getContext('2d')")}}class k extends B{#_e;#Ee;#re;#pe;constructor(e,t,s,i,n,a=0){super(r.DRAW_TYPE.CONUS,e,t,i),this.#_e=s,this.#Ee=n,this.#pe=a,this.#re=this._interpolateConus(s,n)}get vertices(){return this.#re}set vertices(e){this.#re=e}get radius(){return this.#_e}get angle(){return this.#Ee}get fade_min(){return this.#pe}set fade_min(e){this.#pe=e}}class G{#xe;#Te=100;#Ae;#ye;#Se;#we;#Re;constructor(e,t,s=!1,i,n=!1){this.#xe=e,this.#Ae=this.#be(t),this.#ye=i||0,this.#Se=n,this.#we=s}get name(){return this.#xe}get isActive(){return this.#Se}get currentSprite(){return this.#Ae[this.#ye][0]}get _isLastSprite(){return this.#Ae.length-1===this.#ye}iterateAnimationIndex(){const e=this.#ye;this.#Ae[e][1]<Date.now()-this.#Re&&(this._isLastSprite?this.#we?this.#ye=0:this.deactivateAnimation():this.#ye++,this.#Re=Date.now())}activateAnimation=()=>{this.#Se=!0,this.#ye=0,this.#Re=Date.now()};deactivateAnimation=()=>{this.#Se=!1};#be(e){let t=[];return e.forEach((e=>{"number"==typeof e.id&&"number"==typeof e.duration?t.push([e.id,e.duration]):t.push([e,this.#Te])})),t}}class F extends B{#ne;#L;#ve;#Ie;#Ce;#Me;#Pe;#Oe;#Be=0;#re;#Le;#ge;constructor(e,t,s,i,n,a=0,o,l,h=0){super(r.DRAW_TYPE.IMAGE,e,t),this.#ve=n,this.#Ce=new EventTarget,this.#Me=new Map,this.image=l,this.#Oe=a,this.#Be=h,this.#ne=s,this.#L=i,this.#re=o&&!o.r?this._convertVerticesArray(o):o&&o.r?this._calculateConusBoundaries(o.r):this._calculateRectVertices(s,i),this.#Le=o&&void 0!==o.r?o:null}get width(){return this.#ne}get height(){return this.#L}set width(e){this.#ne=e}set height(e){this.#L=e}get key(){return this.#ve}get image(){return this.#Ie}set image(e){this.#ge&&(this.#ge._isTextureRecalculated=!0),this.#Ie=e}get imageIndex(){return this.#Oe}set imageIndex(e){this.#Oe=e}get spacing(){return this.#Be}get hasAnimations(){return this.#Me.size>0}get activeAnimation(){return this.#Pe}get boundaries(){return this.#re}get vertices(){return this.#re}get circleBoundaries(){return this.#Le}_processActiveAnimations(){const e=this.#Pe;if(e){const t=this.#Me.get(e);t.iterateAnimationIndex(),this.#Oe=t.currentSprite}}get _textureStorage(){return this.#ge}set _textureStorage(e){this.#ge=e}emit(e,...t){const s=new Event(e);s.data=[...t],this.#Ce.dispatchEvent(s)}addEventListener(e,t,s){this.#Ce.addEventListener(e,t,s)}removeEventListener(e,t,s){this.#Ce.removeEventListener(e,t,s)}addAnimation(e,t,s){this.#De(t)||p(h," animationSpriteIndexes should be Array of indexes, or Array of objects {duration:number, id:number}");const i=new G(e,t,s);this.#Me.set(e,i),this.addEventListener(e,this.#Ne)}#De(e){let t=!0;return e.forEach((e=>{"number"!=typeof e&&("number"==typeof e.duration&&"number"==typeof e.id||(t=!1))})),t}#Ne=e=>{const t=e.type,s=this.#Me.get(t);this.#Pe&&this.#Pe!==t&&this.stopRepeatedAnimation(this.#Pe),s.activateAnimation(),this.#Pe=t,this.#Oe=s.currentSprite};stopRepeatedAnimation(e){this.#Me.get(e).deactivateAnimation(),this.#Pe=null}removeAllAnimations(){for(let[e,t]of this.#Me.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#Me.clear(),this.#Me=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class U extends B{#re;constructor(e,t){super(r.DRAW_TYPE.LINE,e[0][0],e[0][1],t),this.#re=e}get vertices(){return this.#re}set vertices(e){this.#re=e}}class j extends B{#re;constructor(e,t){super(r.DRAW_TYPE.POLYGON,e[0].x,e[0].y,t),this.#re=this._convertVerticesArray(e)}get vertices(){return this.#re}set vertices(e){this.#re=e}}class Y extends B{#_e;#re;constructor(e,t,s,i){super(r.DRAW_TYPE.CIRCLE,e,t,i),this.#_e=s,this.#re=this._interpolateConus(s)}get vertices(){return this.#re}set vertices(e){this.#re=e}get radius(){return this.#_e}}class V{#We;#ke;#Ge;#Fe=0;constructor(e,t){this.#Fe=12*t,this.#We=new Float32Array(this.#Fe),this.#ke=new Float32Array(this.#Fe),this.#Ge=new Int32Array(4*e)}get vectors(){return this.#We}get textures(){return this.#ke}get _bTempIndexes(){return this.#Ge}get bufferSize(){return this.#Fe}}class z{#Ue;#je;#Ye;#Ve;#ze="-#-";#Xe;#He;#Ke;#Ze;#Je;#te;#q=0;#Me=new Map;#T;constructor(e,t,s,i,n,r,a=!1,o){this.#Ue=e,this.#je=t,this.#Ye=s,this.#Ve=i,this.#He=[],this.#Xe=n,this.#Ke=r,this.#Ze=a,this.#Je=a||!1,o&&this.setMask(o),this.#qe(i,r)}get layerKey(){return this.#Ue}get tileMapKey(){return this.#je}get tilemap(){return this.#Ye}get tilesets(){return this.#Ve}get tilesetImages(){return this.#Xe}get layerData(){return this.#Ke}get setBoundaries(){return this.#Ze}get drawBoundaries(){return this.#Je}set drawBoundaries(e){this.#Je=e}get _maskId(){return this.#te}setMask(e){e._isMask=!0,this.#te=e.id}removeMask(){this.#te=null}get sortIndex(){return this.#q}set sortIndex(e){this.#q=e}get isOffsetTurnedOff(){return this.#T}turnOffOffset(){this.#T=!0}get hasAnimations(){return this.#Me.size>0}get _textureStorages(){return this.#He}_setTextureStorage(e,t){this.#He[e]=t}#qe(e,t){let s=0,i=0,n=0;e.forEach(((e,r)=>{const a=e.data.tiles,o=e.data.name,l=e.firstgid,h=this.tilesets[r+1],c=h?h.firstgid:1e9;if(a)for(let r of a){const a=r.animation,h=r.objectgroup,c=r.id;if(a){const t=o+this.#ze+c,s=this.#Qe(a),i=new G(t,s,!0);this.#Me.set(t,i),e.data._hasAnimations||(e.data._hasAnimations=!0,e.data._animations=new Map,e.data._animations.set(c,s[0][0])),this.#Ne(i)}h&&this.#Ze&&(e.data._hasBoundaries||(e.data._hasBoundaries=!0,e.data._boundaries=new Map),e.data._boundaries.set(c,h),h.objects.forEach((e=>{if(e.ellipse){const e=t.data.filter((e=>e===c+l)).length;s+=4*e}else if(e.point){const e=t.data.filter((e=>e===c+l)).length;i+=2*e}else if(e.polygon){const s=t.data.filter((e=>e===c+l)).length;n+=2*e.polygon.length*s}else{const e=t.data.filter((e=>e===c+l)).length;n+=16*e}})))}const d=t.data.filter((e=>e>=l&&e<c)).length,u=t.data.length;this.#Ze&&(n+=16*d),e._temp=new V(u,d)})),t.ellipseBoundariesLen=s,t.pointBoundariesLen=i,t.polygonBoundariesLen=n}#Qe(e){return e.map((e=>({duration:e.duration,id:e.tileid})))}_processActiveAnimations(){for(let e of this.#Me.values())e.isActive&&(e.iterateAnimationIndex(),this.#$e(e))}#Ne=e=>{e.activateAnimation(),this.#$e(e)};#$e=e=>{const[t,s]=e.name.split(this.#ze),i=this.#Ve.findIndex((e=>e.data.name===t));this.#Ve[i].data._animations.set(parseInt(s),e.currentSprite)};stopRepeatedAnimation(e){this.#Me.get(e).deactivateAnimation()}removeAllAnimations(){for(let[e,t]of this.#Me.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#Me.clear(),this.#Me=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class X{#et;#tt;constructor(e){this.#et=e}get stageData(){return this.#tt}#st(e){return this.#tt._renderObject=e,this.#tt._sortRenderObjectsBySortIndex(),e}rect(e,t,s,i,n){const r=new L(e,t,s,i,n);return this.#st(r),r}text(e,t,s,i,n){const r=new W(e,t,s,i,n);return this.#st(r),r}conus(e,t,s,i,n,r=0){const a=new k(e,t,s,i,n,r);return this.#st(a),a}circle(e,t,s,i){const n=new Y(e,t,s,i);return this.#st(n),n}image(e,t,s,i,n,r=0,a,o=0){const h=this.#et.getImage(n);h||p(l,"iLoader can't get the image with key: "+n);const c=new F(e,t,s,i,n,r,a,h,o);return this.#st(c),c}line(e,t){const s=new U(e,t);return this.#st(s),s}polygon(e,t){const s=new j(e,t);return this.#st(s),s}tiledLayer(e,t,s,i){const n=this.#et.getTileMap(t),r=n.tilesets.map((e=>Object.assign({},e))),a=r.map((e=>this.#et.getImage(e.data.name))),o=Object.assign({},n.layers.find((t=>t.name===e))),l=new z(e,t,n,r,a,o,s,i);return this.#st(l),l}_registerNewObjectMethod=(e,t)=>{this[e]=(...e)=>this.#it(t,...e)};#it=(e,...t)=>{const s=e(...t);return this.#st(s),s};_attachPageData=e=>{this.#tt=e};_detachPageData=()=>{this.#tt=null}}class H{constructor(){}static mode=r.MODE.DEBUG;static gameOptions={library:r.LIBRARY.WEBGL,optimization:r.OPTIMIZATION.NATIVE_JS.OPTIMIZED,optimizationWASMUrl:"./src/wa/calculateBufferDataWat.wasm",optimizationAssemblyUrl:"/src/wa/calculateBufferDataAssembly.wasm",loadingScreen:{backgroundColor:"rgba(128, 128, 128, 0.6)",loadingBarBg:"rgba(128, 128, 128, 1)",loadingBarProgress:"rgba(128, 128, 128, 0.2)"},render:{minCycleTime:16.666,cyclesTimeCalc:{check:r.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES,averageFPStime:1e4},boundaries:{mapBoundariesEnabled:!0,realtimeCalculations:!0,wholeWorldPrecalculations:!1}},debug:{checkWebGlErrors:!1,debugMobileTouch:!1,boundaries:{drawLayerBoundaries:!1,drawObjectBoundaries:!1,boundariesColor:"rgba(224, 12, 21, 0.6)",boundariesWidth:2},delayBetweenObjectRender:!1}};static network={enabled:!1,address:"https://gameserver.reslc.ru:9009",gatherRoomsInfoInterval:5e3};static canvasMaxSize={width:1800,height:1800};static worldSize={width:960,height:960};static defaultCanvasKey="default";static customSettings={}}class K{static debug(...e){H.mode===r.MODE.DEBUG&&e.forEach((e=>console.log(e)))}}class Z extends Event{#nt;constructor(e,t){super(e),this.#rt(e)||p("UNEXPECTED_EVENT_NAME",", Please check if event is exist"),this.#nt=t}#rt(e){return Object.values(r.EVENTS.WEBSOCKET.SERVER_CLIENT).find((t=>t===e))}get data(){return this.#nt}}class J extends EventTarget{#at;#ot;constructor(e){super(),e||p(a,"systemSettings should be passed to class instance"),this.#at=e}init(){n.e(105).then(n.bind(n,105)).then((e=>{this.#ot=e.io(this.#at.network.address,{withCredentials:!0}),this.#lt()}))}get isServerConnected(){return!(!this.#ot||!this.#ot.connected)}get playerId(){return this.#ot.id}sendGatherRoomsInfo(){this.#ot.emit(r.EVENTS.WEBSOCKET.CLIENT_SERVER.ROOMS_INFO_REQUEST)}sendCreateOrJoinRoom(e,t){this.#ot.emit(r.EVENTS.WEBSOCKET.CLIENT_SERVER.CREATE_OR_JOIN,e,t)}sendMessage(e){this.#ot.emit(r.EVENTS.WEBSOCKET.CLIENT_SERVER.CLIENT_MESSAGE,e)}#ht=()=>{K.debug("connected, socket id: "+this.#ot.id),this.dispatchEvent(new Event(r.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#ct=e=>{K.debug("server disconnected, reason: "+e),this.dispatchEvent(new Event(r.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#dt=e=>{console.warn("server data: ",e)};#ut=e=>{K.debug("received new message from server: "+e),this.dispatchEvent(new Z(r.EVENTS.WEBSOCKET.SERVER_CLIENT.SERVER_MESSAGE,e))};#mt=e=>{K.debug("received roomsInfo "+e),this.dispatchEvent(new Z(r.EVENTS.WEBSOCKET.SERVER_CLIENT.ROOMS_INFO,e))};#gt=(e,t)=>{K.debug("CLIENT SOCKET: Created room  "+e),this.dispatchEvent(new Z(r.EVENTS.WEBSOCKET.SERVER_CLIENT.CREATED,{room:e,map:t}))};#ft=e=>{K.debug("CLIENT SOCKET: Room is full, can't join: "+e),this.dispatchEvent(new Z(r.EVENTS.WEBSOCKET.SERVER_CLIENT.FULL,{room:e}))};#_t=(e,t)=>{K.debug("CLIENT SOCKET: Joined to room: "+e,", map: ",t),this.dispatchEvent(new Z(r.EVENTS.WEBSOCKET.SERVER_CLIENT.JOINED,{room:e,map:t}))};#Et=e=>{this.dispatchEvent(new Z(r.EVENTS.WEBSOCKET.SERVER_CLIENT.DISCONNECTED,{playerId:e}))};#lt(){this.#ot.on("connect",this.#ht),this.#ot.on("disconnect",this.#ct),this.#ot.on("data",this.#dt),this.#ot.on("roomsInfo",this.#mt),this.#ot.on("created",this.#gt),this.#ot.on("full",this.#ft),this.#ot.on("joined",this.#_t),this.#ot.on("log",(function(e){console.log.apply(console,e)})),this.#ot.on("message",this.#ut),this.#ot.on("removed",(function(e){console.log("removed message"),console.log(e)})),this.#ot.on("disconnected",this.#Et),addEventListener("beforeunload",this.#pt)}#pt=()=>{this.#ot.disconnect()}}class q{#xt=.5;#Tt=new Map;#At;constructor(e){this.#At=e}getAudio=e=>{const t=this.#Tt.get(e);return null===t?(x(_,"Audio with key "+e+" exists, but not actually loaded"),t):t||(x(f,""),null)};getAudioCloned=e=>{const t=this.#Tt.get(e);if(null===t)return x(_,"Audio with key "+e+" exists, but not actually loaded"),t;if(t){const e=t.cloneNode();return e.volume=this.#xt,e}return x(f),null};set volume(e){this.#xt=e,this.#yt(e)}get volume(){return this.#xt}#yt(e){for(const t of this.#Tt.values())t&&(t.volume=e)}registerAudio(e){let t=this.#At.getAudio(e);this.#Tt.set(e,t)}}function Q(e,t){const s=t.x1,i=t.y1,n=t.x2,r=t.y2,a=e.x1,o=e.y1,l=e.x2,h=e.y2,c=(s-n)*(o-h)-(i-r)*(a-l);if(0===c)return;let d=((s*r-i*n)*(a-l)-(s-n)*(a*h-o*l))/c,u=((s*r-i*n)*(o-h)-(i-r)*(a*h-o*l))/c;const m={x:d,y:u};return se(m,e,1e-13)&&se(m,t,1e-13)?{x:d,y:u,p:Math.sqrt(Math.pow(d-s,2)+Math.pow(u-i,2))}:void 0}function $(e,t,s,i){return Math.atan2(i-t,s-e)}function ee(e,t){return e.x*t.x+e.y*t.y}function te(e,t){return e.x*t.y-t.x*e.y}function se(e,t,s=0){return(e.x>=t.x1-s&&e.x<=t.x2+s||e.x<=t.x1+s&&e.x>=t.x2-s)&&(e.y>=t.y1-s&&e.y<=t.y2+s||e.y<=t.y1+s&&e.y>=t.y2-s)}function ie(e,t){const s=new N(t.x1,t.y1,t.x2,t.y2).length;return new N(t.x1,t.y1,e.x,e.y).length+new N(t.x2,t.y2,e.x,e.y).length<=s+.2}function ne(e,t){const s=e.length;for(let i=0;i<s;i+=1){let s=e[i],n=e[i+1];if(!n){if(s[0]===e[0][0]&&s[1]===e[0][1])continue;n=e[0]}const r=Q({x1:s[0],y1:s[1],x2:n[0],y2:n[1]},t);if(r)return r}if(e[s-1][0]!==e[0][0]&&e[s-1][1]!==e[0][1]){const i=e[s-1],n=e[0],r=Q({x1:i[0],y1:i[1],x2:n[0],y2:n[1]},t);if(r)return r}return null}function re(e,t,s){const i=s.length;for(let n=0;n<i;n+=1){let i=s[n],r=s[n+1];if(r||(r=s[0]),ie({x:e,y:t},{x1:i[0],y1:i[1],x2:r[0],y2:r[1]}))return!0}return!1}function ae(e,t,s){const i=s.r;return new N(e,t,s.x,s.y).length<i}function oe(e,t,s,i){const n=i.x1,r=i.y1,a=i.x2,o=i.y2,l={x:n-e,y:r-t},h={x:a-e,y:o-t},c={x:a-n,y:o-r},d={x:n-a,y:r-o},u=Math.sqrt(Math.pow(c.x,2)+Math.pow(c.y,2)),m=ee(l,d),g=ee(h,c);let f;return m>0&&g>0?(f=te(l,h)/u,f<0&&(f*=-1)):f=Math.min(l.length,h.length),f<=s}function le(e,t){const s=e[0],i=e[1],n=e[2],r=e[3],a={x:s-t[0][0],y:i-t[0][1]},o={x:s-t[1][0],y:i-t[1][1]},l=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2)),h=Math.sqrt(Math.pow(o.x,2)+Math.pow(o.y,2)),c=Math.min(l,h);if(c>Math.max(n,r))return!1;const d=c===l?a:o,u=Math.atan2(d.y,d.x),m={x:0-Math.cos(u)*n,y:0-Math.sin(u)*r};return!(c>Math.sqrt(Math.pow(m.x,2)+Math.pow(m.y,2)))}function he(e,t){const s=e[0],i=e[1],n={x:s-t.x,y:i-t.y},r=Math.sqrt(Math.pow(n.x,2)+Math.pow(n.y,2));if(r>Math.max(e[2],e[3])+t.r)return!1;{const n=$(s,i,t.x,t.y),a=s-(s+e[2]*Math.cos(n)),o=i-(i+e[3]*Math.sin(n));return r<=Math.sqrt(Math.pow(a,2)+Math.pow(o,2))+t.r&&{x:a,y:o,p:1}}}function ce(e,t){const s=t.length;for(let i=0;i<s;i+=1){let s=t[i],n=t[i+1];if(n||(n=t[0]),le(e,[s,n]))return!0}return!1}function de(e=0,t=0,s,i,n=2*Math.PI,r=Math.PI/8){let a=[];for(let o=0;o<=n;o+=r){let n=Math.cos(o)*s+e,r=Math.sin(o)*i+t;a.push([n,r])}return a}class ue{#St;#wt;#Rt=!0;constructor(e,t=0){this.#wt=e,this.#St=t}get _isTextureRecalculated(){return this.#Rt}set _isTextureRecalculated(e){this.#Rt=e}get _texture(){return this.#wt}set _texture(e){this.#wt=e}get _textureIndex(){return this.#St}}class me{#bt;#vt;#It;#Ct;#Mt;#Pt;#Ot=new Map;#Bt=new Map;constructor(e,t){e&&e instanceof WebGLRenderingContext||p(h," context parameter should be specified and equal to WebGLRenderingContext"),this.#bt=e,this.#Ct=t,this.#It=t.debug.checkWebGlErrors,this.#vt=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.#Mt=e.createBuffer(),this.#Pt=e.createBuffer()}getProgram(e){return this.#Ot.get(e)}getProgramVarLocations(e){return this.#Bt.get(e)}_fixCanvasSize(e,t){this.#bt.viewport(0,0,e,t)}_initiateJsRender=e=>new Promise(((t,s)=>{const i=e.getObjectsByInstance(z),[n,r]=e.worldDimensions;let a=0,o=0,l=0,h=0,c=0;i.forEach((e=>{const t=e.setBoundaries,s=e.layerData,i=e.tilemap,n=e.tilesets,{tileheight:r,tilewidth:d}=i,u=d,m=r;for(let e=0;e<n.length;e++){const e=u*s.width,i=m*s.height,n=s.polygonBoundariesLen,r=s.ellipseBoundariesLen,d=s.pointBoundariesLen;h<e&&(h=e),c<i&&(c=i),t&&(a+=n,o+=r,l+=d)}})),0===h||0===c||h===n&&c===r||(x(g," World size from tilemap is different than settings one, fixing..."),e._setWorldDimensions(h,c)),this.#Ct.render.boundaries.mapBoundariesEnabled&&(a+=16),e._setMaxBoundariesSize(a,o,l),e._initiateBoundariesData(),t(!0)}));_initWebGlAttributes=()=>{const e=this.#bt;return e.enable(e.BLEND),e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,255),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),Promise.resolve()};_initiateWasm=e=>{const t=this.#Ct.optimization===r.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT?this.#Ct.optimizationWASMUrl:this.#Ct.optimizationAssemblyUrl;return new Promise(((e,s)=>{this.layerData=new WebAssembly.Memory({initial:1e3}),this.layerDataFloat32=new Float32Array(this.layerData.buffer);const i={env:{memory:this.layerData,logi:console.log,logf:console.log}};fetch(t).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,i))).then((t=>{this.calculateBufferData=t.instance.exports.calculateBufferData,e()}))}))};_clearView(){const e=this.#bt;e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}_render(e,t,s=0){const i=this.#bt,n=this.#It?i.getError():0;if(0!==n)throw console.error(n),new Error("Error num: "+n);return i.drawArrays(t,s,e),i.stencilFunc(i.ALWAYS,1,255),new Promise(((e,t)=>{this.#Ct.debug.delayBetweenObjectRender?setTimeout((()=>{e()}),1e3):e()}))}_registerAndCompileWebGlProgram(e,t,s,i,n){const r=this.#Lt(t,s),a=this.#Dt(r,i,n);return this.#Ot.set(e,r),this.#Bt.set(e,a),Promise.resolve()}#Lt(e,t){const s=this.#bt,i=s.createProgram();if(i){const n=this.#Nt(s,e,s.VERTEX_SHADER);n?s.attachShader(i,n):p(c,"#compileShader(vertexShaderSource) is null");const r=this.#Nt(s,t,s.FRAGMENT_SHADER);if(r?s.attachShader(i,r):p(c,"#compileShader(fragmentShaderSource) is null"),s.linkProgram(i),!s.getProgramParameter(i,s.LINK_STATUS)){const e=s.getProgramInfoLog(i);p(c,`Could not compile WebGL program. \n\n${e}`)}}else p(c,"gl.createProgram() is null");return i}#Dt(e,t,s){const i=this.#bt;let n={};return t.forEach((t=>{n[t]=i.getUniformLocation(e,t)})),s.forEach((t=>{n[t]=i.getAttribLocation(e,t)})),n}#Nt(e,t,s){const i=e.createShader(s);if(i){if(e.shaderSource(i,t),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(i);p(c,"Couldn't compile webGl program. \n\n"+t)}}else p(c,`gl.createShader(${s}) is null`);return i}_bindPrimitives=(e,t,s,i,n)=>{const[a,o]=!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset,l=e.x-a,h=e.y-o,c=[1,1],d=e.rotation,u=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA],{u_translation:m,u_rotation:g,u_scale:f,u_resolution:_,u_color:p,a_position:T,u_fade_min:A}=n;let y=0;switch(t.useProgram(i),t.uniform2f(_,t.canvas.width,t.canvas.height),t.uniform2f(m,l,h),t.uniform2f(f,c[0],c[1]),t.uniform1f(g,d),t.uniform1f(A,0),t.enableVertexAttribArray(T),t.bindBuffer(t.ARRAY_BUFFER,this.#Mt),e.type){case r.DRAW_TYPE.RECTANGLE:this.#Wt(e.width,e.height),y+=6;break;case r.DRAW_TYPE.TEXT:break;case r.DRAW_TYPE.CIRCLE:{const s=e.vertices;t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),y+=s.length/2;break}case r.DRAW_TYPE.POLYGON:{const t=this.#kt(e.vertices);this.#Gt(t);const s=t.length;if(s%3!=0)return x(E,`polygons ${e.id}, vertices are not correct, skip drawing`),Promise.reject();y+=s/2;break}}const S=t.FLOAT;t.vertexAttribPointer(T,2,S,!1,0,0);const w=this.#Ft(e.bgColor);return t.uniform4f(p,w[0]/255,w[1]/255,w[2]/255,w[3]),u&&t.blendFunc(u[0],u[1]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),Promise.resolve([y,t.TRIANGLES])};_bindConus=(e,t,s,i,n)=>{const[r,a]=!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset,o=e.x-r,l=e.y-a,h=[1,1],c=e.rotation,{u_translation:d,u_rotation:u,u_scale:m,u_resolution:g,u_color:f,a_position:_,u_fade_max:E,u_fade_min:p}=n,x=e.vertices,T=e.bgColor,A=e.fade_min,y=e.radius,S=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA];let w=0;t.useProgram(i),t.uniform2f(g,t.canvas.width,t.canvas.height),t.uniform2f(d,o,l),t.uniform2f(m,h[0],h[1]),t.uniform1f(u,c),t.uniform1f(p,A),t.uniform1f(E,y),t.bindBuffer(t.ARRAY_BUFFER,this.#Mt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(x),t.STATIC_DRAW),t.enableVertexAttribArray(_);const R=t.FLOAT;t.vertexAttribPointer(_,2,R,!1,0,0),w+=x.length/2,S&&t.blendFunc(S[0],S[1]);const b=this.#Ft(T);return t.uniform4f(f,b[0]/255,b[1]/255,b[2]/255,b[3]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),Promise.resolve([w,t.TRIANGLE_FAN])};_bindText=(e,t,s,i,n)=>{const{u_translation:r,u_rotation:a,u_scale:o,u_resolution:l,a_position:h,a_texCoord:c,u_image:d}=n,{width:u,height:m}=e.boundariesBox,[g,f]=(e.text,!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset),_=e.x-g,E=e.y-f-m,p=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],x=[1,1],T=_+u,A=E+m,y=[_,E,T,E,_,A,_,A,T,E,T,A];let S=0;t.useProgram(i),t.uniform2f(l,t.canvas.width,t.canvas.height),t.uniform2f(r,_,E),t.uniform2f(o,x[0],x[1]),t.uniform1f(a,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Mt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(y),t.STATIC_DRAW),t.enableVertexAttribArray(h);const w=t.FLOAT;t.vertexAttribPointer(h,2,w,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Pt),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(c),t.vertexAttribPointer(c,2,t.FLOAT,!1,0,0),S+=6,t.blendFunc(p[0],p[1]);let R=e._textureStorage;return R||(R=new ue(t.createTexture()),e._textureStorage=R),!0===R._isTextureRecalculated?(this.#Ut(t,R._texture,e._textureCanvas),R._isTextureRecalculated=!1):this.#jt(t,R._texture),t.uniform1i(d,R._textureIndex),t.depthMask(!1),Promise.resolve([6,t.TRIANGLES])};_bindImage=(e,t,s,i,n)=>{const{u_translation:r,u_rotation:a,u_scale:o,u_resolution:l,a_position:h,a_texCoord:c,u_image:d}=n,[u,m]=!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset,g=e.x-u,f=e.y-m,_=e.image,E=e.imageIndex,p=(e.key,e._maskId),x=e.spacing,T=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],A=[1,1];let y=0,S=0,w=0,R=0,b=0;if(0!==E){const t=(_.width+x)/(e.width+x);w=E%t,R=Math.floor(E/t),y=w*e.width+w*x,S=R*e.height+R*x}const v=g-e.width/2,I=f-e.height/2,C=v+e.width,M=I+e.height,P=1/_.width*y,O=1/_.height*S,B=P+1/_.width*e.width,L=O+1/_.height*e.height,D=[v,I,C,I,v,M,v,M,C,I,C,M],N=[P,O,B,O,P,L,P,L,B,O,B,L];t.useProgram(i),t.uniform2f(l,t.canvas.width,t.canvas.height),t.uniform2f(r,g,f),t.uniform2f(o,A[0],A[1]),t.uniform1f(a,e.rotation),t.bindBuffer(t.ARRAY_BUFFER,this.#Mt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(D),t.STATIC_DRAW),b+=D.length/2,t.enableVertexAttribArray(h);const W=t.FLOAT;t.vertexAttribPointer(h,2,W,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Pt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(N),t.STATIC_DRAW),t.enableVertexAttribArray(c),t.vertexAttribPointer(c,2,t.FLOAT,!1,0,0);let k=e._textureStorage;return k||(k=new ue(t.createTexture()),e._textureStorage=k),!0===k._isTextureRecalculated?(this.#Yt(t,k._texture,e.image),k._isTextureRecalculated=!1):this.#jt(t,k._texture),t.uniform1i(d,k._textureIndex),t.blendFunc(T[0],T[1]),p&&t.stencilFunc(t.EQUAL,p,255),Promise.resolve([b,t.TRIANGLES])};_bindTileImages=async(e,t,s,i,n)=>{const{u_translation:a,u_rotation:o,u_scale:l,u_resolution:h,a_position:c,a_texCoord:d,u_image:u}=n;let m;switch(t.useProgram(i),this.#Ct.optimization){case r.OPTIMIZATION.NATIVE_JS.NOT_OPTIMIZED:m=await this.#Vt(e,s);break;case r.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT:case r.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT:m=await this.#zt(e,s);break;case r.OPTIMIZATION.NATIVE_JS.OPTIMIZED:default:m=await this.#Xt(e,s)}const g=[0,0],f=[1,1],_=["ONE","ONE_MINUS_SRC_ALPHA"],E=e._maskId;let p=0,x=!1;t.enableVertexAttribArray(c),t.enableVertexAttribArray(d),t.uniform2f(h,t.canvas.width,t.canvas.height),t.uniform2f(a,g[0],g[1]),t.uniform2f(l,f[0],f[1]),t.uniform1f(o,0);for(let s=0;s<m.length;s++){const i=m[s],n=i[0],r=i[1],a=(i[2],i[3]);if(n.length>0&&r.length>0){x&&await this._render(p,t.TRIANGLES),t.bindBuffer(t.ARRAY_BUFFER,this.#Mt),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW);const i=2,o=t.FLOAT,l=!1,h=0,m=0;t.vertexAttribPointer(c,i,o,l,h,m),t.bindBuffer(t.ARRAY_BUFFER,this.#Pt),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),t.vertexAttribPointer(d,2,t.FLOAT,!1,0,m);let g=e._textureStorages[s];g||(g=new ue(t.createTexture(),s),e._setTextureStorage(s,g)),!0===g._isTextureRecalculated?(this.#Yt(t,g._texture,a,g._textureIndex),g._isTextureRecalculated=!1):this.#jt(t,g._texture,g._textureIndex),t.uniform1i(u,g._textureIndex),t.blendFunc(t[_[0]],t[_[1]]),p=n.length/2,E&&t.stencilFunc(t.EQUAL,E,255),x=!0}}return Promise.resolve([p,t.TRIANGLES])};_drawPolygon(e,t){const[s,i]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,n=e.x-s,a=e.y-i,o=e.rotation||0,l=e.vertices,h=this.#Ct.debug.boundaries.boundariesColor,c=this.getProgram(r.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:d,u_rotation:u,u_scale:m,u_resolution:g,u_color:f,a_position:_,u_fade_max:p,u_fade_min:T}=this.getProgramVarLocations(r.WEBGL.DRAW_PROGRAMS.PRIMITIVES),A=this.#bt;let y=0;A.useProgram(c),A.uniform2f(g,A.canvas.width,A.canvas.height),A.uniform2f(d,n,a),A.uniform2f(m,1,1),A.uniform1f(u,o),A.uniform1f(T,0),A.enableVertexAttribArray(_),A.bindBuffer(A.ARRAY_BUFFER,this.#Mt);const S=this.#kt(l),w=S.length;if(w%3!=0)return void x(E,"polygon boundaries vertices are not correct, skip drawing");this.#Gt(S),y+=w/2;const R=A.FLOAT;A.vertexAttribPointer(_,2,R,!1,0,0);const b=this.#Ft(h);A.uniform4f(f,b[0]/255,b[1]/255,b[2]/255,b[3]),this._render(y,A.TRIANGLES)}_bindLine=(e,t,s,i,n)=>{const[r,a]=!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset,o=e.x-r,l=e.y-a,h=e.rotation,{u_translation:c,u_rotation:d,u_scale:u,u_resolution:m,u_color:g,a_position:f,u_fade_max:_,u_fade_min:E}=n,p=e.vertices,x=e.bgColor,T=(e.fade_min,e.radius,this.#Ct.debug.boundaries.boundariesWidth);let A=0;t.useProgram(i),t.uniform2f(m,t.canvas.width,t.canvas.height),t.uniform2f(c,o,l),t.uniform2f(u,1,1),t.uniform1f(d,h),t.uniform1f(E,0),t.enableVertexAttribArray(f),t.bindBuffer(t.ARRAY_BUFFER,this.#Mt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(p),t.STATIC_DRAW),A+=p.length/2;const y=t.FLOAT;t.vertexAttribPointer(f,2,y,!1,0,0);const S=this.#Ft(x);return t.uniform4f(g,S[0]/255,S[1]/255,S[2]/255,S[3]),t.lineWidth(T),Promise.resolve([0,t.LINES])};_drawLines(e,t,s=1,i=0,n=[0,0]){const a=this.getProgram(r.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:o,u_rotation:l,u_scale:h,u_resolution:c,u_color:d,a_position:u,u_fade_max:m,u_fade_min:g}=this.getProgramVarLocations(r.WEBGL.DRAW_PROGRAMS.PRIMITIVES),f=this.#bt;let _=0;f.useProgram(a),f.uniform2f(c,f.canvas.width,f.canvas.height),f.uniform2f(o,n[0],n[1]),f.uniform2f(h,1,1),f.uniform1f(l,i),f.uniform1f(g,0),f.enableVertexAttribArray(u),f.bindBuffer(f.ARRAY_BUFFER,this.#Mt),f.bufferData(f.ARRAY_BUFFER,e instanceof Float32Array?e:new Float32Array(e),f.STATIC_DRAW),_+=e.length/2;const E=f.FLOAT;f.vertexAttribPointer(u,2,E,!1,0,0);const p=this.#Ft(t);f.uniform4f(d,p[0]/255,p[1]/255,p[2]/255,p[3]),f.lineWidth(s),this._render(_,f.LINES)}#Xt(e,t){return new Promise(((s,i)=>{const n=e.tilemap,r=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:h}=n,c=h,u=l,[m,g]=t.canvasDimensions,[f,_]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,E=(this.#Ct.render.boundaries.realtimeCalculations,e.setBoundaries),p=[];o||(x(d,"check tilemap and layers name"),i()),this.#Ct.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<r.length;e++){const s=r[e].data,i=r[e].firstgid,n=r[e+1],d=n?n.firstgid:1e9,T=s.tilewidth,A=s.tileheight,y=a[e],S=s.imagewidth,w=s.imageheight,R=s.columns,b=o.width,v=o.height,I=c*b,C=u*v,M=_%u,P=f%c,O=0!==_?Math.floor(_/u):0,B=0!==f?Math.floor(f/c):0,L=C>g?Math.ceil(g/u)+1:v,D=I>m?Math.ceil(m/c)+1:b,N=b-D-B,W=s.spacing,k=(s.margin,s._hasAnimations),G=s._hasBoundaries,F=s._boundaries,U=r[e]._temp;let j=U.vectors,Y=U.textures,V=0;j.fill(0),Y.fill(0);let z=U._bTempIndexes;const X=4*D;let H=O*b;for(let e=0;e<L;e++){H+=B;for(let n=0;n<D;n++){let r=o.data[H];if(r>=i&&r<d){const a=n*h-P,o=e*l-M;if(r-=i,k){const e=s._animations.get(r);void 0!==e&&(r=e)}const c=r%R,d=Math.floor(r/R),u=a,m=o,g=a+T,f=o+A,_=1/S*(c*T+c*W),p=1/w*(d*A+d*W),y=_+1/S*T,b=p+1/w*A;if(j[V]=u,Y[V]=_,V++,j[V]=m,Y[V]=p,V++,j[V]=g,Y[V]=y,V++,j[V]=m,Y[V]=p,V++,j[V]=u,Y[V]=_,V++,j[V]=f,Y[V]=b,V++,j[V]=u,Y[V]=_,V++,j[V]=f,Y[V]=b,V++,j[V]=g,Y[V]=y,V++,j[V]=m,Y[V]=p,V++,j[V]=g,Y[V]=y,V++,j[V]=f,Y[V]=b,V++,E){let s=!1;if(G&&F.size>0){const e=F.get(r);e&&(s=!0,e.objects.forEach((e=>{const s=a+e.x,i=o+e.y;if(0!==e.rotation&&x("tilesetData.tiles.rotation property is not supported yet"),e.polygon)e.polygon.forEach(((n,r)=>{const a=e.polygon[r+1];if(a)t._addBoundaryLine(n.x+s,n.y+i,a.x+s,a.y+i);else{const r=e.polygon[0];t._addBoundaryLine(n.x+s,n.y+i,r.x+s,r.y+i)}}));else if(e.point)t._addPointBoundary(s,i);else if(e.ellipse){const n=e.width/2,r=e.height/2;t._addEllipseBoundary(s+n,i+r,n,r)}else{const n=e.width,r=e.height,a=n+s,o=r+i;t._addBoundaryLine(s,i,a,i),t._addBoundaryLine(a,i,a,o),t._addBoundaryLine(a,o,s,o),t._addBoundaryLine(s,o,s,i)}})))}if(!1===s){const s=t.getRawBoundaries();let i=[a+T,o,a+T,o+A],r=[a+T,o+A,a,o+A],l=[a,o,a+T,o],h=[a,o+A,a,o];if(0!==e){const r=(e-1)*X+4*n,a=z[r+2];if(a){const e=s[a];if(e){const i=s[a+1],n=s[a+2],r=s[a+3],o=l[0],h=l[1],c=l[2],d=l[3];o===n&&h===r&&c===e&&d===i&&(t._removeBoundaryLine(a),l=void 0)}const n=z[r+1],o=s[n];if(o){const e=s[n+1],r=s[n+2],a=s[n+0];o===s[n+2]&&r===a&&(t._removeBoundaryLine(n),i[0]=o,i[1]=e)}const c=z[r+3],d=s[c];if(d){const e=s[c+2],i=s[c+3],n=h[0];d===h[2]&&e===n&&(t._removeBoundaryLine(c),h[2]=e,h[3]=i)}}}if(0!==n){const i=e*X+4*(n-1),a=z[i];if(a){const e=z[i+1],n=s[e],o=s[e+1],c=s[e+2],d=s[e+3],u=h[0],m=h[1],g=h[2],f=h[3];u===c&&m===d&&g===n&&f===o&&(t._removeBoundaryLine(e),h=void 0);const _=s[a];if(_&&l){const e=s[a+1],i=s[a+3],n=l[1];e===l[3]&&i===n&&(t._removeBoundaryLine(a),l[0]=_,l[1]=e)}const E=z[i+2];if(s[E]){const e=s[E+1],i=s[E+2],n=s[E+3],a=r[1];e===r[3]&&n===a&&(t._removeBoundaryLine(E),r[2]=i,r[3]=n)}}}const c=e*X+4*n;l&&(t._addBoundaryLine(l[0],l[1],l[2],l[3]),z[c+0]=t.boundariesLen-4),t._addBoundaryLine(i[0],i[1],i[2],i[3]),z[c+1]=t.boundariesLen-4,t._addBoundaryLine(r[0],r[1],r[2],r[3]),z[c+2]=t.boundariesLen-4,h&&(t._addBoundaryLine(h[0],h[1],h[2],h[3]),z[c+3]=t.boundariesLen-4)}}}H++}H+=N}p.push([j,Y,s.name,y]),z.fill(0)}s(p)}))}#Vt(e,t){return new Promise(((s,i)=>{const n=e.tilemap,r=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:h}=n,c=h,u=l,[m,g]=t.canvasDimensions,[f,_]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset;let E=[];o||(x(d,"check tilemap and layers name"),i()),this.#Ct.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<=r.length-1;e++){const t=r[e].data,s=r[e].firstgid,i=r[e+1],n=i?i.firstgid:1e9,d=t.tilewidth,p=t.tileheight,x=t.columns,T=o.width,A=o.height,y=(Math.ceil(m/c),Math.ceil(g/u),a[e]),S=y.width,w=y.height,R=t.spacing,b=(t.margin,r[e]._temp);let v=0,I=b.vectors,C=b.textures,M=0;I.fill(0),C.fill(0);for(let e=0;e<A;e++)for(let t=0;t<T;t++){let i=o.data[v];if(i>=s&&i<n){i-=s;const n=i%x,r=Math.floor(i/x),a=t*h-f,o=e*l-_,c=a+d,u=o+p,m=1/S*(n*d+n*R),g=1/w*(r*p+r*R),E=m+1/S*d,T=g+1/w*p;I[M]=a,C[M]=m,M++,I[M]=o,C[M]=g,M++,I[M]=c,C[M]=E,M++,I[M]=o,C[M]=g,M++,I[M]=a,C[M]=m,M++,I[M]=u,C[M]=T,M++,I[M]=a,C[M]=m,M++,I[M]=u,C[M]=T,M++,I[M]=c,C[M]=E,M++,I[M]=o,C[M]=g,M++,I[M]=c,C[M]=E,M++,I[M]=u,C[M]=T,M++}v++}E.push([I,C,t.name,y])}s(E)}))}#zt=(e,t)=>new Promise(((s,i)=>{const n=e.tilemap,r=n.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:h}=n,c=o.data.length,u=o.data.filter((e=>0!==e)).length,[m,g]=t.worldDimensions,[f,_]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,E=[];this.layerDataFloat32.set(o.data),o||(x(d,"check tilemap and layers name"),i()),this.#Ct.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<r.length;e++){const t=r[e].data,s=r[e].firstgid,i=r[e+1],n=i?i.firstgid:1e9,d=t.tilewidth,m=t.tileheight,g=t.columns,p=o.width,x=o.height,T=a[e],A=T.width,y=T.height,S=4,w=12*u,R=12*u,b=t.spacing,v=this.calculateBufferData(S,c,w,x,p,h,l,d,m,g,A,y,f,_,s,n,b,!1),I=v>0?this.layerDataFloat32.slice(c,w+c):[],C=v>0?this.layerDataFloat32.slice(w+c,w+R+c):[];E.push([I,C,t.name,T])}s(E)}));#Ft(e){return e.replace("rgba(","").replace(")","").split(",").map((e=>Number(e.trim())))}#kt(e){return this.#Ht(e)}#Ht(e,t=[]){const s=e.length;if(s<=3)return e.forEach((e=>{t.push(e[0]),t.push(e[1])})),t;const i=[...e].sort(((e,t)=>t[1]-e[1])),n=e.indexOf(i[0]),r=n!==s-1?n+1:0;let a=e,o=a.length,l=0,h=r;for(;a.length>2;){const e=a.length;h>=e&&(h-=e);const s=0===h?a[e-1]:a[h-1],i=a[h],n=e===h+1?a[0]:a[h+1];if(c=s,d=i,te({x:(u=n)[0]-c[0],y:u[1]-c[1]},{x:d[0]-c[0],y:d[1]-c[1]})<0)t.push(s[0]),t.push(s[1]),t.push(i[0]),t.push(i[1]),t.push(n[0]),t.push(n[1]),a=a.filter(((e,t)=>t!==h));else{if(l+=1,l>o)return x("TRIANGULATE_ISSUE","Can't extract all triangles vertices."),t;h++}}var c,d,u;return t}#Gt(e){this.#bt.bufferData(this.#bt.ARRAY_BUFFER,new Float32Array(e),this.#bt.STATIC_DRAW)}#Wt(e,t){const s=0+e,i=0+t;this.#bt.bufferData(this.#bt.ARRAY_BUFFER,new Float32Array([0,0,s,0,0,i,0,i,s,0,s,i]),this.#bt.STATIC_DRAW)}#Yt(e,t,s,i=0,n=!1){this.#jt(e,t,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n?e.LINEAR_MIPMAP_LINEAR:e.LINEAR)}#Ut(e,t,s,i=0){this.#jt(e,t,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)}#jt(e,t,s=0){e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,t)}#Kt(e,t){e.deleteTexture(t)}isPowerOfTwo(e){return!(e&e-1)}nextHighestPowerOfTwo(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}}const ge=["u_translation","u_rotation","u_scale","u_resolution","u_image"],fe=["a_position","a_texCoord"],_e=["u_translation","u_rotation","u_scale","u_resolution","u_fade_min","u_fade_max","u_color"],Ee=["a_position"];class pe{#Zt;#Jt;#qt;#Se;#Qt;#$t;#es;#At;#ts;#ss;#is=!1;#ns;#Ce=new EventTarget;#rs;#as=new Map;#os=[];constructor(e,t,s){this.#qt=!1,this.#Zt=document.createElement("canvas"),s.appendChild(this.#Zt),this.#Jt=this.#Zt.getContext("webgl",{stencil:!0}),this.#es=e,this.#At=t,this.#ts=[],this.#ns=this.systemSettings.gameOptions.render.minCycleTime,this.#is=this.systemSettings.gameOptions.render.boundaries.wholeWorldPrecalculations,this.#Qt=new me(this.#Jt,this.#es.gameOptions),this._registerRenderInit(this.#Qt._initiateJsRender),this.systemSettings.gameOptions.optimization!==r.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT&&this.systemSettings.gameOptions.optimization!==r.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT||this._registerRenderInit(this.#Qt._initiateWasm),this._registerRenderInit(this.fixCanvasSize),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(r.WEBGL.DRAW_PROGRAMS.IMAGES,"\n    attribute vec2 a_texCoord;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    varying vec2 v_texCoord;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n\n        mat3 translationMatrix2 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            -u_translation.x, -u_translation.y, 1\n        );\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n\n        mat3 matrix = translationMatrix1 * rotationMatrix * translationMatrix2 * scalingMatrix;\n    \n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        \n        v_texCoord = a_texCoord;\n    }","\n    precision mediump float;\n\n    uniform sampler2D u_image;\n\n    //texCoords passed in from the vertex shader\n    varying vec2 v_texCoord;\n    void main() {\n        vec4 color = texture2D(u_image, v_texCoord);\n        gl_FragColor = color;\n    }",ge,fe))),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(r.WEBGL.DRAW_PROGRAMS.PRIMITIVES,"\n    precision mediump float;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n\n        //mat3 translationMatrix2 = mat3(\n        //    1, 0, 0,\n        //    0, 1, 0,\n        //    -u_translation.x, -u_translation.y, 1\n        //);\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n        \n        mat3 matrix = translationMatrix1 * rotationMatrix * scalingMatrix;\n\n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n    }\n","\n    precision mediump float;\n\n    uniform vec4 u_color;\n    uniform float u_fade_min; \n    uniform float u_fade_max;\n    uniform vec2 u_resolution;\n    uniform vec2 u_translation;\n\n    void main(void) {\n        vec4 p = u_color;\n        if (u_fade_min > 0.0) {\n            vec2 fix_tr = vec2(u_translation.x, u_resolution.y - u_translation.y); \n            float distance = distance(fix_tr.xy, gl_FragCoord.xy);\n            if (u_fade_min <= distance && distance <= u_fade_max) {\n                float percent = ((distance - u_fade_max) / (u_fade_min - u_fade_max)) * 100.0;\n                p.a = u_color.a * (percent / 100.0);\n            }\n        }\n\n        gl_FragColor = p;\n    }\n",_e,Ee))),this._registerRenderInit(this.#Qt._initWebGlAttributes),this._registerObjectRender(W.name,this.#Qt._bindText,r.WEBGL.DRAW_PROGRAMS.IMAGES),this._registerObjectRender(L.name,this.#Qt._bindPrimitives,r.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(j.name,this.#Qt._bindPrimitives,r.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(Y.name,this.#Qt._bindConus,r.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(k.name,this.#Qt._bindConus,r.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(z.name,this.#Qt._bindTileImages,r.WEBGL.DRAW_PROGRAMS.IMAGES),this._registerObjectRender(U.name,this.#Qt._bindLine,r.WEBGL.DRAW_PROGRAMS.PRIMITIVES)}addEventListener=(e,t,s)=>{this.#Ce.addEventListener(e,t,s)};removeEventListener=(e,t,s)=>{this.#Ce.removeEventListener(e,t,s)};get stageData(){return this.#$t}get systemSettings(){return this.#es}get iLoader(){return this.#At}get canvas(){return this.#Zt}get drawContext(){return this.#Jt}emit=(e,...t)=>{const s=new Event(e);s.data=[...t],this.#Ce.dispatchEvent(s)};isAllFilesLoaded=()=>0===this.iLoader.filesWaitingForUpload;initiateContext=e=>Promise.all(this.#os.map((t=>t(e))));clearContext(){this.#Qt._clearView()}setCanvasSize(e,t){this.#Zt.width=e,this.#Zt.height=t,this.#Qt&&this.#Qt._fixCanvasSize(e,t)}fixCanvasSize=()=>{const e=this.systemSettings,t=e.canvasMaxSize.width&&e.canvasMaxSize.width<window.innerWidth?e.canvasMaxSize.width:window.innerWidth,s=e.canvasMaxSize.height&&e.canvasMaxSize.height<window.innerHeight?e.canvasMaxSize.height:window.innerHeight;return this.setCanvasSize(t,s),Promise.resolve()};_registerAndCompileWebGlProgram(e,t,s,i,n){return this.#Qt._registerAndCompileWebGlProgram(e,t,s,i,n),Promise.resolve()}_registerRenderInit(e){this.#os.push(e)}_registerObjectRender(e,t,s){this.#as.set(e,{method:t,webglProgramName:s})}async render(){let e=[],t=[],s=!1;const i=this.stageData.renderObjects;if(0!==i.length){for(let t=0;t<i.length;t++){const s=i[t];if(s.isRemoved){i.splice(t,1),t--;continue}s.hasAnimations&&s._processActiveAnimations();const n=await this._bindRenderObject(s).catch((e=>Promise.reject(e)));e.push(n)}this.systemSettings.gameOptions.debug.boundaries.drawLayerBoundaries&&e.push(this.#ls().catch((e=>Promise.reject(e))))}return(await Promise.allSettled(e)).forEach((e=>{"rejected"===e.status&&(Promise.reject(e.reason),s=!0,t.push(e.reason))})),this.#hs(),this._isCleared=!1,!1===s?Promise.resolve():Promise.reject(t)}set _isCleared(e){this.#qt=e}get _isCleared(){return this.#qt}_createBoundariesPrecalculations(){}#hs(){}#cs(e){return new Promise(((t,s)=>{if(e.setBoundaries){const i=this.iLoader.getTileMap(e.tileMapKey),n=i.tilesets,r=i.layers.find((t=>t.name===e.layerKey)),{tileheight:a,tilewidth:o}=i,l=o,h=a,[c,u]=this.stageData.worldDimensions;let m=[];r||(x(d,"check tilemap and layers name"),s());for(let t=0;t<n.length;t++){const t=r.width,s=r.height,i=l*t,n=h*s;i===c&&n===u||(x(g," World size from tilemap is different than settings one, fixing..."),this.stageData._setWorldDimensions(i,n)),e.setBoundaries&&this.systemSettings.gameOptions.render.boundaries.mapBoundariesEnabled&&this.stageData._setWholeWorldMapBoundaries();let a=0;for(let e=0;e<s;e++)for(let s=0;s<t;s++){let t=r.data[a],i=s*l,n=e*h;0!==t&&(t-=1,m.push([i,n,i+l,n]),m.push([i+l,n,i+l,n+h]),m.push([i+l,n+h,i,n+h]),m.push([i,n+h,i,n])),a++}}this.stageData._setWholeMapBoundaries(m),this.stageData._mergeBoundaries(!0),t()}else t()}))}_bindRenderObject(e){const t=e.constructor.name,s=this.#as.get(t);if(s){const t=s.webglProgramName;if(t){const i=this.#Qt.getProgram(t),n=this.#Qt.getProgramVarLocations(t);return s.method(e,this.drawContext,this.stageData,i,n).then((e=>this.#Qt._render(e[0],e[1])))}return s.method(e,this.drawContext,this.stageData)}if(e.type===r.DRAW_TYPE.IMAGE){const t=this.#Qt.getProgram(r.WEBGL.DRAW_PROGRAMS.IMAGES),s=this.#Qt.getProgramVarLocations(r.WEBGL.DRAW_PROGRAMS.IMAGES);if(!e.image){const t=this.iLoader.getImage(e.key);t?e.image=t:p(l,"iLoader can't get the image with key: "+e.key)}return this.#Qt._bindImage(e,this.drawContext,this.stageData,t,s).then((e=>this.#Qt._render(e[0],e[1]))).then((()=>e.vertices&&this.systemSettings.gameOptions.debug.boundaries.drawObjectBoundaries?this.#Qt._drawPolygon(e,this.stageData):Promise.resolve()))}return console.warn("no registered draw object method for "+t+" skip draw"),Promise.resolve()}#ls(){return new Promise((e=>{const t=this.stageData.getRawBoundaries(),s=this.stageData.getEllipseBoundaries(),i=this.stageData.getPointBoundaries(),n=this.stageData.boundariesLen,r=this.stageData.ellipseBLen,a=this.stageData.pointBLen;if(n&&this.#Qt._drawLines(t,this.systemSettings.gameOptions.debug.boundaries.boundariesColor,this.systemSettings.gameOptions.debug.boundaries.boundariesWidth),r)for(let e=0;e<r;e+=4){const t=de(s[e],s[e+1],s[e+2],s[e+3]);this.#Qt._drawPolygon({x:0,y:0,vertices:t,isOffsetTurnedOff:!0},this.stageData)}if(a)for(let e=0;e<a;e+=2){const t=i[e],s=i[e+1],n=[t,s,t+1,s+1];this.#Qt._drawLines(n,this.systemSettings.gameOptions.debug.boundaries.boundariesColor,this.systemSettings.gameOptions.debug.boundaries.boundariesWidth)}e()}))}#ds(){const e=this.systemSettings.gameOptions.render.cyclesTimeCalc.averageFPStime,t=this.#ts.length;let s=0;for(let e=0;e<t;e++)s+=this.#ts[e];console.log("FPS average for",e/1e3,"sec, is ",(1e3/(s/t)).toFixed(2)),this.#ts=[]}_startRender=async e=>{const t=this.systemSettings.gameOptions;this.#Se=!0,this.#$t=e,this.fixCanvasSize(),t.library===r.LIBRARY.WEBGL&&(await this.#us(),this.timeStart=Date.now(),setTimeout((()=>requestAnimationFrame(this.#ms)))),t.render.cyclesTimeCalc.check===r.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES&&(this.#ss=setInterval((()=>this.#ds()),t.render.cyclesTimeCalc.averageFPStime))};_stopRender=()=>{this.#Se=!1,this.#$t=null,this.#ts=[],clearInterval(this.#ss),this.#ss=null};#us(){return new Promise(((e,t)=>{let s=[];const i=this.#is;s.push(this.initiateContext(this.#$t)),i&&console.warn("isBoundariesPrecalculations() is turned off"),Promise.allSettled(s).then((s=>{s.forEach((e=>{if("rejected"===e.status){const s=e.reason;x(m,s),t(s)}})),e()}))}))}#ms=async()=>{const e=performance.now(),t=this.#ns,s=this.systemSettings.gameOptions.render.cyclesTimeCalc.check===r.OPTIMIZATION.CYCLE_TIME_CALC.CURRENT;this.emit(r.EVENTS.SYSTEM.RENDER.START),this.stageData._clearBoundaries(),this.clearContext(),this.render().then((()=>{const i=performance.now()-e,n=t-i,a=n>0?n:0,o=i+a;s&&i>t&&console.log("current draw take: ",i," ms"),this.emit(r.EVENTS.SYSTEM.RENDER.END),o>0&&this.#ts.push(o),this.#Se&&setTimeout((()=>requestAnimationFrame(this.#ms)),a)})).catch((e=>{e.forEach?e.forEach((e=>{x(m,e)})):x(m,e.message),this._stopRender()}))}}class xe{#gs;constructor(e){this.#gs=e}registerDrawObject(e,t){this.#gs.drawObjectFactory._registerNewObjectMethod(e,t)}registerAndCompileWebGlProgram(e,t,s,i,n){return this.#gs.iRender._registerAndCompileWebGlProgram(e,t,s,i,n)}registerRenderInit(e){this.#gs.iRender._registerRenderInit(e)}registerObjectRender(e,t,s){this.#gs.iRender._registerObjectRender(e,t,s)}}class Te{#at;#fs;#_s;#Es;#et=new M;#ps;#xs=new X(this.#et);#Ts=new Map;#As;#Ce=new EventTarget;constructor(e,t,s){e||p(a,"systemSettings should be passed to class instance"),this.#at=e,this.#Es=new q(this.iLoader),this.#_s=e.network.enabled?new J(e):null,this.#ps=new pe(this.systemSettings,this.iLoader,s),this.#fs=new xe(this,this.#ps),this.#As=t,this.#ps.addEventListener(r.EVENTS.SYSTEM.RENDER.START,(()=>this.emit(r.EVENTS.SYSTEM.RENDER.START))),this.#ps.addEventListener(r.EVENTS.SYSTEM.RENDER.END,(()=>this.emit(r.EVENTS.SYSTEM.RENDER.END)))}emit=(e,...t)=>{const s=new Event(e);s.data=[...t],this.#Ce.dispatchEvent(s)};addEventListener=(e,t,s)=>{this.#Ce.addEventListener(e,t,s)};removeEventListener=(e,t,s)=>{this.#Ce.removeEventListener(e,t,s)};get iNetwork(){return this.#_s}get systemSettings(){return this.#at}get audio(){return this.#Es}get iLoader(){return this.#et}get iRender(){return this.#ps}get drawObjectFactory(){return this.#xs}get iExtension(){return this.#fs}get modules(){return this.#Ts}installModule=(e,t,...s)=>{const i=new t(this,...s);return this.#Ts.has(e)?(x("MODULE_ALREADY_INSTALLED","module "+e+" is already installed"),this.#Ts.get(e)):(this.#Ts.set(e,i),i)};startGameStage=(e,t)=>{if(this.#As.has(e)){const s=this.#As.get(e),i=s.stageData;this.#xs._attachPageData(i),!1===s.isInitiated&&s._init(),s._start(t),this.emit(r.EVENTS.SYSTEM.START_PAGE),this.#ps._startRender(i)}else p(o,"View "+e+" is not registered!")};stopGameStage=e=>{this.#As.has(e)?(this.emit(r.EVENTS.SYSTEM.STOP_PAGE),this.drawObjectFactory._detachPageData(),this.#ps._stopRender(),this.#As.get(e)._stop()):p(o,"View "+e+" is not registered!")}}class Ae{#ys;#Ss=!1;#Se;#ws;#Rs;constructor(){this.#Se=!1}_register(e,t){this.#ys=e,this.#ws=t,this.#Rs=new T(this.#ws.systemSettings.gameOptions),this.#bs(),this.#vs(),this.register()}_init(){this.init(),this.#Ss=!0}register(){}init(){}start(e){}stop(){}resize(){}get iLoader(){return this.#ws.iLoader}get draw(){return this.#ws.drawObjectFactory}_attachCanvasToContainer(e){this.#Is(this.canvasHtmlElement,e)}addRenderObject=e=>{const t=this.stageData;-1!==t.renderObjects.indexOf(e)?x("NEW_BEHAVIOR_INTRODUCED","stage.draw methods add objects to pageData, no need to call addRenderObject"):(t._renderObject=e,t._sortRenderObjectsBySortIndex())};get isActive(){return this.#Se}get isInitiated(){return this.#Ss}get name(){return this.#ys}get stageData(){return this.#Rs}get systemSettings(){return this.#ws.systemSettings}get audio(){return this.#ws.audio}get iSystem(){return this.#ws}get canvasHtmlElement(){return document.getElementsByTagName("canvas")[0]}addEventListener=(e,t,s)=>{this.iSystem.addEventListener(e,t,s)};removeEventListener=(e,t,s)=>{this.iSystem.removeEventListener(e,t,s)};_start(e){this.start(e),this.#Se=!0,window.addEventListener("resize",this._resize),this._resize()}_stop(){this.#Se=!1,window.removeEventListener("resize",this._resize),this.stop()}_resize=()=>{this.#vs(),this.resize()};#Is(e,t){t.appendChild(e)}#bs(){const e=this.systemSettings.worldSize?this.systemSettings.worldSize.width:0,t=this.systemSettings.worldSize?this.systemSettings.worldSize.height:0;this.stageData._setWorldDimensions(e,t)}isBoundariesCollision=(e,t,s)=>{const i=s.type,n=s.vertices,a=s.circleBoundaries;switch(i){case r.DRAW_TYPE.TEXT:case r.DRAW_TYPE.RECTANGLE:case r.DRAW_TYPE.CONUS:case r.DRAW_TYPE.IMAGE:return a?this.#Cs(e,t,s.circleBoundaries.r):this.#Ms(e,t,n,s.rotation);case r.DRAW_TYPE.CIRCLE:x(r.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case r.DRAW_TYPE.LINE:x(r.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:x(r.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};isObjectsCollision=(e,t,s,i)=>{const n=s.type,a=s.vertices,o=s.circleBoundaries;switch(n){case r.DRAW_TYPE.TEXT:case r.DRAW_TYPE.RECTANGLE:case r.DRAW_TYPE.CONUS:case r.DRAW_TYPE.IMAGE:return o?this.#Ps(e,t,o,i):this.#Os(e,t,a,s.rotation,i);case r.DRAW_TYPE.CIRCLE:x(r.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case r.DRAW_TYPE.LINE:x(r.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:x(r.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};#Os(e,t,s,i,n){const a=n.length;let o=[];for(let l=0;l<a;l++){const a=n[l];let h;switch(a.type){case r.DRAW_TYPE.TEXT:case r.DRAW_TYPE.RECTANGLE:case r.DRAW_TYPE.CONUS:case r.DRAW_TYPE.IMAGE:h=this.#Bs(e,t,s,i,a);break;case r.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case r.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}h&&o.push(h)}return o.length>0?this.#Ls(o):null}#Ps(e,t,s,i){const n=s.r,a=i.length;let o=[];for(let s=0;s<a;s++){const a=i[s],l=a.type,h=a.circleBoundaries;let c;switch(l){case r.DRAW_TYPE.TEXT:case r.DRAW_TYPE.RECTANGLE:case r.DRAW_TYPE.CONUS:case r.DRAW_TYPE.IMAGE:c=h?this.#Ds(e,t,n,a.x,a.y,h.r):this.#Ns(e,t,n,a);break;case r.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case r.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}c&&o.push(c)}return o.length>0?this.#Ls(o):null}#Ls(e){return e.sort(((e,t)=>e.p<t.p))[0]}#Ns(e,t,s,i){const[n,r]=this.stageData.worldOffset,a=e-n,o=t-r,l=i.x-n,h=i.y-r,c=i.vertices,d=i.rotation,u=c.length;for(let e=0;e<u;e+=1){const t=c[e];let i=c[e+1];i||(i=c[0]);const n=this.#Ws(t,l,h,d),r=this.#Ws(i,l,h,d),u=oe(a,o,s,{x1:n[0],y1:n[1],x2:r[0],y2:r[1]});if(u)return u}return!1}#Ds(e,t,s,i,n,r){const a=new N(e,t,i,n).length;return console.log(a),console.log(s),console.log(r),!(a-(s+r)>0)}#Bs(e,t,s,i,n){const[r,a]=this.stageData.worldOffset,o=e-r,l=t-a,h=n.x-r,c=n.y-a,d=n.vertices,u=n.rotation,m=s.map((e=>this.#Ws(e,o,l,i))),g=d.length;for(let e=0;e<g;e+=1){const t=d[e];let s=d[e+1];s||(s=d[0]);const i=this.#Ws(t,h,c,u),n=this.#Ws(s,h,c,u),r=ne(m,{x1:i[0],y1:i[1],x2:n[0],y2:n[1]});if(r)return r}return!1}#Ws(e,t,s,i){const n=new N(0,0,e[0],e[1]),r=$(0,0,e[0],e[1]),a=n.length;return[t+a*Math.cos(i+r),s+a*Math.sin(i+r)]}#Cs(e,t,s){const i=this.stageData.getRawBoundaries(),n=this.stageData.getEllipseBoundaries(),r=this.stageData.getPointBoundaries(),[a,o]=this.stageData.worldOffset,l=e-a,h=t-o,c=this.stageData.boundariesLen,d=this.stageData.ellipseBLen,u=this.stageData.pointBLen;for(let e=0;e<c;e+=4){const t=i[e],n=i[e+1],r=i[e+2],a=i[e+3];if(0!==t||0!==n||0!==r||0!==a){const e=oe(l,h,s,{x1:t,y1:n,x2:r,y2:a});if(e)return e}}if(d>0)for(let e=0;e<d;e+=4){const t=he([n[e],n[e+1],n[e+2],n[e+3]],{x:l,y:h,r:s});if(t)return t}if(u>0)for(let e=0;e<u;e+=2){const t=ae(r[e],r[e+1],{x:l,y:h,r:s});if(t)return t}return!1}#Ms(e,t,s,i){const n=this.stageData.getRawBoundaries(),r=this.stageData.getEllipseBoundaries(),a=this.stageData.getPointBoundaries(),[o,l]=this.stageData.worldOffset,h=e-o,c=t-l,d=s.map((e=>this.#Ws(e,h,c,i))),u=this.stageData.boundariesLen,m=this.stageData.ellipseBLen,g=this.stageData.pointBLen;for(let e=0;e<u;e+=4){const t=n[e],s=n[e+1],i=n[e+2],r=n[e+3];if(0!==t||0!==s||0!==i||0!==r){const e=ne(d,{x1:t,y1:s,x2:i,y2:r});if(e)return e}}if(m>0)for(let e=0;e<m;e+=4){const t=ce([r[e],r[e+1],r[e+2],r[e+3]],d);if(t)return t}if(g>0)for(let e=0;e<g;e+=2){const t=re(a[e],a[e+1],d);if(t)return t}return!1}#vs(){const e=this.systemSettings.canvasMaxSize.width&&this.systemSettings.canvasMaxSize.width<window.innerWidth?this.systemSettings.canvasMaxSize.width:window.innerWidth,t=this.systemSettings.canvasMaxSize.height&&this.systemSettings.canvasMaxSize.height<window.innerHeight?this.systemSettings.canvasMaxSize.height:window.innerHeight;this.stageData._setCanvasDimensions(e,t)}}class ye extends Ae{#ks=0;#Gs=0;#Fs=0;register(){}init(){const[e,t]=this.stageData.canvasDimensions,s=e/3;this.background=this.draw.rect(0,0,e,t,this.systemSettings.gameOptions.loadingScreen.backgroundColor),this.loadingBarBg=this.draw.rect(e/2-s/2,t/2-10,s,20,this.systemSettings.gameOptions.loadingScreen.loadingBarBg),this.loadingBarProgress=this.draw.rect(e/2-s/2,t/2-10,s,20,this.systemSettings.gameOptions.loadingScreen.loadingBarProgress),this.text=this.draw.text(e/2-20,t/2-40,"JsGE","24px sans-serif","black"),this.#Fs=s}_progress=e=>{const t=this.#Fs/this.#ks;this.#Gs=e;const s=t*this.#Gs,i=e>this.#ks?this.#Fs:s;this.loadingBarProgress.width=i};start(e){this.#ks=e.total}}const Se="loadingPage";class we{#Us;#js;constructor(e,t){e||p(a,"iSystemSettings should be passed to class instance"),this.#Us=new Map,t||(t=document.createElement("div"),document.body.appendChild(t)),this.#js=new Te(e,this.#Us,t),this.registerStage(Se,ye),this.#js.iLoader.addEventListener("loadstart",this.#Ys),this.#js.iLoader.addEventListener("progress",this.#Vs),this.#js.iLoader.addEventListener("load",this.#zs)}get iSystem(){return this.#js}registerStage(e,t){if(e&&"string"==typeof e&&e.trim().length>0){const s=new t;s._register(e,this.iSystem),this.#Us.set(e,s)}else p(a,"valid class name should be provided")}preloadAllData(){return this.#js.iLoader.preload()}#Ys=e=>{this.#js.startGameStage(Se,{total:e.total})};#Vs=e=>{const t=e.loaded,s=e.total;this.#Us.get(Se)._progress(t,s)};#zs=()=>{this.#js.stopGameStage(Se)}}class Re extends L{z=0;originalXPos;skipShifts=0;constructor(e,t,s,i,n){super(e,t,s,i,n),this.originalXPos=e}rotate=()=>{const e=Math.PI/40,t=this.width,s=this,i=s.rotation;i<Math.PI/2?(s.rotation+=e,this.x=this.originalXPos+(t-t*Math.cos(s.rotation))/2):i<Math.PI||i<3*Math.PI/2||i<2*Math.PI?(this.rotation+=e,this.x=this.originalXPos+(t-t*Math.cos(s.rotation))/2):this.rotation=0}}class be extends B{z=0;originalXPos;#ae;#oe;#le;#he;#ce;#de;#ue;#me;#ge;constructor(e,t,s,i,n,r,a,o){super("text",e,t),this.originalXPos=e,this.#de=s,this.#ae=i,this.#he=n,this.#ue,r?(this._textureStorage=r,this.#me=a,this._textMetrics=o):(this.#me=document.createElement("canvas"),this.#fe())}get boundariesBox(){const e=this.textMetrics?Math.floor(this.textMetrics.width):300,t=this.textMetrics?Math.floor(this.textMetrics.fontBoundingBoxAscent+this.textMetrics.fontBoundingBoxDescent):30;return new D(this.x,this.y-t,e,t)}get vertices(){const e=this.boundariesBox;return this._calculateRectVertices(e.width,e.height)}get text(){return this.#de}set text(e){e!==this.#de&&(this.#de=e,this.#fe())}get font(){return this.#ae}set font(e){e!==this.#ae&&(this.#ae=e,this.#fe())}get textAlign(){return this.#oe}set textAlign(e){e!==this.#oe&&(this.#oe=e,this.#fe())}get textBaseline(){return this.#le}set textBaseline(e){e!==this.#le&&(this.#le=e,this.#fe())}get fillStyle(){return this.#he}set fillStyle(e){e!==this.#he&&(this.#he=e,this.#fe())}get strokeStyle(){return this.#ce}set strokeStyle(e){e!==this.#ce&&(this.#ce=e,this.#fe())}get textMetrics(){return this.#ue}set _textMetrics(e){this.#ue=e}get _textureStorage(){return this.#ge}set _textureStorage(e){this.#ge=e}get _textureCanvas(){return this.#me}#fe(){const e=this.#me.getContext("2d",{willReadFrequently:!0});if(!e)throw new Error("error creating texture");{e.font=this.font,this._textMetrics=e.measureText(this.text);const t=this.boundariesBox.width,s=this.boundariesBox.height;e.canvas.width=t,e.canvas.height=s,e.clearRect(0,0,t,s),e.font=this.font,e.textBaseline="bottom",this.fillStyle&&(e.fillStyle=this.fillStyle,e.fillText(this.text,0,s)),this.strokeStyle&&(e.strokeStyle=this.strokeStyle,e.strokeText(this.text,0,s)),this.#ge&&(this.#ge=void 0)}}rotateAnticlockwise=()=>{const e=Math.PI/40,t=this.boundariesBox.width;this.rotation+=e,this.x=this.originalXPos+(t-t*Math.cos(this.rotation))/2};rotateClockWise=()=>{const e=Math.PI/40,t=this.boundariesBox.width;this.rotation-=e,this.x=this.originalXPos+(t-t*Math.cos(this.rotation))/2};clone=(e,t)=>new be(e,t,this.text,this.font,this.fillStyle,this._textureStorage,this.#me,this.textMetrics)}const ve=(e,t,s,i,n)=>new Re(e,t,s,i,n),Ie=(e,t,s,i,n)=>{const[r,a]=!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset,o=e.x-r,l=e.y-a,h=e.z,c=[1,1,1],d=e.rotation,{u_translation:u,u_rotation:m,u_scale:g,u_resolution:f,u_color:_,a_position:E,u_fade_min:p}=(e.blendFunc?e.blendFunc:(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),n);let x=0;t.useProgram(i),t.uniform4f(f,t.canvas.width,t.canvas.height,1e3,1),t.uniform3f(u,o,l,h),t.uniform3f(g,c[0],c[1],c[2]),t.uniform1f(m,d),t.uniform1f(p,0),t.enableVertexAttribArray(E),t.bindBuffer(t.ARRAY_BUFFER,t.createBuffer());const T=0+e.width,A=0+e.height;t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,h,T,0,h,0,A,h,0,A,h,T,0,h,T,A,h]),t.STATIC_DRAW),x+=6;const y=t.FLOAT;t.vertexAttribPointer(E,3,y,!1,0,0);const S=e.bgColor.replace("rgba(","").replace(")","").split(",").map((e=>Number(e.trim())));return t.uniform4f(_,S[0]/255,S[1]/255,S[2]/255,S[3]),Promise.resolve([6,t.TRIANGLES])},Ce=(e,t,s,i,n)=>new be(e,t,s,i,n),Me=(e,t,s,i,n)=>{const{u_translation:r,u_rotation:a,u_scale:o,u_resolution:l,a_position:h,a_texCoord:c,u_image:d}=n,{width:u,height:m}=e.boundariesBox,[g,f]=(e.text,!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset),_=e.x-g,E=e.y-f-m,p=e.z,x=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],T=e.rotation,A=[1,1,1],y=0+u,S=0+m,w=[0,0,p,y,0,p,0,S,p,0,S,p,y,0,p,y,S,p];let R=0;t.useProgram(i),t.uniform4f(l,t.canvas.width,t.canvas.height,1e3,1),t.uniform3f(r,_,E,p),t.uniform3f(o,A[0],A[1],A[2]),t.uniform1f(a,T),t.bindBuffer(t.ARRAY_BUFFER,t.createBuffer()),t.bufferData(t.ARRAY_BUFFER,new Float32Array(w),t.STATIC_DRAW),t.enableVertexAttribArray(h);const b=t.FLOAT;t.vertexAttribPointer(h,3,b,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,t.createBuffer()),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(c),t.vertexAttribPointer(c,2,t.FLOAT,!1,0,0),R+=6,t.blendFunc(x[0],x[1]);let v=e._textureStorage;return v||(v=new ue(t.createTexture()),e._textureStorage=v),!0===v._isTextureRecalculated?(v._isTextureRecalculated=!1,t.activeTexture(t.TEXTURE0+0),t.bindTexture(t.TEXTURE_2D,v._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e._textureCanvas),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST)):(t.activeTexture(t.TEXTURE0+0),t.bindTexture(t.TEXTURE_2D,v._texture)),t.uniform1i(d,v._textureIndex),t.depthMask(!1),Promise.resolve([6,t.TRIANGLES])};class Pe extends Ae{#Xs;#Hs;#Ks;#Zs=0;#Js=0;#qs=1;#Qs="";#$s;#ei=[];#ti="";#si=!1;#ii=!1;#ni=!1;#ri=0;#ai=0;#oi;#li;#hi=new Map;register(){const e=this.systemSettings.customSettings;this.iLoader.registerLoader("Words",((e,t)=>fetch(t).then((e=>e.text())))),this.iLoader.addWords("englishNouns",e.words_list_url),this.#Zs=e.letterNum,this.#Js=e.attempts,this.#Hs=e.letterCardSize,this.#Xs=e.letterCardSpaces,this.#Ks=e.shiftSize}init(){this.#ci()}start(){this.registerEventListeners()}stop(){this.unregisterEventListeners()}registerEventListeners(){this.canvasHtmlElement.addEventListener("mousemove",this.#di),document.addEventListener("click",this.#ui),document.addEventListener("keydown",this.#mi)}#di=e=>{};#ui=e=>{const t=e.target.dataset;if(t.action)switch(t.action){case"input":if(this.#si||this.#ii||this.#ni)return!1;const e=t.value;this.#gi(e);break;case"clear":if(this.#si||this.#ii||this.#ni)return!1;this.#fi();break;case"confirm":if(this.#si||this.#ii||this.#ni)return!1;this.#_i();break;case"next_screen":this.#Ei(),this.#pi();break;case"game_over":!1===this.#si&&!1===this.#ii&&this.#xi();break;case"reset":!1===this.#si&&!1===this.#ii?(this.#xi(!1),this.#pi()):this.#pi()}else console.log("clicked something else")};#Ti=()=>new Promise(((e,t)=>{const s=this.#ei.length;if(s>0){for(let e=0;e<s;e++){const t=this.#ei[e];for(let e=0;e<t.length;e++){const s=t[e];s.card.destroy(),delete s.card,s.letter&&(s.letter.destroy(),delete s.letter)}}e()}else e()}));#Ai=()=>{this.#Zs;const e=this.#Hs;this.#Xs;for(let t=0;t<this.#Js;t++){const s=[],i=t*e+(t>0?t*this.#Xs:0)+this.#Ks;for(let t=0;t<this.#Zs;t++){const n=t*e+(t>0?t*this.#Xs:0),r=this.draw.rotateYObject(n,i,e,e,"rgba(0, 0, 0, 1)");s.push({letter:null,card:r})}this.#ei[t]=s}};#yi=e=>this.#$s.find((t=>t===e));#Si=e=>{const t=this.#Zs,s=this.#qs-1;let i=[],n=[],r=[];for(let a=0;a<t;a++){const t=e[a],o=this.#ti[a],l=this.#ei[s][a];t===o&&(i.push(a),n.push(a),l.color="yellow",l.index=a,r.push(l))}for(let a=0;a<t;a++)if(!i.includes(a)){const t=e[a],o=this.#ei[s][a],l=this.#ti.split("").findIndex(((e,s)=>e===t&&!n.includes(s)));if(-1!==l)i.push(a),n.push(l),o.color="light-grey",o.index=a,r.push(o);else{const e=-1===this.#ti.indexOf(t);o.color="dark-grey",o.index=a,r.push(o),e&&this.#wi(t)}}return r.sort(((e,t)=>e.index-t.index)),r};#Ri(){this.#qs===this.#Js?this.#xi():(this.#qs+=1,this.#Qs="")}#bi=()=>{this.#ri+=1,this.#si&&(this.#ai+=1,document.getElementById("wins").innerText=this.#ai),document.getElementById("games").innerText=this.#ri};#wi=e=>{document.querySelector(`[data-value="${e}"]`).classList.add("marked")};#vi=()=>{const e=document.getElementsByTagName("button");for(const t of e)t.classList.remove("marked")};#Ii=e=>{console.log("---\x3e>>>error"),console.log(e)};unregisterEventListeners(){}#ci=()=>{this.#hi.set("q",this.draw.rotateYText(0,0,"q","50px sans-serif","white")),this.#hi.set("w",this.draw.rotateYText(0,0,"w","50px sans-serif","white")),this.#hi.set("e",this.draw.rotateYText(0,0,"e","50px sans-serif","white")),this.#hi.set("r",this.draw.rotateYText(0,0,"r","50px sans-serif","white")),this.#hi.set("t",this.draw.rotateYText(0,0,"t","50px sans-serif","white")),this.#hi.set("y",this.draw.rotateYText(0,0,"y","50px sans-serif","white")),this.#hi.set("u",this.draw.rotateYText(0,0,"u","50px sans-serif","white")),this.#hi.set("i",this.draw.rotateYText(0,0,"i","50px sans-serif","white")),this.#hi.set("o",this.draw.rotateYText(0,0,"o","50px sans-serif","white")),this.#hi.set("p",this.draw.rotateYText(0,0,"p","50px sans-serif","white")),this.#hi.set("a",this.draw.rotateYText(0,0,"a","50px sans-serif","white")),this.#hi.set("s",this.draw.rotateYText(0,0,"s","50px sans-serif","white")),this.#hi.set("d",this.draw.rotateYText(0,0,"d","50px sans-serif","white")),this.#hi.set("f",this.draw.rotateYText(0,0,"f","50px sans-serif","white")),this.#hi.set("g",this.draw.rotateYText(0,0,"g","50px sans-serif","white")),this.#hi.set("h",this.draw.rotateYText(0,0,"h","50px sans-serif","white")),this.#hi.set("j",this.draw.rotateYText(0,0,"j","50px sans-serif","white")),this.#hi.set("k",this.draw.rotateYText(0,0,"k","50px sans-serif","white")),this.#hi.set("l",this.draw.rotateYText(0,0,"l","50px sans-serif","white")),this.#hi.set("z",this.draw.rotateYText(0,0,"z","50px sans-serif","white")),this.#hi.set("x",this.draw.rotateYText(0,0,"x","50px sans-serif","white")),this.#hi.set("c",this.draw.rotateYText(0,0,"c","50px sans-serif","white")),this.#hi.set("v",this.draw.rotateYText(0,0,"v","50px sans-serif","white")),this.#hi.set("b",this.draw.rotateYText(0,0,"b","50px sans-serif","white")),this.#hi.set("n",this.draw.rotateYText(0,0,"n","50px sans-serif","white")),this.#hi.set("m",this.draw.rotateYText(0,0,"m","50px sans-serif","white")),setTimeout((()=>{for(const e of this.#hi.values())e.destroy()}),500)};#gi=e=>{const t=-this.#Ks,s=this.#Qs.length,i=document.getElementById("confirm"),n=this.#qs-1,r=this.#ei[n][s],a=r?r.card:null;if(s!==this.#Zs){this.#Qs+=e;const n=a.x+a.width/3.2,o=a.y+a.height-a.height/10,l=this.#hi.get(e).clone(n,o);this.addRenderObject(l),r.letter=l,r.letter.y+=t,r.card.y+=t,setTimeout((()=>{r.letter&&(r.letter.y-=t),r.card.y-=t}),100),s+1===this.#Zs&&(i.disabled=!1)}};#fi=()=>{const e=this.#Qs.length,t=document.getElementById("confirm"),s=this.#qs-1,i=this.#ei[s][e-1];e>0&&(i.letter.destroy(),i.letter=null,this.#Qs=this.#Qs.slice(0,-1)),!1===t.disabled&&(t.disabled=!0)};#_i=()=>{const e=this.#Qs,t=document.getElementById("confirm");if(this.#yi(e)){this.#ni=!0;const s=this.#Si(e);s.sort(),this.#Ci(s).then((()=>{this.#ni=!1,e===this.#ti?(this.#si=!0,setTimeout((()=>this.#Mi()),500),this.#bi()):(this.#Ri(),t.disabled=!0)}))}else alert("Введите английское существительное!")};#mi=e=>{const t=e.key;if(this.#si||this.#ii||this.#ni)return!1;switch(t){case"q":case"w":case"e":case"r":case"t":case"y":case"u":case"i":case"o":case"p":case"a":case"s":case"d":case"f":case"g":case"h":case"j":case"k":case"l":case"z":case"x":case"c":case"v":case"b":case"n":case"m":this.#gi(t);break;case"Backspace":this.#fi();break;case"Enter":console.log("confirm"),this.#_i()}};#Pi=e=>{const t=e.length;return e[Math.floor(Math.random()*t)]};#Ci=async e=>{for(let t=0;t<e.length;t++){const s=e[t];await this.#Oi(s)}return Promise.resolve()};#Oi=async e=>new Promise(((t,s)=>{const i=e.color,n=e.card,r=e.letter,a=setInterval((()=>{if(n.rotation>=Math.PI&&(clearInterval(a),t()),n.rotation>=Math.PI/2)switch(r.rotateClockWise(),i){case"yellow":r.fillStyle="rgba(0, 0, 0, 1)",n.bgColor="rgba(253, 208, 53, 1)";break;case"light-grey":r.fillStyle="rgba(0, 0, 0, 1)",n.bgColor="rgba(211, 211, 211, 1)";break;case"dark-grey":n.bgColor="rgba(51, 51, 51, 1)"}else r.rotateAnticlockwise();n.rotate()}))}));#Ei=()=>{console.log("switch screen"),document.getElementById("first_screen").style.display="none",document.getElementById("second_screen").style.display="block"};#xi=(e=!0)=>{const t=this.systemSettings.customSettings.yandex_api_key;fetch("https://dictionary.yandex.net/api/v1/dicservice.json/lookup?key="+t+"&lang=en-ru&text="+this.#ti).then((e=>e.json())).then((t=>{console.log(t);const s=t.def.find((e=>"noun"===e.pos)),i=s?s.tr:null;let n="";i&&i.forEach(((e,t)=>{n+=e.text+(t!==i.length-1?", ":".")})),e&&this.#Bi("<h3>Вы проиграли!!!</h3><p>Загаданное слово: </p><p><b>"+this.#ti+(i?"</b> - "+n+"</p>":""))})),this.#ii=!0,this.#bi()};#Mi=()=>{const e=this.systemSettings.customSettings.yandex_api_key;fetch("https://dictionary.yandex.net/api/v1/dicservice.json/lookup?key="+e+"&lang=en-ru&text="+this.#ti).then((e=>e.json())).then((e=>{const t=e.def.find((e=>"noun"===e.pos)),s=t?t.tr:null;let i="";s&&s.forEach(((e,t)=>{i+=e.text+(t!==s.length-1?", ":".")})),this.#Bi("<h3>Вы победили!!!</h3><p><b>"+this.#ti+(s?"</b> - "+i+"</p>":""))}))};#Bi=e=>{const t=document.getElementById("popup"),s=document.getElementById("game");document.getElementById("message").innerHTML=e,document.getElementById("overlay").style.display="block",t.style.left=s.offsetLeft+"px",t.style.display="block",window.innerWidth-60>t.offsetWidth&&(t.style.left=window.innerWidth/2-t.offsetWidth/2+"px"),t.style.top=window.innerHeight/2-t.offsetHeight/2+"px"};#Li=()=>{document.getElementById("popup").style.display="none",document.getElementById("overlay").style.display="none"};#pi=()=>{console.log("---\x3e>>start game"),document.getElementById("reset").blur();const e=document.getElementById("contactChoice1"),t=document.getElementById("contactChoice2"),s=document.getElementById("contactChoice4"),i=document.getElementById("confirm");this.#Li(),i.disbled=!0,e.checked?(console.log("set 3"),this.#Zs=3):t.checked?this.#Zs=4:s.checked&&(this.#Zs=6);const n=this.#Zs,r=this.#Hs,a=this.#Xs,o=this.#Js,l=n*r+(n-1)*a,h=o*r+(o-1)*a+this.#Ks;this.#oi=l,this.#li=h,this.systemSettings.canvasMaxSize.width=l,this.systemSettings.canvasMaxSize.height=h,this.iSystem.iRender.fixCanvasSize();const c=this.iLoader.getWords("englishNouns");this.#$s=c.split("\r\n").filter((e=>e.length===n)),this.#vi(),this.#qs=1,this.#Qs="",this.#si=!1,this.#ii=!1,this.#ni=!1,this.#ti=this.#Pi(this.#$s),this.#Ti().then((()=>this.#Ai()))}}const Oe=["u_translation","u_rotation","u_scale","u_resolution","u_fade_min","u_fade_max","u_color"],Be=["a_position"],Le=["u_translation","u_rotation","u_scale","u_resolution","u_image"],De=["a_position","a_texCoord"];H.customSettings={letterNum:5,attempts:6,letterCardSize:70,letterCardSpaces:3,shiftSize:2,yandex_api_key:"dict.1.1.20240616T070649Z.78c07cd3af68b4d6.c71c1cb194341c724097b0e1e1656e2a4b37f81f",words_list_url:"/sites/default/files/words.txt"},H.gameOptions.render.minCycleTime=32,document.addEventListener("DOMContentLoaded",(function(e){console.log("start app to: ",document.getElementById("game"));const t=new we(H,document.getElementById("game"));t.iSystem.iExtension.registerAndCompileWebGlProgram("rotateYProgram","\n    precision mediump float;\n\n    attribute vec4 a_position;\n\n    uniform vec3 u_translation;\n    uniform float u_rotation;\n    uniform vec3 u_scale;\n\n    uniform vec4 u_resolution;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat4 projection = mat4(\n            2.0 / u_resolution.x, 0, 0, 0,\n            0, -2.0 / u_resolution.y, 0, 0,\n            0, 0, 2.0 / u_resolution.z, 0,\n            -1, 1, 0, 1\n        );\n        //mat3 translationMatrix1 = mat3(\n        //    1, 0, 0,\n        //    0, 1, 0,\n        //    u_translation.x, u_translation.y, 1\n        //);\n        mat4 translationMatrix = mat4(\n            1, 0, 0, 0,\n            0, 1, 0, 0,\n            0, 0, 1, 0,\n            u_translation.x,  u_translation.y, u_translation.z, 1\n        );\n        // y-rotation\n        mat4 rotationMatrix = mat4(\n            c, 0, -s, 0,\n            0, 1, 0, 0,\n            s, 0, c, 0,\n            0, 0, 0, 1\n        );\n        //mat3 rotationMatrix = mat3(\n        //    c, s, 0,\n        //    -s, c, 0,\n        //    0, 0, 1\n        //);\n\n        //mat3 scalingMatrix = mat3(\n        //    u_scale.x, 0, 0,\n        //    0, u_scale.y, 0,\n        //    0, 0, 1\n        //);\n        mat4 scalingMatrix = mat4(\n            u_scale.x, 0, 0, 0,\n            0, u_scale.y, 0, 0,\n            0, 0, u_scale.z, 0,\n            0, 0, 0, 1\n        );\n        mat4 matrix = projection * translationMatrix * rotationMatrix * scalingMatrix;\n\n        //vec2 position = (matrix * vec3(a_position, 1)).xy;\n        //vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n        //gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        \n        gl_Position = matrix * a_position;\n    }\n","\n    precision mediump float;\n\n    uniform vec4 u_color;\n    uniform float u_fade_min; \n    uniform float u_fade_max;\n    uniform vec4 u_resolution;\n    uniform vec3 u_translation;\n\n    void main(void) {\n        vec4 p = u_color;\n        if (u_fade_min > 0.0) {\n            vec2 fix_tr = vec2(u_translation.x, u_resolution.y - u_translation.y); \n            float distance = distance(fix_tr.xy, gl_FragCoord.xy);\n            if (u_fade_min <= distance && distance <= u_fade_max) {\n                float percent = ((distance - u_fade_max) / (u_fade_min - u_fade_max)) * 100.0;\n                p.a = u_color.a * (percent / 100.0);\n            }\n        }\n\n        gl_FragColor = p;\n    }\n",Oe,Be),t.iSystem.iExtension.registerDrawObject("rotateYObject",ve),t.iSystem.iExtension.registerObjectRender(Re.name,Ie,"rotateYProgram"),t.iSystem.iExtension.registerAndCompileWebGlProgram("rotateYTextProgram","\n    attribute vec2 a_texCoord;\n\n    attribute vec4 a_position;\n\n    uniform vec3 u_translation;\n    uniform float u_rotation;\n    uniform vec3 u_scale;\n\n    uniform vec4 u_resolution;\n\n    varying vec2 v_texCoord;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat4 projection = mat4(\n            2.0 / u_resolution.x, 0, 0, 0,\n            0, -2.0 / u_resolution.y, 0, 0,\n            0, 0, 2.0 / u_resolution.z, 0,\n            -1, 1, 0, 1\n        );\n        //mat3 translationMatrix1 = mat3(\n        //    1, 0, 0,\n        //    0, 1, 0,\n        //    u_translation.x, u_translation.y, 1\n        //);\n        mat4 translationMatrix = mat4(\n            1, 0, 0, 0,\n            0, 1, 0, 0,\n            0, 0, 1, 0,\n            u_translation.x,  u_translation.y, u_translation.z, 1\n        );\n        // y-rotation\n        mat4 rotationMatrix = mat4(\n            c, 0, -s, 0,\n            0, 1, 0, 0,\n            s, 0, c, 0,\n            0, 0, 0, 1\n        );\n        //mat3 rotationMatrix = mat3(\n        //    c, s, 0,\n        //    -s, c, 0,\n        //    0, 0, 1\n        //);\n\n        //mat3 scalingMatrix = mat3(\n        //    u_scale.x, 0, 0,\n        //    0, u_scale.y, 0,\n        //    0, 0, 1\n        //);\n        mat4 scalingMatrix = mat4(\n            u_scale.x, 0, 0, 0,\n            0, u_scale.y, 0, 0,\n            0, 0, u_scale.z, 0,\n            0, 0, 0, 1\n        );\n        mat4 matrix = projection * translationMatrix * rotationMatrix * scalingMatrix;\n\n        //vec2 position = (matrix * vec3(a_position, 1)).xy;\n        //vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n        //gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        \n        gl_Position = matrix * a_position;\n        \n        v_texCoord = a_texCoord;\n    }","\n    precision mediump float;\n\n    uniform sampler2D u_image;\n\n    //texCoords passed in from the vertex shader\n    varying vec2 v_texCoord;\n    void main() {\n        vec4 color = texture2D(u_image, v_texCoord);\n        gl_FragColor = color;\n    }",Le,De),t.iSystem.iExtension.registerDrawObject("rotateYText",Ce),t.iSystem.iExtension.registerObjectRender(be.name,Me,"rotateYTextProgram"),t.registerStage("WordsGame",Pe),t.preloadAllData().then((()=>{t.iSystem.startGameStage("WordsGame")}))}));