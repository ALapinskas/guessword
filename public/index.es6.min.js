var e,t,s={},i={};function r(e){var t=i[e];if(void 0!==t)return t.exports;var n=i[e]={exports:{}};return s[e](n,n.exports,r),n.exports}r.m=s,r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,s)=>(r.f[s](e,t),t)),[])),r.u=e=>e+".index.es6.min.js",r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="guessword:",r.l=(s,i,n,a)=>{if(e[s])e[s].push(i);else{var o,l;if(void 0!==n)for(var h=document.getElementsByTagName("script"),c=0;c<h.length;c++){var d=h[c];if(d.getAttribute("src")==s||d.getAttribute("data-webpack")==t+n){o=d;break}}o||(l=!0,(o=document.createElement("script")).type="module",o.charset="utf-8",o.timeout=120,r.nc&&o.setAttribute("nonce",r.nc),o.setAttribute("data-webpack",t+n),o.src=s),e[s]=[i];var u=(t,i)=>{o.onerror=o.onload=null,clearTimeout(g);var r=e[s];if(delete e[s],o.parentNode&&o.parentNode.removeChild(o),r&&r.forEach((e=>e(i))),t)return t(i)},g=setTimeout(u.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=u.bind(null,o.onerror),o.onload=u.bind(null,o.onload),l&&document.head.appendChild(o)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;if("string"==typeof import.meta.url&&(e=import.meta.url),!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{var e={792:0};r.f.j=(t,s)=>{var i=r.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else{var n=new Promise(((s,r)=>i=e[t]=[s,r]));s.push(i[2]=n);var a=r.p+r.u(t),o=new Error;r.l(a,(s=>{if(r.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var n=s&&("load"===s.type?"missing":s.type),a=s&&s.target&&s.target.src;o.message="Loading chunk "+t+" failed.\n("+n+": "+a+")",o.name="ChunkLoadError",o.type=n,o.request=a,i[1](o)}}),"chunk-"+t,t)}};var t=(t,s)=>{var i,n,[a,o,l]=s,h=0;if(a.some((t=>0!==e[t]))){for(i in o)r.o(o,i)&&(r.m[i]=o[i]);l&&l(r)}for(t&&t(s);h<a.length;h++)n=a[h],r.o(e,n)&&e[n]&&e[n][0](),e[n]=0},s=self.webpackChunkguessword=self.webpackChunkguessword||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();const n={MODE:{DEBUG:"DEBUG",PRODUCTION:"PRODUCTION"},SCREENS:{},AUDIO:{},CONNECTION_STATUS:{DISCONNECTED:"disconnected",CONNECTED:"connected",CONNECTION_LOST:"connection lost"},EVENTS:{SYSTEM:{START_PAGE:"START_PAGE",STOP_PAGE:"STOP_PAGE",RENDER:{START:"start",END:"end"}},GAME:{BOUNDARIES_COLLISION:"BOUNDARIES_COLLISION",OBJECTS_COLLISION:"OBJECTS_COLLISION"},WEBSOCKET:{SERVER_CLIENT:{CONNECTION_STATUS_CHANGED:"CONNECTION_STATUS_CHANGED",ROOMS_INFO:"roomsInfo",CREATED:"created",JOINED:"joined",FULL:"full",DISCONNECTED:"disconnected",SERVER_MESSAGE:"message",RESTARTED:"restarted"},CLIENT_SERVER:{ROOMS_INFO_REQUEST:"gatherRoomsInfo",CREATE_OR_JOIN:"create or join",RESTART_REQUEST:"restart",CLIENT_MESSAGE:"message"}}},WEBGL:{DRAW_PROGRAMS:{PRIMITIVES:"drawPrimitives",IMAGES:"drawImages",IMAGES_M:"drawImagesMerge"}},DRAW_TYPE:{RECTANGLE:"rect",CONUS:"conus",CIRCLE:"circle",POLYGON:"polygon",LINE:"line",TEXT:"text",IMAGE:"image"},LAYERS:{DEFAULT:"default-view-layer",BOUNDARIES:"boundaries-view-layer"},GAME_OPTIONS:{},LIBRARY:{WEBGL:"webgl"},OPTIMIZATION:{CYCLE_TIME_CALC:{AVERAGES:"AVERAGES",CURRENT:"CURRENT"},NATIVE_JS:{NOT_OPTIMIZED:"NOT_OPTIMIZED",OPTIMIZED:"OPTIMIZED"},WEB_ASSEMBLY:{ASSEMBLY_SCRIPT:"ASSEMBLY_SCRIPT",NATIVE_WAT:"WASM"}}},a={CREATE_INSTANCE_ERROR:"CREATE_INSTANCE_ERROR",STAGE_NOT_EXIST:"STAGE_NOT_EXIST",ELEMENT_NOT_EXIST:"ELEMENT_NOT_EXIST",FILE_NOT_EXIST:"FILE_NOT_EXIST",CANT_GET_THE_IMAGE:"CANT_GET_THE_IMAGE",UNEXPECTED_INPUT_PARAMS:"UNEXPECTED_INPUT_PARAMS",UNHANDLED_EXCEPTION:"UNHANDLED_EXCEPTION",CANVAS_KEY_NOT_SPECIFIED:"CANVAS_KEY_NOT_SPECIFIED",CANVAS_WITH_KEY_NOT_EXIST:"CANVAS_WITH_KEY_NOT_EXIST",WRONG_TYPE_ERROR:"WRONG_TYPE_ERROR",UNEXPECTED_WS_MESSAGE:"UNEXPECTED_WS_MESSAGE",UNEXPECTED_PLAYER_ID:"UNEXPECTED_PLAYER_ID",UNEXPECTED_BULLET_ID:"UNEXPECTED_BULLET_ID",UNEXPECTED_EVENT_NAME:"UNEXPECTED_EVENT_NAME",WEBGL_ERROR:"WEBGL_ERROR",DRAW_PREPARE_ERROR:"DRAW_PREPARE_ERROR",ANOTHER_STAGE_ACTIVE:"ANOTHER_STAGE_ACTIVE",UNEXPECTED_TILE_ID:"UNEXPECTED_TILE_ID",UNEXPECTED_TOUCH_AREA:"UNEXPECTED TOUCH AREA",UNEXPECTED_METHOD_TYPE:"UNEXPECTED METHOD TYPE"},o="NOT_FOUND",l="WORLD_DIMENSIONS_NOT_SET",h="UNHANDLED_DRAW_ISSUE",c="AUDIO_NOT_REGISTERED",d="AUDIO_NOT_LOADED",u="POLYGON_VERTICES_NOT_CORRECT";function g(e,t){throw new Error(e+": "+t)}function m(e,t){console.warn(e,t)}class E{#e;#t=100;#s;#i;#r;#n;#a;constructor(e,t,s=!1,i,r=!1){this.#e=e,this.#s=this.#o(t),this.#i=i||0,this.#r=r,this.#n=s}get name(){return this.#e}get isActive(){return this.#r}get currentSprite(){return this.#s[this.#i][0]}get _isLastSprite(){return this.#s.length-1===this.#i}iterateAnimationIndex(){const e=this.#i;this.#s[e][1]<Date.now()-this.#a&&(this._isLastSprite?this.#n?this.#i=0:this.deactivateAnimation():this.#i++,this.#a=Date.now())}activateAnimation=()=>{this.#r=!0,this.#i=0,this.#a=Date.now()};deactivateAnimation=()=>{this.#r=!1};#o(e){let t=[];return e.forEach((e=>{"number"==typeof e.id&&"number"==typeof e.duration?t.push([e.id,e.duration]):t.push([e,this.#t])})),t}}class f{#l;#h;#c;#d;#u;#g=0;#m=0;#E=function(){return Math.round(1e6*Math.random())}();#f=!1;#_;#p;#T=!1;#x=!1;constructor(e,t,s,i){this.#l=t,this.#h=s,this.#c=i,this.#d=e}get bgColor(){return this.#c}set bgColor(e){this.#c=e}get type(){return this.#d}get x(){return this.#l}get y(){return this.#h}set x(e){this.#l=e}set y(e){this.#h=e}get sortIndex(){return this.#g}set sortIndex(e){this.#g=e}get blendFunc(){return this.#u}set blendFunc(e){this.#u=e}get rotation(){return this.#m}set rotation(e){this.#m=e}get id(){return this.#E}get isRemoved(){return this.#f}destroy(){this.#f=!0}get isMaskAttached(){return!!this.#_}get _maskId(){return this.#_}setMask(e){e._isMask=!0,this.#_=e.id}removeMask(){this.#_=null}set _isMask(e){this.#p=e}get _isMask(){return this.#p}get isOffsetTurnedOff(){return this.#T}turnOffOffset(){this.#T=!0}_calculateRectVertices=(e,t)=>{const s=e/2,i=t/2;return[[-s,-i],[s,-i],[s,i],[-s,i]]};_interpolateConus(e,t=2*Math.PI,s=Math.PI/14){let i=[0,0];for(let r=0;r<=t;r+=s){let t=Math.cos(r)*e,s=Math.sin(r)*e;i.push(t,s)}return i}_calculateConusBoundaries(e,t=2*Math.PI,s=Math.PI/14){let i=[];for(let r=0;r<=t;r+=s){let t=Math.cos(r)*e,s=Math.sin(r)*e;i.push([t,s])}return i}_convertVerticesArray(e){return void 0!==e[0].x&&void 0!==e[0].y?function(e){const t=e.length,s=[];for(let i=0;i<t;i++){const t=e[i];s.push([t.x,t.y])}return s}(e):e}}class _{#A;#R;#S;#b=0;#y=0;#w=0;constructor(e,t){this._initiateStorageData(e,t)}get cells(){return this.#y}get vectors(){return this.#A}get textures(){return this.#R}get _bTempIndexes(){return this.#S}get bufferSize(){return this.#b}_initiateStorageData(e,t){this.#y=e,this.#w=t||e,this.#w>e&&(this.#w=e),this.#b=12*this.#w,this.#A=new Array(this.#b),this.#R=new Array(this.#b),this.#S=new Int32Array(4*this.#y)}}class p{#v;#I;#C;#O;#P="-#-";#M;#D;#B;#L;#N;#_;#g=0;#W=new Map;#T;constructor(e,t,s,i,r,n,a=!1,o){this.#v=e,this.#I=t,this.#C=s,this.#O=i,this.#D=[],this.#M=r,this.#B=n,this.#L=a,this.#N=a||!1,o&&this.setMask(o),this.#G(i,n)}get layerKey(){return this.#v}get tileMapKey(){return this.#I}get tilemap(){return this.#C}get tilesets(){return this.#O}get tilesetImages(){return this.#M}get layerData(){return this.#B}get setBoundaries(){return this.#L}get drawBoundaries(){return this.#N}set drawBoundaries(e){this.#N=e}get _maskId(){return this.#_}setMask(e){e._isMask=!0,this.#_=e.id}removeMask(){this.#_=null}get sortIndex(){return this.#g}set sortIndex(e){this.#g=e}get isOffsetTurnedOff(){return this.#T}turnOffOffset(){this.#T=!0}get hasAnimations(){return this.#W.size>0}get _textureStorages(){return this.#D}_setTextureStorage(e,t){this.#D[e]=t}#G(e,t){let s=0,i=0,r=0;e.forEach(((e,n)=>{const a=e.data.tiles,o=e.data.name,l=e.firstgid,h=this.tilesets[n+1],c=h?h.firstgid:1e9;if(a)for(let n of a){const a=n.animation,h=n.objectgroup,c=n.id;if(a){const t=o+this.#P+c,s=this.#k(a),i=new E(t,s,!0);this.#W.set(t,i),e.data._hasAnimations||(e.data._hasAnimations=!0,e.data._animations=new Map,e.data._animations.set(c,s[0][0])),this.#F(i)}h&&this.#L&&(e.data._hasBoundaries||(e.data._hasBoundaries=!0,e.data._boundaries=new Map),e.data._boundaries.set(c,h),h.objects.forEach((e=>{if(e.ellipse){const e=t.data.filter((e=>e===c+l)).length;s+=4*e}else if(e.point){const e=t.data.filter((e=>e===c+l)).length;i+=2*e}else if(e.polygon){const s=t.data.filter((e=>e===c+l)).length;r+=2*e.polygon.length*s}else{const e=t.data.filter((e=>e===c+l)).length;r+=16*e}})))}const d=t.data.filter((e=>e>=l&&e<c)).length,u=t.data.length;this.#L&&(r+=16*d),e._temp=new _(u,d)})),t.ellipseBoundariesLen=s,t.pointBoundariesLen=i,t.polygonBoundariesLen=r}#k(e){return e.map((e=>({duration:e.duration,id:e.tileid})))}_processActiveAnimations(){for(let e of this.#W.values())e.isActive&&(e.iterateAnimationIndex(),this.#j(e))}#F=e=>{e.activateAnimation(),this.#j(e)};#j=e=>{const[t,s]=e.name.split(this.#P),i=this.#O.findIndex((e=>e.data.name===t));this.#O[i].data._animations.set(parseInt(s),e.currentSprite)};stopRepeatedAnimation(e){this.#W.get(e).deactivateAnimation()}removeAllAnimations(){for(let[e,t]of this.#W.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#W.clear(),this.#W=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class T extends f{#U;#Y;#V;#z;#X;#W;#H;#K;#Z=0;#J=0;#q;#Q;#$;constructor(e,t,s,i,r,a=0,o,l,h=0,c=0){super(n.DRAW_TYPE.IMAGE,e,t),this.#V=r,this.#X=new EventTarget,this.#W=new Map,this.image=l,this.#K=a,this.#Z=h,this.#J=c,this.#U=s,this.#Y=i,this.#q=o&&!o.r?this._convertVerticesArray(o):o&&o.r?this._calculateConusBoundaries(o.r):this._calculateRectVertices(s,i),this.#Q=o&&void 0!==o.r?o:null}get width(){return this.#U}get height(){return this.#Y}set width(e){this.#U=e}set height(e){this.#Y=e}get key(){return this.#V}get image(){return this.#z}set image(e){this.#$&&(this.#$._isTextureRecalculated=!0),this.#z=e}get imageIndex(){return this.#K}set imageIndex(e){this.#K=e}get spacing(){return this.#Z}get margin(){return this.#J}get hasAnimations(){return this.#W.size>0}get activeAnimation(){return this.#H}get boundaries(){return this.#q}get vertices(){return this.#q}get circleBoundaries(){return this.#Q}_processActiveAnimations(){const e=this.#H;if(e){const t=this.#W.get(e);t.iterateAnimationIndex(),this.#K=t.currentSprite}}get _textureStorage(){return this.#$}set _textureStorage(e){this.#$=e}emit(e,...t){const s=new Event(e);s.data=[...t],this.#X.dispatchEvent(s)}addEventListener(e,t,s){this.#X.addEventListener(e,t,s)}removeEventListener(e,t,s){this.#X.removeEventListener(e,t,s)}addAnimation(e,t,s){this.#ee(t)||g(a.UNEXPECTED_INPUT_PARAMS," animationSpriteIndexes should be Array of indexes, or Array of objects {duration:number, id:number}");const i=new E(e,t,s);this.#W.set(e,i),this.addEventListener(e,this.#F)}#ee(e){let t=!0;return e.forEach((e=>{"number"!=typeof e&&("number"==typeof e.duration&&"number"==typeof e.id||(t=!1))})),t}#F=e=>{const t=e.type,s=this.#W.get(t);this.#H&&this.#H!==t&&this.stopRepeatedAnimation(this.#H),s.activateAnimation(),this.#H=t,this.#K=s.currentSprite};stopRepeatedAnimation(e){this.#W.get(e).deactivateAnimation(),this.#H=null}removeAllAnimations(){for(let[e,t]of this.#W.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#W.clear(),this.#W=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class x extends f{#te;#q;constructor(e,t,s,i){super(n.DRAW_TYPE.CIRCLE,e,t,i),this.#te=s,this.#q=this._interpolateConus(s)}get vertices(){return this.#q}set vertices(e){this.#q=e}get radius(){return this.#te}}class A extends f{#te;#se;#q;#ie;constructor(e,t,s,i,r,a=0){super(n.DRAW_TYPE.CONUS,e,t,i),this.#te=s,this.#se=r,this.#ie=a,this.#q=this._interpolateConus(s,r)}get vertices(){return this.#q}set vertices(e){this.#q=e}get radius(){return this.#te}get angle(){return this.#se}get fade_min(){return this.#ie}set fade_min(e){this.#ie=e}}class R extends f{#q;constructor(e,t){super(n.DRAW_TYPE.LINE,e[0][0],e[0][1],t),this.#q=e}get vertices(){return this.#q}set vertices(e){this.#q=e}}class S extends f{#q;constructor(e,t){super(n.DRAW_TYPE.POLYGON,e[0].x,e[0].y,t),this.#q=this._convertVerticesArray(e)}get vertices(){return this.#q}set vertices(e){this.#q=e}}class b extends f{#U;#Y;#q;constructor(e,t,s,i,r){super(n.DRAW_TYPE.RECTANGLE,e,t,r),this.#U=s,this.#Y=i,this.#q=this._calculateRectVertices(s,i)}get vertices(){return this.#q}get width(){return this.#U}get height(){return this.#Y}set width(e){this.#U=e}set height(e){this.#Y=e}}class y{#l;#h;#U;#Y;constructor(e,t,s,i){this.#l=e,this.#h=t,this.#U=s,this.#Y=i}get x(){return this.#l}get y(){return this.#h}get width(){return this.#U}get height(){return this.#Y}}class w{#l;#h;constructor(e,t,s,i){this.#l=s-e,this.#h=i-t}get x(){return this.#l}get y(){return this.#h}get length(){return Math.sqrt(Math.pow(this.#l,2)+Math.pow(this.#h,2))}get tetaAngle(){return Math.atan2(this.#h,this.#l)}}class v extends f{#re;#ne;#ae;#oe;#le;#he;#ce;#de=document.createElement("canvas");#$;constructor(e,t,s,i,r){super(n.DRAW_TYPE.TEXT,e,t),this.#he=s,this.#re=i,this.#oe=r,this.#ce,this.#ue()}get boundariesBox(){const e=this.textMetrics?Math.floor(this.textMetrics.width):300,t=this.textMetrics?Math.floor(this.textMetrics.fontBoundingBoxAscent+this.textMetrics.fontBoundingBoxDescent):30;return new y(this.x,this.y-t,e,t)}get vertices(){const e=this.boundariesBox;return this._calculateRectVertices(e.width,e.height)}get text(){return this.#he}set text(e){e!==this.#he&&(this.#he=e,this.#ue())}get font(){return this.#re}set font(e){e!==this.#re&&(this.#re=e,this.#ue())}get textAlign(){return this.#ne}set textAlign(e){e!==this.#ne&&(this.#ne=e,this.#ue())}get textBaseline(){return this.#ae}set textBaseline(e){e!==this.#ae&&(this.#ae=e,this.#ue())}get fillStyle(){return this.#oe}set fillStyle(e){e!==this.#oe&&(this.#oe=e,this.#ue())}get strokeStyle(){return this.#le}set strokeStyle(e){e!==this.#le&&(this.#le=e,this.#ue())}get textMetrics(){return this.#ce}set _textMetrics(e){this.#ce=e}get _textureStorage(){return this.#$}set _textureStorage(e){this.#$=e}get _textureCanvas(){return this.#de}#ue(){const e=this.#de.getContext("2d",{willReadFrequently:!0});if(e){e.font=this.font,this._textMetrics=e.measureText(this.text);const t=this.boundariesBox.width,s=this.boundariesBox.height;e.canvas.width=t,e.canvas.height=s,e.clearRect(0,0,t,s),e.font=this.font,e.textBaseline="bottom",this.fillStyle&&(e.fillStyle=this.fillStyle,e.fillText(this.text,0,s)),this.strokeStyle&&(e.strokeStyle=this.strokeStyle,e.strokeText(this.text,0,s)),this.#$&&(this.#$._isTextureRecalculated=!0)}else g(a.UNHANDLED_EXCEPTION,"can't getContext('2d')")}}class I{#ge;#me;#Ee;#fe;#_e=0;#pe=0;#Te=0;#xe=0;#Ae=0;#Re=0;#Se=0;#be=0;#ye=0;#we=0;#ve=0;#Ie;#Ce;#Oe;#Pe;#Me=[];#De=[];#T;#Be=!1;#Le=[];#Ne=!1;constructor(e){}isOffsetTurnedOff(){return this.#T}set mapRotate(e){this.#Ae=e}#We(e){this._addBoundaryLine(e.x1,e.y1,e.x2,e.y2)}_addImageDebugBoundaries(e){const t=e.length;for(let s=0;s<t;s++)this.#Le.push(...e[s])}_enableDebugObjectBoundaries(){this.#Ne=!0}_addBoundariesArray(e){const t=e.length;for(let s=0;s<t;s++){const t=e[s];this._addBoundaryLine(t[0],t[1],t[2],t[3])}}_addBoundaryLine(e,t,s,i){this.#Ie[this.#ye]=e,this.#ye++,this.#Ie[this.#ye]=t,this.#ye++,this.#Ie[this.#ye]=s,this.#ye++,this.#Ie[this.#ye]=i,this.#ye++}_addEllipseBoundary(e,t,s,i){this.#Ce[this.#ve]=e,this.#ve++,this.#Ce[this.#ve]=t,this.#ve++,this.#Ce[this.#ve]=s,this.#ve++,this.#Ce[this.#ve]=i,this.#ve++}_addPointBoundary(e,t){this.#Oe[this.#we]=e,this.#we++,this.#Oe[this.#we]=t,this.#we++}_removeBoundaryLine(e){this.#Ie[e]=0,this.#Ie[e+1]=0,this.#Ie[e+2]=0,this.#Ie[e+3]=0}_clearBoundaries(){this.#Ie.fill(0),this.#Ce.fill(0),this.#Oe.fill(0),this.#ye=0,this.#ve=0,this.#we=0,this.#Ne&&(this.#Le=[])}_initiateBoundariesData(){this.#Ie=new Float32Array(this.#Re),this.#Ce=new Float32Array(this.#Se),this.#Oe=new Float32Array(this.#be)}_setMaxBoundariesSize(e,t=0,s=0){this.#Re=e,this.#Se=t,this.#be=s}_setWorldDimensions(e,t){this.#ge=e,this.#me=t}_setCanvasDimensions(e,t){this.#Ee=e,this.#fe=t}_setMapBoundaries(){const[e,t]=[this.#ge,this.#me],[s,i]=[this.#_e,this.#pe],r=e-s,n=t-i;e&&t||m(l,"Can't set map boundaries."),this.#We({x1:0,y1:0,x2:r,y2:0}),this.#We({x1:r,y1:0,x2:r,y2:n}),this.#We({x1:r,y1:n,x2:0,y2:n}),this.#We({x1:0,y1:n,x2:0,y2:0})}_setWholeWorldMapBoundaries(){const[e,t]=[this.#ge,this.#me];e&&t||m(l,"Can't set map boundaries."),this.#Pe.push([0,0,e,0]),this.#Pe.push([e,0,e,t]),this.#Pe.push([e,t,0,t]),this.#Pe.push([0,t,0,0])}_mergeBoundaries(e=!1){const t=e?this.getWholeWorldBoundaries():this.getBoundaries(),s=new Set(t);for(const e of s.values()){const t=e[0],i=e[1],r=e[2],n=e[3];for(const a of s.values()){const o=a[0],l=a[1],h=a[2],c=a[3];t===h&&i===c&&r===o&&n===l&&(s.delete(e),s.delete(a)),r!==o||n!==l||t!==h&&i!==c||(a[0]=t,a[1]=i,s.delete(e))}}e?this.#Ie=Array.from(s):this.#Pe=Array.from(s),s.clear()}_setWholeMapBoundaries(e){this.#Pe.push(...e)}_enableMapBoundaries(){this.#Be=!0}getBoundaries(){const e=this.#Ie,t=this.#ye;let s=[],i=[];for(let r=0;r<t;r++){const t=e[r];s.push(t),(r+1)%4==0&&(i.push(s),s=[])}return i}getRawBoundaries(){return this.#Ie}getEllipseBoundaries(){return this.#Ce}getPointBoundaries(){return this.#Oe}getWholeWorldBoundaries(){return this.#Pe}getDebugObjectBoundaries(){return this.#Le}get isWorldBoundariesEnabled(){return this.#Be}get canvasDimensions(){return[this.#Ee,this.#fe]}get worldDimensions(){return[this.#ge,this.#me]}get worldOffset(){return[this.#_e,this.#pe]}get mapCenter(){return[this.#Te,this.#xe]}get mapRotate(){return this.#Ae}get boundariesLen(){return this.#ye}get ellipseBLen(){return this.#ve}get pointBLen(){return this.#we}centerCameraPosition=(e,t)=>{let[s,i]=this.worldOffset;const[r,n]=this.canvasDimensions,[a,o]=this.worldDimensions,l=r/2,h=n/2,c=h-i;if(l-s<e)if(e<a-l){const t=e-l;t>=0&&(this.#_e=Math.round(t))}else if(a>r){const e=a-r;this.#_e=Math.round(e)}if(c<t)if(t<o-h){const e=t-h;e>=0&&(this.#pe=Math.round(e))}else if(o>n){const e=o-n;this.#pe=Math.round(e)}this.#Te=e,this.#xe=t};personRotatedCenterCamera=(e,t,s)=>{console.log("new centering algorithm")};get renderObjects(){return this.#Me}getObjectsByInstance(e){return this.#Me.filter((t=>t instanceof e))}_sortRenderObjectsBySortIndex(){this.#Me.sort(((e,t)=>e.sortIndex-t.sortIndex))}_processPendingRenderObjects(){this.#De.length>0&&(this.#Me.push(...this.#De),this._sortRenderObjectsBySortIndex(),this.#De=[])}set _renderObject(e){this.#De.push(e)}set _renderObjects(e){e.forEach((e=>{this._renderObject=e}))}}const C={loadstart:"loadstart",progress:"progress",abort:"abort",error:"error",load:"load",timeout:"timeout"},O=" loader is not registered.",P="Too much recursion. Stop iteration.",M="uploadMethod should be instance of Promise and return upload result value",D=" AtlasXML file extension is incorrect, only .xml file supported",B=" tileset file extension is not correct, only .tsj or .json files are supported",L=" tilemap file extension is not correct, only .tmj or .json files are supported",N=" fileKey and url should be provided";class W{#Ge;#ke;#Fe=new Map;#je=new Map;constructor(e,t){this.#Ge=e,this.#ke=(e,s,...i)=>{const r=t(e,s,...i);if(r instanceof Promise)return r.then((t=>this.#Ue(t,e)));throw new TypeError(M)}}#Ue=(e,t)=>new Promise(((s,i)=>{e||null===e||F("AssetsManager: uploadMethod for "+this.#Ge+" returns incorrect value"),this.#Ye(t,e),this.#Ve(t),s()}));#Ye(e,t){this.#je.set(e,t)}#Ve(e){this.#Fe.delete(e)}get filesWaitingForUpload(){return this.#Fe.size}get loadingQueue(){return this.#Fe}get uploadMethod(){return this.#ke}_addFile=(e,t)=>{this.#Fe.has(e)&&F("AssetsManager: File "+this.#Ge+" with key "+e+" is already added"),this.#Fe.set(e,t)};_isFileInQueue=e=>this.#Fe.has(e);_getFile=e=>this.#je.get(e)}class G{#ze=5;#Xe=new EventTarget;#He=new Map;#Ke=0;constructor(){this.registerLoader("Audio",this._loadAudio),this.registerLoader("Image",this._loadImage),this.registerLoader("TileMap",this._loadTileMap),this.registerLoader("TileSet",this._loadTileSet),this.registerLoader("AtlasImageMap",this._loadAtlasImage),this.registerLoader("AtlasXML",this._loadAtlasXml)}get filesWaitingForUpload(){let e=0;return Array.from(this.#He.values()).map((t=>e+=t.filesWaitingForUpload)),e}registerLoader=(e,t=this._defaultUploadMethod)=>{this["add"+e]=(t,s,...i)=>{this.addFile(e,t,s,...i)},this["get"+e]=t=>this.getFile(e,t),this["is"+e+["InQueue"]]=t=>this.isFileInQueue(e,t);const s=this.#He.get(e)||new W(e,t);this.#He.set(e,s)};preload(){return this.#Y(),new Promise((async(e,t)=>{this.#Ze().then((()=>{this.#Je(),e()})).catch((e=>{t(e)}))}))}#Ze(e=0){return this.#qe().then((t=>{if(0===this.filesWaitingForUpload)return Promise.resolve(t);if(++e>this.#ze){const e=new Error(P);return this.#Qe(e),Promise.reject(new Error(P))}return this.#Ze(e)}))}#qe(){return new Promise(((e,t)=>{let s=[];Array.from(this.#He.values()).forEach((e=>{Array.from(e.loadingQueue.entries()).forEach((t=>{const i=new Promise(((s,i)=>e.uploadMethod(t[0],...t[1]).then((e=>s(e)))));s.push(i)}))})),Promise.allSettled(s).then((s=>{for(const i of s){if("rejected"===i.status){const e=i.reason;this.#$e(e)?t(e):(F("AssetsManager: "+e.message),this.#Qe(e))}e(s)}}))}))}addEventListener(e,t,...s){C[e]?this.#Xe.addEventListener(e,t,...s):F("AssetsManager: Event type should be one of the ProgressEvent.type")}removeEventListener(e,t,...s){this.#Xe.removeEventListener(e,t,...s)}_loadAtlasXml=(e,t)=>(this.#et(t),fetch(t).then((e=>e.text())).then((e=>(new window.DOMParser).parseFromString(e,"text/xml"))).then((s=>{const i=s.documentElement||s.activeElement,r=i.attributes.getNamedItem("imagePath"),n=i.children;if(r){const s=this.#tt(t);return this.addAtlasImageMap(e,s+r.value,n,s),Promise.resolve(i)}{const t=new Error(e+" XML format is not correct.");return this.#Qe(t),Promise.resolve(t)}})));_loadAtlasImage=(e,t,s,i="anonymous")=>new Promise(((e,r)=>{const n=new Image,a=new Map,o=document.createElement("canvas"),l=o.getContext("2d");n.crossOrigin=i,n.onload=()=>{const t=[];let i=[];o.width=n.width,o.height=n.height,l.drawImage(n,0,0);for(let e of s){const s=e.attributes,r=s.getNamedItem("name").value,n=r.includes(".")?r.split(".")[0]:r,a=s.getNamedItem("x").value,o=s.getNamedItem("y").value,h=s.getNamedItem("width").value,c=s.getNamedItem("height").value;t.push(createImageBitmap(l.getImageData(a,o,h,c),{premultiplyAlpha:"premultiply"})),i.push(n)}this.#st(),Promise.all(t).then((t=>{t.forEach(((e,t)=>{const s=i[t];a.set(s,e),this.addImage(s,"empty url",e)})),o.remove(),e(a)}))},n.onerror=()=>{const s=new Error("Error loading atlas image "+t);this.#Qe(s),e(null)},n.src=t}));_loadTileSet=(e,t,s=1,i)=>(this.#it(t),fetch(i?i+t:t).then((e=>e.json())).then((e=>{const{name:t,image:r,spacing:n,margin:a,tilewidth:o,tileheight:l}=e;return t&&r&&!this.isFileInQueue("Image",t)&&this.addImage(t,i?i+r:r),e.gid=s,Promise.resolve(e)})).catch((()=>{const e=new Error("Error loading related tileset "+t);return this.#Qe(e),Promise.resolve(null)})));_defaultUploadMethod=(e,t)=>fetch(t);_loadTileMap=(e,t,s=!0)=>(this.#rt(t),fetch(t).then((e=>e.json())).then((e=>{const i=this.#tt(t);if(!0===s&&e.tilesets&&e.tilesets.length>0){const t=[];return e.tilesets.forEach(((e,s)=>{const{firstgid:r,source:n}=e,a=this._loadTileSet("default-"+r,n,r,i).then((e=>(this.#st(),Promise.resolve(e))));t.push(a)})),Promise.all(t).then((t=>{for(let s=0;s<t.length;s++){const i=t[s];e.tilesets[s].data=i}return Promise.resolve(e)}))}return Promise.resolve(e)})).catch((e=>(e.message.includes("JSON.parse:")&&(e=new Error("Error loading tilemap "+t)),this.#Qe(e),Promise.resolve(null)))));_loadAudio=(e,t)=>new Promise((e=>{const s=new Audio(t);s.addEventListener("loadeddata",(()=>{this.#st(),e(s)})),s.addEventListener("error",(()=>{const s=new Error("Error loading audio "+t);this.#Qe(s),e(null)}))}));_loadImage=(e,t,s,i="anonymous")=>new Promise(((e,r)=>{if(s)e(s);else{const s=new Image;s.crossOrigin=i,s.onload=()=>{createImageBitmap(s,{premultiplyAlpha:"premultiply"}).then((t=>{this.#st(),e(t)}))},s.onerror=()=>{const s=new Error("Error loading image "+t);this.#Qe(s),e(null)},s.src=t}}));#et(e){e.includes(".xml")||k(e+D)}#it(e){e.includes(".tsj")||e.includes(".json")||k(e+B)}#rt(e){e.includes(".tmj")||e.includes(".json")||k(e+L)}#$e(e){return e.message.includes(M)||e.message.includes(D)||e.message.includes(B)||e.message.includes(L)||e.message.includes(N)||e.message.includes(O)}#tt(e){let t=e.split("/"),s=t.length,i="/";return t[s-1].includes(".tmj")||t[s-1].includes(".xml")||t[s-1].includes(".json")?(t.pop(),i=t.join("/")+"/"):(t[s-2].includes(".tmj")||t[s-2].includes(".xml")||t[s-2].includes(".json"))&&(t.splice(s-2,2),i=t.join("/")+"/"),i}addFile(e,t,s,...i){const r=this.#He.get(e);r?(this.#nt(t,s,e),r._addFile(t,[s,...i])):k(e+O)}isFileInQueue(e,t){const s=this.#He.get(e);if(s)return s._isFileInQueue(t);k("Loader for "+e+" is not registered!")}getFile(e,t){const s=this.#He.get(e);if(s)return s._getFile(t);k("Loader for "+e+" is not registered!")}#nt(e,t,s){const i=N;e&&0!==e.trim().length||k("add"+s+"()"+i),t&&0!==t.trim().length||k("add"+s+"()"+i)}#Y(){let e=this.filesWaitingForUpload;this.#Xe.dispatchEvent(new ProgressEvent(C.loadstart,{total:e}))}#Je(){this.#Xe.dispatchEvent(new ProgressEvent(C.load))}#st(){const e=this.filesWaitingForUpload;this.#Ke+=1,this.#Xe.dispatchEvent(new ProgressEvent(C.progress,{lengthComputable:!0,loaded:this.#Ke,total:e}))}#Qe(e){F("AssetsManger: "+e.message),this.#Xe.dispatchEvent(new ErrorEvent(C.error,{error:e}))}}function k(e){throw new Error(e)}function F(e){console.warn(e)}class j{#at;#ot;constructor(e){this.#at=e}get stageData(){return this.#ot}#lt(e){this.#ot._renderObject=e}rect(e,t,s,i,r){const n=new b(e,t,s,i,r);return this.#lt(n),n}text(e,t,s,i,r){const n=new v(e,t,s,i,r);return this.#lt(n),n}conus(e,t,s,i,r,n=0){const a=new A(e,t,s,i,r,n);return this.#lt(a),a}circle(e,t,s,i){const r=new x(e,t,s,i);return this.#lt(r),r}image(e,t,s,i,r,n=0,o,l=0,h=0){const c=this.#at.getImage(r);c||g(a.CANT_GET_THE_IMAGE,"iLoader can't get the image with key: "+r);const d=new T(e,t,s,i,r,n,o,c,l,h);return this.#lt(d),d}line(e,t){const s=new R(e,t);return this.#lt(s),s}polygon(e,t){const s=new S(e,t);return this.#lt(s),s}tiledLayer(e,t,s,i){const r=this.#at.getTileMap(t),n=Object.assign({},r.layers.find((t=>t.name===e))),a=Array.from(new Set(n.data.filter((e=>0!==e)))).sort(((e,t)=>e-t)),o=r.tilesets.map((e=>Object.assign({},e))).filter((e=>{const t=e.firstgid,s=t+e.data.tilecount;return!!a.find((e=>e>=t&&e<s))})),l=o.map((e=>this.#at.getImage(e.data.name))),h=new p(e,t,r,o,l,n,s,i);return l.length>1&&m("MULTIPLE_IMAGE_TILESET"," tileset "+e+" includes multiple images, it can case performance issues!"),this.#lt(h),h}_registerNewObjectMethod=(e,t)=>{this[e]=(...e)=>this.#ht(t,...e)};#ht=(e,...t)=>{const s=e(...t);return this.#lt(s),s};_attachPageData=e=>{this.#ot=e};_detachPageData=()=>{this.#ot=null}}class U{constructor(){}static mode=n.MODE.DEBUG;static gameOptions={library:n.LIBRARY.WEBGL,optimization:n.OPTIMIZATION.NATIVE_JS.OPTIMIZED,optimizationWASMUrl:"./src/wa/calculateBufferDataWat.wasm",optimizationAssemblyUrl:"/src/wa/calculateBufferDataAssembly.wasm",loadingScreen:{backgroundColor:"rgba(128, 128, 128, 0.6)",loadingBarBg:"rgba(128, 128, 128, 1)",loadingBarProgress:"rgba(128, 128, 128, 0.2)"},render:{minCycleTime:16.666,cyclesTimeCalc:{check:n.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES,averageFPStime:1e4},boundaries:{mapBoundariesEnabled:!0,realtimeCalculations:!0,wholeWorldPrecalculations:!1}},debug:{checkWebGlErrors:!1,debugMobileTouch:!1,boundaries:{drawLayerBoundaries:!1,drawObjectBoundaries:!1,boundariesColor:"rgba(224, 12, 21, 0.6)",boundariesWidth:2},delayBetweenObjectRender:!1}};static network={enabled:!1,address:"https://gameserver.reslc.ru:9009",gatherRoomsInfoInterval:5e3};static canvasMaxSize={width:1800,height:1800};static worldSize={width:960,height:960};static defaultCanvasKey="default";static customSettings={}}class Y{static debug(...e){U.mode===n.MODE.DEBUG&&e.forEach((e=>console.log(e)))}}class V extends Event{#ct;constructor(e,t){super(e),this.#dt(e)||g(a.UNEXPECTED_EVENT_NAME,", Please check if event is exist"),this.#ct=t}#dt(e){return Object.values(n.EVENTS.WEBSOCKET.SERVER_CLIENT).find((t=>t===e))}get data(){return this.#ct}}class z extends EventTarget{#ut;#gt;constructor(e){super(),e||g(a.CREATE_INSTANCE_ERROR,"systemSettings should be passed to class instance"),this.#ut=e}init(){r.e(556).then(r.bind(r,556)).then((e=>{this.#gt=e.io(this.#ut.network.address,{withCredentials:!0}),this.#mt()}))}get isServerConnected(){return!(!this.#gt||!this.#gt.connected)}get playerId(){return this.#gt.id}sendGatherRoomsInfo(){this.#gt.emit(n.EVENTS.WEBSOCKET.CLIENT_SERVER.ROOMS_INFO_REQUEST)}sendCreateOrJoinRoom(e,t){this.#gt.emit(n.EVENTS.WEBSOCKET.CLIENT_SERVER.CREATE_OR_JOIN,e,t)}sendMessage(e){this.#gt.emit(n.EVENTS.WEBSOCKET.CLIENT_SERVER.CLIENT_MESSAGE,e)}#Et=()=>{Y.debug("connected, socket id: "+this.#gt.id),this.dispatchEvent(new Event(n.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#ft=e=>{Y.debug("server disconnected, reason: "+e),this.dispatchEvent(new Event(n.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#_t=e=>{console.warn("server data: ",e)};#pt=e=>{Y.debug("received new message from server: "+e),this.dispatchEvent(new V(n.EVENTS.WEBSOCKET.SERVER_CLIENT.SERVER_MESSAGE,e))};#Tt=e=>{Y.debug("received roomsInfo "+e),this.dispatchEvent(new V(n.EVENTS.WEBSOCKET.SERVER_CLIENT.ROOMS_INFO,e))};#xt=(e,t)=>{Y.debug("CLIENT SOCKET: Created room  "+e),this.dispatchEvent(new V(n.EVENTS.WEBSOCKET.SERVER_CLIENT.CREATED,{room:e,map:t}))};#At=e=>{Y.debug("CLIENT SOCKET: Room is full, can't join: "+e),this.dispatchEvent(new V(n.EVENTS.WEBSOCKET.SERVER_CLIENT.FULL,{room:e}))};#Rt=(e,t)=>{Y.debug("CLIENT SOCKET: Joined to room: "+e,", map: ",t),this.dispatchEvent(new V(n.EVENTS.WEBSOCKET.SERVER_CLIENT.JOINED,{room:e,map:t}))};#St=e=>{this.dispatchEvent(new V(n.EVENTS.WEBSOCKET.SERVER_CLIENT.DISCONNECTED,{playerId:e}))};#mt(){this.#gt.on("connect",this.#Et),this.#gt.on("disconnect",this.#ft),this.#gt.on("data",this.#_t),this.#gt.on("roomsInfo",this.#Tt),this.#gt.on("created",this.#xt),this.#gt.on("full",this.#At),this.#gt.on("joined",this.#Rt),this.#gt.on("log",(function(e){console.log.apply(console,e)})),this.#gt.on("message",this.#pt),this.#gt.on("removed",(function(e){console.log("removed message"),console.log(e)})),this.#gt.on("disconnected",this.#St),addEventListener("beforeunload",this.#bt)}#bt=()=>{this.#gt.disconnect()}}class X{#yt=.5;#wt=new Map;#vt;constructor(e){this.#vt=e}getAudio=e=>{const t=this.#wt.get(e);return null===t?(m(d,"Audio with key "+e+" exists, but not actually loaded"),t):t||(m(c,""),null)};getAudioCloned=e=>{const t=this.#wt.get(e);if(null===t)return m(d,"Audio with key "+e+" exists, but not actually loaded"),t;if(t){const e=t.cloneNode();return e.volume=this.#yt,e}return m(c),null};set volume(e){this.#yt=e,this.#It(e)}get volume(){return this.#yt}#It(e){for(const t of this.#wt.values())t&&(t.volume=e)}registerAudio(e){let t=this.#vt.getAudio(e);this.#wt.set(e,t)}}function H(e,t){const s=t.x1,i=t.y1,r=t.x2,n=t.y2,a=e.x1,o=e.y1,l=e.x2,h=e.y2,c=(s-r)*(o-h)-(i-n)*(a-l);if(0===c)return;let d=((s*n-i*r)*(a-l)-(s-r)*(a*h-o*l))/c,u=((s*n-i*r)*(o-h)-(i-n)*(a*h-o*l))/c;const g={x:d,y:u};return q(g,e,1e-13)&&q(g,t,1e-13)?{x:d,y:u,p:Math.sqrt(Math.pow(d-s,2)+Math.pow(u-i,2))}:void 0}function K(e,t,s,i){return Math.atan2(i-t,s-e)}function Z(e,t){return e.x*t.x+e.y*t.y}function J(e,t){return e.x*t.y-t.x*e.y}function q(e,t,s=0){return(e.x>=t.x1-s&&e.x<=t.x2+s||e.x<=t.x1+s&&e.x>=t.x2-s)&&(e.y>=t.y1-s&&e.y<=t.y2+s||e.y<=t.y1+s&&e.y>=t.y2-s)}function Q(e,t){const s=new w(t.x1,t.y1,t.x2,t.y2).length;return new w(t.x1,t.y1,e.x,e.y).length+new w(t.x2,t.y2,e.x,e.y).length<=s+.2}function $(e,t){const s=e.length;for(let i=0;i<s;i+=1){let s=e[i],r=e[i+1];if(!r){if(s[0]===e[0][0]&&s[1]===e[0][1])continue;r=e[0]}const n=H({x1:s[0],y1:s[1],x2:r[0],y2:r[1]},t);if(n)return n}if(e[s-1][0]!==e[0][0]&&e[s-1][1]!==e[0][1]){const i=e[s-1],r=e[0],n=H({x1:i[0],y1:i[1],x2:r[0],y2:r[1]},t);if(n)return n}return null}function ee(e,t,s){const i=s.length;for(let r=0;r<i;r+=1){let i=s[r],n=s[r+1];if(n||(n=s[0]),Q({x:e,y:t},{x1:i[0],y1:i[1],x2:n[0],y2:n[1]}))return!0}return!1}function te(e,t,s){const i=s.r;return new w(e,t,s.x,s.y).length<i}function se(e,t,s,i){const r=i.x1,n=i.y1,a=i.x2,o=i.y2,l={x:r-e,y:n-t},h={x:a-e,y:o-t},c={x:a-r,y:o-n},d={x:r-a,y:n-o},u=Math.sqrt(Math.pow(c.x,2)+Math.pow(c.y,2)),g=Z(l,d),m=Z(h,c);let E;return g>0&&m>0?(E=J(l,h)/u,E<0&&(E*=-1)):E=Math.min(l.length,h.length),E<=s}function ie(e,t){const s=e[0],i=e[1],r=e[2],n=e[3],a={x:s-t[0][0],y:i-t[0][1]},o={x:s-t[1][0],y:i-t[1][1]},l=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2)),h=Math.sqrt(Math.pow(o.x,2)+Math.pow(o.y,2)),c=Math.min(l,h);if(c>Math.max(r,n))return!1;const d=c===l?a:o,u=Math.atan2(d.y,d.x),g={x:0-Math.cos(u)*r,y:0-Math.sin(u)*n};return!(c>Math.sqrt(Math.pow(g.x,2)+Math.pow(g.y,2)))}function re(e,t){const s=e[0],i=e[1],r={x:s-t.x,y:i-t.y},n=Math.sqrt(Math.pow(r.x,2)+Math.pow(r.y,2));if(n>Math.max(e[2],e[3])+t.r)return!1;{const r=K(s,i,t.x,t.y),a=s-(s+e[2]*Math.cos(r)),o=i-(i+e[3]*Math.sin(r));return n<=Math.sqrt(Math.pow(a,2)+Math.pow(o,2))+t.r&&{x:a,y:o,p:1}}}function ne(e,t){const s=t.length;for(let i=0;i<s;i+=1){let s=t[i],r=t[i+1];if(r||(r=t[0]),ie(e,[s,r]))return!0}return!1}function ae(e=0,t=0,s,i,r=2*Math.PI,n=Math.PI/8){let a=[];for(let o=0;o<=r;o+=n){let r=Math.cos(o)*s+e,n=Math.sin(o)*i+t;a.push([r,n])}return a}function oe(e,t){let s=[];for(let i=0;i<9;i+=3){let r=i;for(let n=0;n<3;n++){let a=0,o=n;for(let s=0;s<3;s++)a+=e[i+s]*t[o],o+=3;s[r]=a,r++}}return s}function le(e,t){let s=[],i=0;for(let r=0;r<9;r+=3){let n=0;const a=r+3;let o=0;for(let s=r;s<a;s++)n+=e[s]*t[o],o++;s[i]=n,i++}return s}class he{#Ct;#Ot;#Pt=!0;constructor(e,t=0){this.#Ot=e,this.#Ct=t}get _isTextureRecalculated(){return this.#Pt}set _isTextureRecalculated(e){this.#Pt=e}get _texture(){return this.#Ot}set _texture(e){this.#Ot=e}get _textureIndex(){return this.#Ct}}class ce{#Mt;#Dt;#Bt;#Lt;#vt;#Nt;#Wt;#Gt=null;#kt=null;#Ft=new Map;#jt=new Map;#Ut=new Map;#Yt;constructor(e,t,s){e&&e instanceof WebGLRenderingContext||g(a.UNEXPECTED_INPUT_PARAMS," context parameter should be specified and equal to WebGLRenderingContext"),this.#Mt=e,this.#Lt=t,this.#vt=s,this.#Bt=t.debug.checkWebGlErrors,this.#Dt=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.#Nt=e.createBuffer(),this.#Wt=e.createBuffer(),this._registerObjectRender(v.name,this._bindText,n.WEBGL.DRAW_PROGRAMS.IMAGES_M),this._registerObjectRender(b.name,this._bindPrimitives,n.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(S.name,this._bindPrimitives,n.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(x.name,this._bindConus,n.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(A.name,this._bindConus,n.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(p.name,this._bindTileImages,n.WEBGL.DRAW_PROGRAMS.IMAGES_M),this._registerObjectRender(R.name,this._bindLine,n.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(n.DRAW_TYPE.IMAGE,this._bindImage,n.WEBGL.DRAW_PROGRAMS.IMAGES_M)}getProgram(e){return this.#Ft.get(e)}getProgramVarLocations(e){return this.#jt.get(e)}_fixCanvasSize(e,t){this.#Mt.viewport(0,0,e,t)}_initiateJsRender=e=>new Promise(((t,s)=>{const i=e.getObjectsByInstance(p),[r,n]=e.worldDimensions;let a=0,o=0,l=0,h=0,c=0;i.forEach((e=>{const t=e.setBoundaries,s=e.layerData,i=e.tilemap,r=e.tilesets,{tileheight:n,tilewidth:d}=i,u=d,g=n;for(let e=0;e<r.length;e++){const e=u*s.width,i=g*s.height,r=s.polygonBoundariesLen,n=s.ellipseBoundariesLen,d=s.pointBoundariesLen;h<e&&(h=e),c<i&&(c=i),t&&(a+=r,o+=n,l+=d)}})),0===h||0===c||h===r&&c===n||(m("UNEXPECTED_WORLD_SIZE"," World size from tilemap is different than settings one, fixing..."),e._setWorldDimensions(h,c)),this.#Lt.render.boundaries.mapBoundariesEnabled&&(a+=16),e._setMaxBoundariesSize(a,o,l),e._initiateBoundariesData(),t(!0)}));_initWebGlAttributes=()=>{const e=this.#Mt;return e.enable(e.BLEND),e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,255),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),Promise.resolve()};_initiateWasm=e=>{const t=this.#Lt.optimization===n.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT?this.#Lt.optimizationWASMUrl:this.#Lt.optimizationAssemblyUrl;return new Promise(((e,s)=>{this.layerData=new WebAssembly.Memory({initial:1e3}),this.layerDataFloat32=new Float32Array(this.layerData.buffer);const i={env:{memory:this.layerData,logi:console.log,logf:console.log}};fetch(t).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,i))).then((t=>{this.calculateBufferData=t.instance.exports.calculateBufferData,e()}))}))};_initDrawCallsDebug(e){this.#Yt=e}_clearView(){const e=this.#Mt;this.#Yt.cleanupDebugInfo(),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}_render(e,t,s=0){return this.#Mt.drawArrays(t,s,e),Promise.resolve(e)}_preRender(){return new Promise(((e,t)=>{const s=this.#Mt,i=this.#Bt?s.getError():0;if(0!==i)throw console.error(i),new Error("Error num: "+i);e()}))}_postRender(e){let t=e;if(Array.isArray(t)){const[s,i]=e;this.#Mt.drawArrays(i,0,s),t=s}return new Promise(((e,s)=>{const i=this.#Mt;0!==t&&(this.#Yt.incrementDrawCallsCounter(),this.#Yt.verticesDraw=t),i.stencilFunc(i.ALWAYS,1,255),this.#Lt.debug.delayBetweenObjectRender?setTimeout((()=>{e()}),1e3):e()}))}_registerAndCompileWebGlProgram(e,t,s,i,r){const n=this.#Vt(t,s),a=this.#zt(n,i,r);return this.#Ft.set(e,n),this.#jt.set(e,a),Promise.resolve()}#Vt(e,t){const s=this.#Mt,i=s.createProgram();if(i){const r=this.#Xt(s,e,s.VERTEX_SHADER);r?s.attachShader(i,r):g(a.WEBGL_ERROR,"#compileShader(vertexShaderSource) is null");const n=this.#Xt(s,t,s.FRAGMENT_SHADER);if(n?s.attachShader(i,n):g(a.WEBGL_ERROR,"#compileShader(fragmentShaderSource) is null"),s.linkProgram(i),!s.getProgramParameter(i,s.LINK_STATUS)){const e=s.getProgramInfoLog(i);g(a.WEBGL_ERROR,`Could not compile WebGL program. \n\n${e}`)}}else g(a.WEBGL_ERROR,"gl.createProgram() is null");return i}#zt(e,t,s){const i=this.#Mt;let r={};return t.forEach((t=>{r[t]=i.getUniformLocation(e,t)})),s.forEach((t=>{r[t]=i.getAttribLocation(e,t)})),r}#Xt(e,t,s){const i=e.createShader(s);if(i){if(e.shaderSource(i,t),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(i);g(a.WEBGL_ERROR,"Couldn't compile webGl program. \n\n"+t)}}else g(a.WEBGL_ERROR,`gl.createShader(${s}) is null`);return i}_bindPrimitives=(e,t,s,i,r)=>{const[a,o]=!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset,l=e.x-a,h=e.y-o,c=[1,1],d=e.rotation,g=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA],{u_translation:E,u_rotation:f,u_scale:_,u_resolution:p,u_color:T,a_position:x,u_fade_min:A}=r;let R=0;switch(t.useProgram(i),t.uniform2f(p,t.canvas.width,t.canvas.height),t.uniform2f(E,l,h),t.uniform2f(_,c[0],c[1]),t.uniform1f(f,d),t.uniform1f(A,0),t.enableVertexAttribArray(x),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),e.type){case n.DRAW_TYPE.RECTANGLE:this.#Ht(e.width,e.height),R+=6;break;case n.DRAW_TYPE.TEXT:break;case n.DRAW_TYPE.CIRCLE:{const s=e.vertices;t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),R+=s.length/2;break}case n.DRAW_TYPE.POLYGON:{const t=this.#Kt(e.vertices);this.#Zt(t);const s=t.length;if(s%3!=0)return m(u,`polygons ${e.id}, vertices are not correct, skip drawing`),Promise.reject();R+=s/2;break}}const S=t.FLOAT;t.vertexAttribPointer(x,2,S,!1,0,0);const b=this.#Jt(e.bgColor);return t.uniform4f(T,b[0]/255,b[1]/255,b[2]/255,b[3]),g&&t.blendFunc(g[0],g[1]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),this._render(R,t.TRIANGLES)};_bindConus=(e,t,s,i,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset,o=e.x-n,l=e.y-a,h=[1,1],c=e.rotation,{u_translation:d,u_rotation:u,u_scale:g,u_resolution:m,u_color:E,a_position:f,u_fade_max:_,u_fade_min:p}=r,T=e.vertices,x=e.bgColor,A=e.fade_min,R=e.radius,S=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA];let b=0;t.useProgram(i),t.uniform2f(m,t.canvas.width,t.canvas.height),t.uniform2f(d,o,l),t.uniform2f(g,h[0],h[1]),t.uniform1f(u,c),t.uniform1f(p,A),t.uniform1f(_,R),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(T),t.STATIC_DRAW),t.enableVertexAttribArray(f);const y=t.FLOAT;t.vertexAttribPointer(f,2,y,!1,0,0),b+=T.length/2,S&&t.blendFunc(S[0],S[1]);const w=this.#Jt(x);return t.uniform4f(E,w[0]/255,w[1]/255,w[2]/255,w[3]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),this._render(b,t.TRIANGLE_FAN)};_bindText=(e,t,s,i,r)=>{const{u_translation:n,u_rotation:a,u_scale:o,u_resolution:l,a_position:h,a_texCoord:c,u_image:d}=r,{width:u,height:g}=e.boundariesBox,[m,E]=(e.text,!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset),f=e.x-m,_=e.y-E-g,p=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],T=e.rotation||0,x=[1,1],A=f+u,R=_+g,S=[f,_,A,_,f,R,f,R,A,_,A,R];let b=0;t.useProgram(i),t.uniform2f(l,t.canvas.width,t.canvas.height),t.uniform2f(n,f,_),t.uniform2f(o,x[0],x[1]),t.uniform1f(a,T),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(S),t.STATIC_DRAW),t.enableVertexAttribArray(h);const y=t.FLOAT;t.vertexAttribPointer(h,2,y,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Wt),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(c),t.vertexAttribPointer(c,2,t.FLOAT,!1,0,0),b+=6,t.blendFunc(p[0],p[1]);let w=e._textureStorage;return w||(w=new he(t.createTexture()),e._textureStorage=w),!0===w._isTextureRecalculated?(this.#qt(t,w._texture,e._textureCanvas),w._isTextureRecalculated=!1):this.#Qt(t,w._texture),t.uniform1i(d,w._textureIndex),t.depthMask(!1),this._render(6,t.TRIANGLES)};_canTextBeMerged=(e,t)=>{const s=this.#Ut.get(e.constructor.name)||this.#Ut.get(e.type),i=this.#Ut.get(t.constructor.name)||this.#Ut.get(t.type);return s.webglProgramName===i.webglProgramName&&e.type===t.type};_bindImage=(e,t,s,i,r)=>{const[n,o]=!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset,l=e.x-n,h=e.y-o;e.vertices&&this.#Lt.debug.boundaries.drawObjectBoundaries&&(s._enableDebugObjectBoundaries(),s._addImageDebugBoundaries(function(e=0,t=0,s,i){const r=i.length;let n=Array(r),a=0;for(let o=0;o<r;o++){const r=i[o];let l=i[o+1];l||(l=i[0]);const h=r[0],c=r[1],d=l[0],u=l[1],g=[h*Math.cos(s)-c*Math.sin(s)+e,h*Math.sin(s)+c*Math.cos(s)+t,d*Math.cos(s)-u*Math.sin(s)+e,d*Math.sin(s)+u*Math.cos(s)+t];n[a]=g,a++}return n}(l,h,e.rotation,e.vertices)));const{u_resolution:c,a_position:d,a_texCoord:u,u_image:m}=r;if(!e.image){const t=this.#vt.getImage(e.key);t?e.image=t:g(a.CANT_GET_THE_IMAGE,"iLoader can't get the image with key: "+e.key)}const E=e.image,f=e.imageIndex,_=e._maskId,p=e.spacing,T=e.margin,x=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],A=[1,1];let R=T,S=T,b=0,y=0;if(0!==f){const t=(E.width+p-2*T)/(e.width+p);b=f%t,y=Math.floor(f/t),R=b*e.width+b*p+T,S=y*e.height+y*p+T}const w=Math.cos(e.rotation),v=Math.sin(e.rotation),I=[A[0],0,0,0,A[1],0,0,0,1],C=oe(oe([1,0,l,0,1,h,0,0,1],[w,-v,0,v,w,0,0,0,1]),I),O=0-e.width/2,P=0-e.height/2,M=O+e.width,D=P+e.height,B=1/E.width*R,L=1/E.height*S,N=B+1/E.width*e.width,W=L+1/E.height*e.height,G=le(C,[O,P,1]),k=le(C,[M,P,1]),F=le(C,[O,D,1]),j=le(C,[M,D,1]),U=[G[0],G[1],k[0],k[1],F[0],F[1],F[0],F[1],k[0],k[1],j[0],j[1]],Y=[B,L,N,L,B,W,B,W,N,L,N,W],V=s.renderObjects.indexOf(e),z=s.renderObjects[V+1];if(z&&this._canImageObjectsMerge(e,z))return null===this.#Gt?(this.#Gt=U,this.#kt=Y,Promise.resolve(0)):(this.#Gt.push(...U),this.#kt.push(...Y),Promise.resolve(0));{t.useProgram(i),t.uniform2f(c,t.canvas.width,t.canvas.height),null===this.#Gt?(this.#Gt=U,this.#kt=Y):(this.#Gt.push(...U),this.#kt.push(...Y)),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#Gt),t.STATIC_DRAW);const s=this.#Gt.length/2;t.enableVertexAttribArray(d);const r=2,n=t.FLOAT,a=!1,o=0,l=0;t.vertexAttribPointer(d,r,n,a,o,l),t.bindBuffer(t.ARRAY_BUFFER,this.#Wt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#kt),t.STATIC_DRAW),t.enableVertexAttribArray(u),t.vertexAttribPointer(u,2,t.FLOAT,!1,0,0);let h=e._textureStorage;return h||(h=new he(t.createTexture()),e._textureStorage=h),!0===h._isTextureRecalculated?(this.#$t(t,h._texture,e.image),h._isTextureRecalculated=!1):this.#Qt(t,h._texture),t.uniform1i(m,h._textureIndex),t.blendFunc(x[0],x[1]),_&&t.stencilFunc(t.EQUAL,_,255),this.#Gt=null,this.#kt=null,this._render(s,t.TRIANGLES)}};_canImageObjectsMerge=(e,t)=>{const s=this.#Ut.get(e.constructor.name)||this.#Ut.get(e.type),i=this.#Ut.get(t.constructor.name)||this.#Ut.get(t.type);return s.webglProgramName===i.webglProgramName&&e.type===t.type&&e.image===t.image};_bindTileImages=async(e,t,s,i,r)=>{const{u_translation:a,u_rotation:o,u_scale:l,u_resolution:h,a_position:c,a_texCoord:d,u_image:u}=r;let g;switch(t.useProgram(i),this.#Lt.optimization){case n.OPTIMIZATION.NATIVE_JS.NOT_OPTIMIZED:g=await this.#es(e,s);break;case n.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT:case n.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT:g=await this.#ts(e,s);break;case n.OPTIMIZATION.NATIVE_JS.OPTIMIZED:default:g=await this.#ss(e,s)}e.rotation;const m=["ONE","ONE_MINUS_SRC_ALPHA"],E=e._maskId,f=s.renderObjects.indexOf(e),_=s.renderObjects[f+1];if(this._canMergeNextTileObject(e,_))return null===this.#Gt?(this.#Gt=g[0][0],this.#kt=g[0][1],Promise.resolve(0)):(this.#Gt.push(...g[0][0]),this.#kt.push(...g[0][1]),Promise.resolve(0));{let s=0,i=!1;t.enableVertexAttribArray(c),t.enableVertexAttribArray(d),t.uniform2f(h,t.canvas.width,t.canvas.height);for(let r=0;r<g.length;r++){const n=g[r],a=n[0],o=n[1],l=(n[2],n[3]);if(a.length>0&&o.length>0){i&&(this.#Gt=null,this.#kt=null,await this._render(s,t.TRIANGLES)),null===this.#Gt?(this.#Gt=a,this.#kt=o):(this.#Gt.push(...a),this.#kt.push(...o)),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#Gt),t.STATIC_DRAW);const n=2,h=t.FLOAT,g=!1,f=0,_=0;t.vertexAttribPointer(c,n,h,g,f,_),t.bindBuffer(t.ARRAY_BUFFER,this.#Wt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#kt),t.STATIC_DRAW),t.vertexAttribPointer(d,2,t.FLOAT,!1,0,_);let p=e._textureStorages[r];p||(p=new he(t.createTexture(),r),e._setTextureStorage(r,p)),!0===p._isTextureRecalculated?(this.#$t(t,p._texture,l,p._textureIndex),p._isTextureRecalculated=!1):this.#Qt(t,p._texture,p._textureIndex),t.uniform1i(u,p._textureIndex),t.blendFunc(t[m[0]],t[m[1]]),s=this.#Gt.length/2,E&&t.stencilFunc(t.EQUAL,E,255),i=!0}}return this.#Gt=null,this.#kt=null,g=null,this._render(s,t.TRIANGLES)}};_canMergeNextTileObject=(e,t)=>t instanceof p&&1===e.tilesetImages.length&&1===t.tilesetImages.length&&e.tilesetImages[0]===t.tilesetImages[0];_drawPolygon(e,t){const[s,i]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,r=e.x-s,a=e.y-i,o=e.rotation||0,l=e.vertices,h=this.#Lt.debug.boundaries.boundariesColor,c=this.getProgram(n.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:d,u_rotation:g,u_scale:E,u_resolution:f,u_color:_,a_position:p,u_fade_max:T,u_fade_min:x}=this.getProgramVarLocations(n.WEBGL.DRAW_PROGRAMS.PRIMITIVES),A=this.#Mt;let R=0;A.useProgram(c),A.uniform2f(f,A.canvas.width,A.canvas.height),A.uniform2f(d,r,a),A.uniform2f(E,1,1),A.uniform1f(g,o),A.uniform1f(x,0),A.enableVertexAttribArray(p),A.bindBuffer(A.ARRAY_BUFFER,this.#Nt);const S=this.#Kt(l),b=S.length;if(b%3!=0)return void m(u,"polygon boundaries vertices are not correct, skip drawing");this.#Zt(S),R+=b/2;const y=A.FLOAT;A.vertexAttribPointer(p,2,y,!1,0,0);const w=this.#Jt(h);A.uniform4f(_,w[0]/255,w[1]/255,w[2]/255,w[3]),this._render(R,A.TRIANGLES)}_bindLine=(e,t,s,i,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset,o=e.x-n,l=e.y-a,h=e.rotation,{u_translation:c,u_rotation:d,u_scale:u,u_resolution:g,u_color:m,a_position:E,u_fade_max:f,u_fade_min:_}=r,p=e.vertices,T=e.bgColor,x=(e.fade_min,e.radius,this.#Lt.debug.boundaries.boundariesWidth);let A=0;t.useProgram(i),t.uniform2f(g,t.canvas.width,t.canvas.height),t.uniform2f(c,o,l),t.uniform2f(u,1,1),t.uniform1f(d,h),t.uniform1f(_,0),t.enableVertexAttribArray(E),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(p),t.STATIC_DRAW),A+=p.length/2;const R=t.FLOAT;t.vertexAttribPointer(E,2,R,!1,0,0);const S=this.#Jt(T);return t.uniform4f(m,S[0]/255,S[1]/255,S[2]/255,S[3]),t.lineWidth(x),this._render(0,t.LINES)};_drawLines(e,t,s=1,i=0,r=[0,0]){const a=this.getProgram(n.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:o,u_rotation:l,u_scale:h,u_resolution:c,u_color:d,a_position:u,u_fade_max:g,u_fade_min:m}=this.getProgramVarLocations(n.WEBGL.DRAW_PROGRAMS.PRIMITIVES),E=this.#Mt;let f=0;E.useProgram(a),E.uniform2f(c,E.canvas.width,E.canvas.height),E.uniform2f(o,r[0],r[1]),E.uniform2f(h,1,1),E.uniform1f(l,i),E.uniform1f(m,0),E.enableVertexAttribArray(u),E.bindBuffer(E.ARRAY_BUFFER,this.#Nt),E.bufferData(E.ARRAY_BUFFER,e instanceof Float32Array?e:new Float32Array(e),E.STATIC_DRAW),f+=e.length/2;const _=E.FLOAT;E.vertexAttribPointer(u,2,_,!1,0,0);const p=this.#Jt(t);E.uniform4f(d,p[0]/255,p[1]/255,p[2]/255,p[3]),E.lineWidth(s),this._render(f,E.LINES)}_registerObjectRender(e,t,s){this.#Ut.set(e,{method:t,webglProgramName:s})}_drawRenderObject(e,t){const s=e.constructor.name,i=this.#Ut.get(s)||this.#Ut.get(e.type);if(i){const s=i.webglProgramName,r=s?this.getProgram(s):null,n=s?this.getProgramVarLocations(s):null;return i.method(e,this.#Mt,t,r,n)}return console.warn("no registered draw object method for "+s+" skip draw"),Promise.resolve()}#ss(e,t){return new Promise(((s,i)=>{const r=e.tilemap,n=e.tilesets,a=e.tilesetImages,l=e.layerData,{tileheight:h,tilewidth:c}=r,d=c,u=h,[g,E]=t.canvasDimensions,[f,_]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,p=(this.#Lt.render.boundaries.realtimeCalculations,e.setBoundaries),T=[];l||(m(o,"check tilemap and layers name"),i()),this.#Lt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<n.length;e++){const s=n[e].data,i=n[e].firstgid,r=n[e+1],o=r?r.firstgid:1e9,x=s.tilewidth,A=s.tileheight,R=a[e],S=s.imagewidth,b=s.imageheight,y=s.columns,w=l.width,v=l.height,I=d*w,C=u*v,O=_%u,P=f%d,M=0!==_?Math.floor(_/u):0,D=0!==f?Math.floor(f/d):0,B=C>E?Math.ceil(E/u)+1:v,L=I>g?Math.ceil(g/d)+1:w,N=B*L,W=w-L-D,G=s.spacing,k=s.margin,F=s._hasAnimations,j=s._hasBoundaries,U=s._boundaries,Y=n[e]._temp;Y.cells!==N&&Y._initiateStorageData(N);let V=Y.vectors,z=Y.textures,X=0;V=[],z=[];let H=Y._bTempIndexes;const K=4*L;let Z=M*w;for(let e=0;e<B;e++){Z+=D;for(let r=0;r<L;r++){let n=l.data[Z];if(n>=i&&n<o){const a=r*c-P,o=e*h-O;if(n-=i,F){const e=s._animations.get(n);void 0!==e&&(n=e)}const l=n%y,d=Math.floor(n/y),u=a,g=o,E=a+x,f=o+A,_=1/S*(l*x+l*G+k),T=1/b*(d*A+d*G+k),R=_+1/S*x,w=T+1/b*A;if(V[X]=u,z[X]=_,X++,V[X]=g,z[X]=T,X++,V[X]=E,z[X]=R,X++,V[X]=g,z[X]=T,X++,V[X]=u,z[X]=_,X++,V[X]=f,z[X]=w,X++,V[X]=u,z[X]=_,X++,V[X]=f,z[X]=w,X++,V[X]=E,z[X]=R,X++,V[X]=g,z[X]=T,X++,V[X]=E,z[X]=R,X++,V[X]=f,z[X]=w,X++,p){let s=!1;if(j&&U.size>0){const e=U.get(n);e&&(s=!0,e.objects.forEach((e=>{const s=a+e.x,i=o+e.y;if(0!==e.rotation&&m("tilesetData.tiles.rotation property is not supported yet"),e.polygon)e.polygon.forEach(((r,n)=>{const a=e.polygon[n+1];if(a)t._addBoundaryLine(r.x+s,r.y+i,a.x+s,a.y+i);else{const n=e.polygon[0];t._addBoundaryLine(r.x+s,r.y+i,n.x+s,n.y+i)}}));else if(e.point)t._addPointBoundary(s,i);else if(e.ellipse){const r=e.width/2,n=e.height/2;t._addEllipseBoundary(s+r,i+n,r,n)}else{const r=e.width,n=e.height,a=r+s,o=n+i;t._addBoundaryLine(s,i,a,i),t._addBoundaryLine(a,i,a,o),t._addBoundaryLine(a,o,s,o),t._addBoundaryLine(s,o,s,i)}})))}if(!1===s){const s=t.getRawBoundaries();let i=[a+x,o,a+x,o+A],n=[a+x,o+A,a,o+A],l=[a,o,a+x,o],h=[a,o+A,a,o];if(0!==e){const n=(e-1)*K+4*r,a=H[n+2];if(a){const e=s[a];if(e){const i=s[a+1],r=s[a+2],n=s[a+3],o=l[0],h=l[1],c=l[2],d=l[3];o===r&&h===n&&c===e&&d===i&&(t._removeBoundaryLine(a),l=void 0)}const r=H[n+1],o=s[r];if(o){const e=s[r+1],n=s[r+2],a=s[r+0];o===s[r+2]&&n===a&&(t._removeBoundaryLine(r),i[0]=o,i[1]=e)}const c=H[n+3],d=s[c];if(d){const e=s[c+2],i=s[c+3],r=h[0];d===h[2]&&e===r&&(t._removeBoundaryLine(c),h[2]=e,h[3]=i)}}}if(0!==r){const i=e*K+4*(r-1),a=H[i];if(a){const e=H[i+1],r=s[e],o=s[e+1],c=s[e+2],d=s[e+3],u=h[0],g=h[1],m=h[2],E=h[3];u===c&&g===d&&m===r&&E===o&&(t._removeBoundaryLine(e),h=void 0);const f=s[a];if(f&&l){const e=s[a+1],i=s[a+3],r=l[1];e===l[3]&&i===r&&(t._removeBoundaryLine(a),l[0]=f,l[1]=e)}const _=H[i+2];if(s[_]){const e=s[_+1],i=s[_+2],r=s[_+3],a=n[1];e===n[3]&&r===a&&(t._removeBoundaryLine(_),n[2]=i,n[3]=r)}}}const c=e*K+4*r;l&&(t._addBoundaryLine(l[0],l[1],l[2],l[3]),H[c+0]=t.boundariesLen-4),t._addBoundaryLine(i[0],i[1],i[2],i[3]),H[c+1]=t.boundariesLen-4,t._addBoundaryLine(n[0],n[1],n[2],n[3]),H[c+2]=t.boundariesLen-4,h&&(t._addBoundaryLine(h[0],h[1],h[2],h[3]),H[c+3]=t.boundariesLen-4)}}}Z++}Z+=W}T.push([V,z,s.name,R]),H.fill(0)}s(T)}))}#es(e,t){return new Promise(((s,i)=>{const r=e.tilemap,n=e.tilesets,a=e.tilesetImages,l=e.layerData,{tileheight:h,tilewidth:c}=r,[d,u]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset;let g=[];l||(m(o,"check tilemap and layers name"),i()),this.#Lt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<=n.length-1;e++){const t=n[e].data,s=n[e].firstgid,i=n[e+1],r=i?i.firstgid:1e9,o=t.tilewidth,m=t.tileheight,E=t.columns,f=l.width,_=l.height,p=a[e],T=p.width,x=p.height,A=t.spacing,R=t.margin,S=n[e]._temp;let b=0,y=S.vectors,w=S.textures,v=0;y=[],w=[];for(let e=0;e<_;e++)for(let t=0;t<f;t++){let i=l.data[b];if(i>=s&&i<r){i-=s;const r=i%E,n=Math.floor(i/E),a=t*c-d,l=e*h-u,g=a+o,f=l+m,_=1/T*(r*o+r*A+R),p=1/x*(n*m+n*A+R),S=_+1/T*o,b=p+1/x*m;y[v]=a,w[v]=_,v++,y[v]=l,w[v]=p,v++,y[v]=g,w[v]=S,v++,y[v]=l,w[v]=p,v++,y[v]=a,w[v]=_,v++,y[v]=f,w[v]=b,v++,y[v]=a,w[v]=_,v++,y[v]=f,w[v]=b,v++,y[v]=g,w[v]=S,v++,y[v]=l,w[v]=p,v++,y[v]=g,w[v]=S,v++,y[v]=f,w[v]=b,v++}b++}g.push([y,w,t.name,p])}s(g)}))}#ts=(e,t)=>new Promise(((s,i)=>{const r=e.tilemap,n=r.tilesets,a=e.tilesetImages,l=e.layerData,{tileheight:h,tilewidth:c}=r,d=l.data.length,u=l.data.filter((e=>0!==e)).length,[g,E]=t.worldDimensions,[f,_]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,p=[];this.layerDataFloat32.set(l.data),l||(m(o,"check tilemap and layers name"),i()),this.#Lt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<n.length;e++){const t=n[e].data,s=n[e].firstgid,i=n[e+1],r=i?i.firstgid:1e9,o=t.tilewidth,g=t.tileheight,m=t.columns,E=l.width,T=l.height,x=a[e],A=x.width,R=x.height,S=4,b=12*u,y=12*u,w=t.spacing,v=(t.margin,this.calculateBufferData(S,d,b,T,E,c,h,o,g,m,A,R,f,_,s,r,w,!1)),I=v>0?this.layerDataFloat32.slice(d,b+d):[],C=v>0?this.layerDataFloat32.slice(b+d,b+y+d):[];p.push([Array.from(I),Array.from(C),t.name,x])}s(p)}));#Jt(e){return e.replace("rgba(","").replace(")","").split(",").map((e=>Number(e.trim())))}#Kt(e){const t=new Float32Array(e.length*e.length),[s,i]=this.#is(e,t,0);return s.slice(0,i)}#is(e,t,s){const i=e.length;if(i<=3)return e.forEach((e=>{t[s]=e[0],s++,t[s]=e[1],s++})),[t,s];const r=[...e].sort(((e,t)=>t[1]-e[1])),n=e.indexOf(r[0]),a=n!==i-1?n+1:0;let o=e,l=o.length,h=0,c=a;for(;o.length>2;){const e=o.length;c>=e&&(c-=e);const i=0===c?o[e-1]:o[c-1],r=o[c],n=e===c+1?o[0]:o[c+1];if(d=i,u=r,J({x:(g=n)[0]-d[0],y:g[1]-d[1]},{x:u[0]-d[0],y:u[1]-d[1]})<0)t[s]=i[0],s++,t[s]=i[1],s++,t[s]=r[0],s++,t[s]=r[1],s++,t[s]=n[0],s++,t[s]=n[1],s++,o=o.filter(((e,t)=>t!==c));else{if(h+=1,h>l)return m("TRIANGULATE_ISSUE","Can't extract all triangles vertices."),[t,s];c++}}var d,u,g;return[t,s]}#Zt(e){this.#Mt.bufferData(this.#Mt.ARRAY_BUFFER,new Float32Array(e),this.#Mt.STATIC_DRAW)}#Ht(e,t){const s=0+e,i=0+t;this.#Mt.bufferData(this.#Mt.ARRAY_BUFFER,new Float32Array([0,0,s,0,0,i,0,i,s,0,s,i]),this.#Mt.STATIC_DRAW)}#$t(e,t,s,i=0,r=!1){this.#Qt(e,t,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r?e.LINEAR_MIPMAP_LINEAR:e.LINEAR)}#qt(e,t,s,i=0){this.#Qt(e,t,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)}#Qt(e,t,s=0){e.activeTexture(e.TEXTURE0+s),e.bindTexture(e.TEXTURE_2D,t)}#rs(e,t){e.deleteTexture(t)}isPowerOfTwo(e){return!(e&e-1)}nextHighestPowerOfTwo(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}#ns=e=>e-33984}const de=["u_translation","u_rotation","u_scale","u_resolution","u_image"],ue=["a_position","a_texCoord"],ge=["u_translation","u_rotation","u_scale","u_resolution","u_fade_min","u_fade_max","u_color"],me=["a_position"],Ee=["u_resolution","u_image"],fe=["a_position","a_texCoord"];class _e{#as=0;#os=0;#ls=0;#hs;#cs=0;constructor(e){this.#hs=new Float32Array(e)}get drawCalls(){return this.#os}get verticesDraw(){return this.#as}get tempRCircleT(){return this.#hs}get tempRCircleTPointer(){return this.#cs}set tempRCircleT(e){this.#hs[this.#cs]=e}set prevDrawTime(e){this.#ls=e}currentDrawTime(e){return e-this.#ls}incrementTempRCircleTPointer(){this.#cs++}incrementDrawCallsCounter(){this.#os+=1}set verticesDraw(e){this.#as+=e}cleanupDebugInfo(){this.#as=0,this.#os=0}cleanupDrawCallsCounter(){this.#os=0}cleanupTempVars(){this.#hs.fill(0),this.#cs=0}}class pe{#r;#ds;#us;#gs;#ms;#Es;#ut;#X=new EventTarget;constructor(e,t,s){this.#ut=e,this.#ms=t,this.#us=new _e(this.#ut.gameOptions.render.cyclesTimeCalc.averageFPStime),this.#Es=s,this.#Es._initDrawCallsDebug(this.renderLoopDebug),this.#ut.gameOptions.render.cyclesTimeCalc.check===n.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES&&(this.#gs=setInterval((()=>this.#fs()),this.#ut.gameOptions.render.cyclesTimeCalc.averageFPStime))}get stageData(){return this.#ms}get renderLoopDebug(){return this.#us}set _isCleared(e){this.#ds=e}get _isCleared(){return this.#ds}_start(){this.#r=!0,requestAnimationFrame(this.#_s)}_stop(){this.#r=!1,this.#ms=null,this.renderLoopDebug.cleanupTempVars(),clearInterval(this.#gs)}#_s=e=>{if(!this.#r)return;const t=this.renderLoopDebug.currentDrawTime(e);this.renderLoopDebug.prevDrawTime=e;const s=performance.now(),i=this.#ut.gameOptions.render.cyclesTimeCalc.check===n.OPTIMIZATION.CYCLE_TIME_CALC.CURRENT;this.emit(n.EVENTS.SYSTEM.RENDER.START),this.#ms._clearBoundaries(),this.#ps(),this.render().then((()=>{const e=performance.now()-s;i?(console.log("current draw take: ",t," ms"),console.log("current render() time: ",e),console.log("draw calls: ",this.renderLoopDebug.drawCalls),console.log("vertices draw: ",this.renderLoopDebug.verticesDraw)):(this.renderLoopDebug.tempRCircleT=t,this.renderLoopDebug.incrementTempRCircleTPointer()),this.emit(n.EVENTS.SYSTEM.RENDER.END),this.#r&&setTimeout((()=>requestAnimationFrame(this.#_s)),0)})).catch((e=>{e.forEach?e.forEach((e=>{m(h,e)})):m(h,e.message),this._stop()}))};async render(){const e=this.#ms.renderObjects;let t=[],s=!1,i=e.length,r=new Array(i);if(0!==i){for(let t=0;t<i;t++){const s=e[t];if(s.isRemoved){e.splice(t,1),t--,i--;continue}s.hasAnimations&&s._processActiveAnimations();const n=await this.#Ts(s).catch((e=>Promise.reject(e)));r[t]=n}this.#ut.gameOptions.debug.boundaries.drawLayerBoundaries&&r.push(this.#xs().catch((e=>Promise.reject(e))))}return(await Promise.allSettled(r)).forEach((e=>{"rejected"===e.status&&(Promise.reject(e.reason),s=!0,t.push(e.reason))})),this._isCleared=!1,!1===s?(this.#ms._processPendingRenderObjects(),Promise.resolve()):Promise.reject(t)}addEventListener=(e,t,s)=>{this.#X.addEventListener(e,t,s)};removeEventListener=(e,t,s)=>{this.#X.removeEventListener(e,t,s)};emit=(e,...t)=>{const s=new Event(e);s.data=[...t],this.#X.dispatchEvent(s)};#Ts(e){return this.#Es._preRender().then((()=>this.#r?this.#Es._drawRenderObject(e,this.stageData):Promise.resolve())).then((e=>this.#Es._postRender(e)))}#ps(){this.#Es._clearView()}#xs(){return new Promise((e=>{const t=this.stageData.getRawBoundaries(),s=this.stageData.getEllipseBoundaries(),i=this.stageData.getPointBoundaries(),r=this.stageData.getDebugObjectBoundaries(),n=this.stageData.boundariesLen,a=this.stageData.ellipseBLen,o=this.stageData.pointBLen,l=this.#ut.gameOptions.debug.boundaries.drawObjectBoundaries?r.length:0;if(n&&this.#Es._drawLines(t,this.#ut.gameOptions.debug.boundaries.boundariesColor,this.#ut.gameOptions.debug.boundaries.boundariesWidth),this.renderLoopDebug.incrementDrawCallsCounter(),a)for(let e=0;e<a;e+=4){const t=ae(s[e],s[e+1],s[e+2],s[e+3]);this.#Es._drawPolygon({x:0,y:0,vertices:t,isOffsetTurnedOff:!0},this.stageData),this.renderLoopDebug.incrementDrawCallsCounter()}if(o)for(let e=0;e<o;e+=2){const t=i[e],s=i[e+1],r=[t,s,t+1,s+1];this.#Es._drawLines(r,this.#ut.gameOptions.debug.boundaries.boundariesColor,this.#ut.gameOptions.debug.boundaries.boundariesWidth),this.renderLoopDebug.incrementDrawCallsCounter()}l>0&&this.#Es._drawLines(r,this.#ut.gameOptions.debug.boundaries.boundariesColor,this.#ut.gameOptions.debug.boundaries.boundariesWidth),e()}))}#As(e){return new Promise(((e,t)=>{}))}#fs(){const e=this.#ut.gameOptions.render.cyclesTimeCalc.averageFPStime,t=this.renderLoopDebug.tempRCircleTPointer;let s=0;for(let e=0;e<t;e++)s+=this.renderLoopDebug.tempRCircleT[e];console.log("FPS average for",e/1e3,"sec, is ",(1e3/(s/t)).toFixed(2)),console.log("Last loop info:"),console.log("Webgl draw calls: ",this.renderLoopDebug.drawCalls),console.log("Vertices draw: ",this.renderLoopDebug.verticesDraw),this.renderLoopDebug.cleanupTempVars()}}class Te{#Rs;#Ss;#Es;#bs;#ys;#vt;#ws;#vs=!1;#Is=[];#X=new EventTarget;constructor(e,t,s){this.#Rs=document.createElement("canvas"),s.appendChild(this.#Rs),this.#Ss=this.#Rs.getContext("webgl",{stencil:!0}),this.#ys=e,this.#vt=t,this.#vs=this.systemSettings.gameOptions.render.boundaries.wholeWorldPrecalculations,this.#Es=new ce(this.#Ss,this.#ys.gameOptions,this.iLoader),this._registerRenderInit(this.#Es._initiateJsRender),this.systemSettings.gameOptions.optimization!==n.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT&&this.systemSettings.gameOptions.optimization!==n.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT||this._registerRenderInit(this.#Es._initiateWasm),this._registerRenderInit(this.fixCanvasSize),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(n.WEBGL.DRAW_PROGRAMS.IMAGES,"\n    attribute vec2 a_texCoord;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    varying vec2 v_texCoord;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n\n        mat3 translationMatrix2 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            -u_translation.x, -u_translation.y, 1\n        );\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n\n        mat3 matrix = translationMatrix1 * rotationMatrix * translationMatrix2 * scalingMatrix;\n    \n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        \n        v_texCoord = a_texCoord;\n    }","\n    precision mediump float;\n\n    uniform sampler2D u_image;\n\n    //texCoords passed in from the vertex shader\n    varying vec2 v_texCoord;\n    void main() {\n        vec4 color = texture2D(u_image, v_texCoord);\n        gl_FragColor = color;\n    }",de,ue))),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(n.WEBGL.DRAW_PROGRAMS.PRIMITIVES,"\n    precision mediump float;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n        \n        mat3 matrix = translationMatrix1 * rotationMatrix * scalingMatrix;\n\n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n    }\n","\n    precision mediump float;\n\n    uniform vec4 u_color;\n    uniform float u_fade_min; \n    uniform float u_fade_max;\n    uniform vec2 u_resolution;\n    uniform vec2 u_translation;\n\n    void main(void) {\n        vec4 p = u_color;\n        if (u_fade_min > 0.0) {\n            vec2 fix_tr = vec2(u_translation.x, u_resolution.y - u_translation.y); \n            float distance = distance(fix_tr.xy, gl_FragCoord.xy);\n            if (u_fade_min <= distance && distance <= u_fade_max) {\n                float percent = ((distance - u_fade_max) / (u_fade_min - u_fade_max)) * 100.0;\n                p.a = u_color.a * (percent / 100.0);\n            }\n        }\n\n        gl_FragColor = p;\n    }\n",ge,me))),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(n.WEBGL.DRAW_PROGRAMS.IMAGES_M,"\n    attribute vec2 a_texCoord;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_resolution;\n\n    varying vec2 v_texCoord;\n\n    void main(void) {\n        vec2 clipSpace = a_position / u_resolution * 2.0 - 1.0;\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        v_texCoord = a_texCoord;\n    }","\n    precision mediump float;\n\n    uniform sampler2D u_image;\n\n    //texCoords passed in from the vertex shader\n    varying vec2 v_texCoord;\n    void main() {\n        vec4 color = texture2D(u_image, v_texCoord);\n        gl_FragColor = color;\n    }",Ee,fe))),this._registerRenderInit(this.#Es._initWebGlAttributes)}_webGlEngine(){return this.#Es}addEventListener=(e,t,s)=>{this.#X.addEventListener(e,t,s)};removeEventListener=(e,t,s)=>{this.#X.removeEventListener(e,t,s)};get stageData(){return this.#bs}get systemSettings(){return this.#ys}get iLoader(){return this.#vt}get canvas(){return this.#Rs}get drawContext(){return this.#Ss}emit=(e,...t)=>{const s=new Event(e);s.data=[...t],this.#X.dispatchEvent(s)};isAllFilesLoaded=()=>0===this.iLoader.filesWaitingForUpload;_isRenderActive(){return!!this.#ws&&this.#ws._isActive}initiateContext=e=>Promise.all(this.#Is.map((t=>t(e))));_registerAndCompileWebGlProgram(e,t,s,i,r){return this.#Es._registerAndCompileWebGlProgram(e,t,s,i,r),Promise.resolve()}_registerRenderInit(e){this.#Is.push(e)}_registerObjectRender(e,t,s){this.#Es._registerObjectRender(e,t,s)}setCanvasSize(e,t){this.#Rs.width=e,this.#Rs.height=t,this.#Es&&this.#Es._fixCanvasSize(e,t)}fixCanvasSize=()=>{const e=this.systemSettings,t=e.canvasMaxSize.width&&e.canvasMaxSize.width<window.innerWidth?e.canvasMaxSize.width:window.innerWidth,s=e.canvasMaxSize.height&&e.canvasMaxSize.height<window.innerHeight?e.canvasMaxSize.height:window.innerHeight;return this.setCanvasSize(t,s),Promise.resolve()};_createBoundariesPrecalculations(){}_startRender=async e=>{this.fixCanvasSize(),this.#bs=e,this.systemSettings.gameOptions.library===n.LIBRARY.WEBGL&&(await this.#Cs(),this.#ws=new pe(this.systemSettings,e,this._webGlEngine()),this.#ws.addEventListener(n.EVENTS.SYSTEM.RENDER.START,(()=>this.emit(n.EVENTS.SYSTEM.RENDER.START))),this.#ws.addEventListener(n.EVENTS.SYSTEM.RENDER.END,(()=>this.emit(n.EVENTS.SYSTEM.RENDER.END))),this.#ws._start())};_stopRender=()=>{this.#ws.removeEventListener(n.EVENTS.SYSTEM.RENDER.START,this.emit(n.EVENTS.SYSTEM.RENDER.START)),this.#ws.removeEventListener(n.EVENTS.SYSTEM.RENDER.END,this.emit(n.EVENTS.SYSTEM.RENDER.END)),this.#ws._stop(),this.#ws=void 0};#Cs(){return new Promise(((e,t)=>{let s=[];const i=this.#vs;s.push(this.initiateContext(this.#bs)),i&&console.warn("isBoundariesPrecalculations() is turned off"),Promise.allSettled(s).then((s=>{s.forEach((e=>{if("rejected"===e.status){const s=e.reason;m(h,s),t(s)}})),e()}))}))}}class xe{#Os;constructor(e){this.#Os=e}registerDrawObject(e,t){this.#Os.drawObjectFactory._registerNewObjectMethod(e,t)}registerAndCompileWebGlProgram(e,t,s,i,r){return this.#Os.iRender._registerAndCompileWebGlProgram(e,t,s,i,r)}registerRenderInit(e){this.#Os.iRender._registerRenderInit(e)}registerObjectRender(e,t,s){this.#Os.iRender._registerObjectRender(e,t,s)}}class Ae{#ut;#Ps;#Ms;#Ds;#at=new G;#Bs;#Ls=new j(this.#at);#Ns=new Map;#Ws;#X=new EventTarget;constructor(e,t,s){e||g(a.CREATE_INSTANCE_ERROR,"systemSettings should be passed to class instance"),this.#ut=e,this.#Ds=new X(this.iLoader),this.#Ms=e.network.enabled?new z(e):null,this.#Bs=new Te(this.systemSettings,this.iLoader,s),this.#Ps=new xe(this),this.#Ws=t,this.#Bs.addEventListener(n.EVENTS.SYSTEM.RENDER.START,(()=>this.emit(n.EVENTS.SYSTEM.RENDER.START))),this.#Bs.addEventListener(n.EVENTS.SYSTEM.RENDER.END,(()=>this.emit(n.EVENTS.SYSTEM.RENDER.END)))}emit=(e,...t)=>{const s=new Event(e);s.data=[...t],this.#X.dispatchEvent(s)};addEventListener=(e,t,s)=>{this.#X.addEventListener(e,t,s)};removeEventListener=(e,t,s)=>{this.#X.removeEventListener(e,t,s)};get iNetwork(){return this.#Ms}get systemSettings(){return this.#ut}get audio(){return this.#Ds}get iLoader(){return this.#at}get iRender(){return this.#Bs}get drawObjectFactory(){return this.#Ls}get iExtension(){return this.#Ps}get modules(){return this.#Ns}installModule=(e,t,...s)=>{const i=new t(this,...s);return this.#Ns.has(e)?(m("MODULE_ALREADY_INSTALLED","module "+e+" is already installed"),this.#Ns.get(e)):(this.#Ns.set(e,i),i)};startGameStage=(e,t)=>{if(this.#Ws.has(e))if(!0===this.#Bs._isRenderActive())this.#Bs._stopRender(),g(a.ANOTHER_STAGE_ACTIVE," Can't start the stage "+e+" while, another stage is active");else{const s=this.#Ws.get(e),i=s.stageData;this.#Ls._attachPageData(i),!1===s.isInitiated&&s._init(),s._start(t),i._processPendingRenderObjects(),this.emit(n.EVENTS.SYSTEM.START_PAGE),this.#Bs._startRender(i)}else g(a.VIEW_NOT_EXIST,"Stage "+e+" is not registered!")};stopGameStage=e=>{this.#Ws.has(e)?(this.emit(n.EVENTS.SYSTEM.STOP_PAGE),this.drawObjectFactory._detachPageData(),this.#Bs._stopRender(),this.#Ws.get(e)._stop()):g(a.STAGE_NOT_EXIST,"GameStage "+e+" is not registered!")}}class Re{#Gs;#ks=!1;#r;#Fs;#ms;constructor(){this.#r=!1}_register(e,t){this.#Gs=e,this.#Fs=t,this.#ms=new I(this.#Fs.systemSettings.gameOptions),this.#js(),this.#Us(),this.register()}_init(){this.init(),this.#ks=!0}register(){}init(){}start(e){}stop(){}resize(){}get iLoader(){return this.#Fs.iLoader}get draw(){return this.#Fs.drawObjectFactory}_attachCanvasToContainer(e){this.#Ys(this.canvasHtmlElement,e)}addRenderObject=e=>{const t=this.stageData;-1!==t.renderObjects.indexOf(e)?m("NEW_BEHAVIOR_INTRODUCED","stage.draw methods add objects to pageData, no need to call addRenderObject"):t._renderObject=e};get isActive(){return this.#r}get isInitiated(){return this.#ks}get name(){return this.#Gs}get stageData(){return this.#ms}get systemSettings(){return this.#Fs.systemSettings}get audio(){return this.#Fs.audio}get iSystem(){return this.#Fs}get canvasHtmlElement(){return document.getElementsByTagName("canvas")[0]}addEventListener=(e,t,s)=>{this.iSystem.addEventListener(e,t,s)};removeEventListener=(e,t,s)=>{this.iSystem.removeEventListener(e,t,s)};_start(e){this.start(e),this.#r=!0,window.addEventListener("resize",this._resize),this._resize()}_stop(){this.#r=!1,window.removeEventListener("resize",this._resize),this.stop()}_resize=()=>{this.#Us(),this.resize()};#Ys(e,t){t.appendChild(e)}#js(){const e=this.systemSettings.worldSize?this.systemSettings.worldSize.width:0,t=this.systemSettings.worldSize?this.systemSettings.worldSize.height:0;this.stageData._setWorldDimensions(e,t)}isBoundariesCollision=(e,t,s)=>{const i=s.type,r=s.vertices,a=s.circleBoundaries;switch(i){case n.DRAW_TYPE.TEXT:case n.DRAW_TYPE.RECTANGLE:case n.DRAW_TYPE.CONUS:case n.DRAW_TYPE.IMAGE:return a?this.#Vs(e,t,s.circleBoundaries.r):this.#zs(e,t,r,s.rotation);case n.DRAW_TYPE.CIRCLE:m(n.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case n.DRAW_TYPE.LINE:m(n.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:m(n.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};isObjectsCollision=(e,t,s,i)=>{const r=s.type,a=s.vertices,o=s.circleBoundaries;switch(r){case n.DRAW_TYPE.TEXT:case n.DRAW_TYPE.RECTANGLE:case n.DRAW_TYPE.CONUS:case n.DRAW_TYPE.IMAGE:return o?this.#Xs(e,t,o,i):this.#Hs(e,t,a,s.rotation,i);case n.DRAW_TYPE.CIRCLE:m(n.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case n.DRAW_TYPE.LINE:m(n.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:m(n.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};#Hs(e,t,s,i,r){const a=r.length;let o=[];for(let l=0;l<a;l++){const a=r[l];let h;switch(a.type){case n.DRAW_TYPE.TEXT:case n.DRAW_TYPE.RECTANGLE:case n.DRAW_TYPE.CONUS:case n.DRAW_TYPE.IMAGE:h=this.#Ks(e,t,s,i,a);break;case n.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case n.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}h&&o.push(h)}return o.length>0?this.#Zs(o):null}#Xs(e,t,s,i){const r=s.r,a=i.length;let o=[];for(let s=0;s<a;s++){const a=i[s],l=a.type,h=a.circleBoundaries;let c;switch(l){case n.DRAW_TYPE.TEXT:case n.DRAW_TYPE.RECTANGLE:case n.DRAW_TYPE.CONUS:case n.DRAW_TYPE.IMAGE:c=h?this.#Js(e,t,r,a.x,a.y,h.r):this.#qs(e,t,r,a);break;case n.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case n.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}c&&o.push(c)}return o.length>0?this.#Zs(o):null}#Zs(e){return e.sort(((e,t)=>e.p<t.p))[0]}#qs(e,t,s,i){const[r,n]=this.stageData.worldOffset,a=e-r,o=t-n,l=i.x-r,h=i.y-n,c=i.vertices,d=i.rotation,u=c.length;for(let e=0;e<u;e+=1){const t=c[e];let i=c[e+1];i||(i=c[0]);const r=this.#Qs(t,l,h,d),n=this.#Qs(i,l,h,d),u=se(a,o,s,{x1:r[0],y1:r[1],x2:n[0],y2:n[1]});if(u)return u}return!1}#Js(e,t,s,i,r,n){const a=new w(e,t,i,r).length;return console.log(a),console.log(s),console.log(n),!(a-(s+n)>0)}#Ks(e,t,s,i,r){const[n,a]=this.stageData.worldOffset,o=e-n,l=t-a,h=r.x-n,c=r.y-a,d=r.vertices,u=r.rotation,g=s.map((e=>this.#Qs(e,o,l,i))),m=d.length;for(let e=0;e<m;e+=1){const t=d[e];let s=d[e+1];s||(s=d[0]);const i=this.#Qs(t,h,c,u),r=this.#Qs(s,h,c,u),n=$(g,{x1:i[0],y1:i[1],x2:r[0],y2:r[1]});if(n)return n}return!1}#Qs(e,t,s,i){const r=new w(0,0,e[0],e[1]),n=K(0,0,e[0],e[1]),a=r.length;return[t+a*Math.cos(i+n),s+a*Math.sin(i+n)]}#Vs(e,t,s){const i=this.stageData.getRawBoundaries(),r=this.stageData.getEllipseBoundaries(),n=this.stageData.getPointBoundaries(),[a,o]=this.stageData.worldOffset,l=e-a,h=t-o,c=this.stageData.boundariesLen,d=this.stageData.ellipseBLen,u=this.stageData.pointBLen;for(let e=0;e<c;e+=4){const t=i[e],r=i[e+1],n=i[e+2],a=i[e+3];if(0!==t||0!==r||0!==n||0!==a){const e=se(l,h,s,{x1:t,y1:r,x2:n,y2:a});if(e)return e}}if(d>0)for(let e=0;e<d;e+=4){const t=re([r[e],r[e+1],r[e+2],r[e+3]],{x:l,y:h,r:s});if(t)return t}if(u>0)for(let e=0;e<u;e+=2){const t=te(n[e],n[e+1],{x:l,y:h,r:s});if(t)return t}return!1}#zs(e,t,s,i){const r=this.stageData.getRawBoundaries(),n=this.stageData.getEllipseBoundaries(),a=this.stageData.getPointBoundaries(),[o,l]=this.stageData.worldOffset,h=e-o,c=t-l,d=s.map((e=>this.#Qs(e,h,c,i))),u=this.stageData.boundariesLen,g=this.stageData.ellipseBLen,m=this.stageData.pointBLen;for(let e=0;e<u;e+=4){const t=r[e],s=r[e+1],i=r[e+2],n=r[e+3];if(0!==t||0!==s||0!==i||0!==n){const e=$(d,{x1:t,y1:s,x2:i,y2:n});if(e)return e}}if(g>0)for(let e=0;e<g;e+=4){const t=ne([n[e],n[e+1],n[e+2],n[e+3]],d);if(t)return t}if(m>0)for(let e=0;e<m;e+=2){const t=ee(a[e],a[e+1],d);if(t)return t}return!1}#Us(){const e=this.systemSettings.canvasMaxSize.width&&this.systemSettings.canvasMaxSize.width<window.innerWidth?this.systemSettings.canvasMaxSize.width:window.innerWidth,t=this.systemSettings.canvasMaxSize.height&&this.systemSettings.canvasMaxSize.height<window.innerHeight?this.systemSettings.canvasMaxSize.height:window.innerHeight;this.stageData._setCanvasDimensions(e,t)}}class Se extends Re{#$s=0;#ei=0;#ti=0;register(){}init(){const[e,t]=this.stageData.canvasDimensions,s=e/3;this.background=this.draw.rect(0,0,e,t,this.systemSettings.gameOptions.loadingScreen.backgroundColor),this.loadingBarBg=this.draw.rect(e/2-s/2,t/2-10,s,20,this.systemSettings.gameOptions.loadingScreen.loadingBarBg),this.loadingBarProgress=this.draw.rect(e/2-s/2,t/2-10,s,20,this.systemSettings.gameOptions.loadingScreen.loadingBarProgress),this.text=this.draw.text(e/2-20,t/2-40,"JsGE","24px sans-serif","black"),this.#ti=s}_progress=e=>{const t=this.#ti/this.#$s;this.#ei=e;const s=t*this.#ei,i=e>this.#$s?this.#ti:s;this.loadingBarProgress.width=i};start(e){this.#$s=e.total}}const be="loadingPage";class ye{#si;#ii;constructor(e,t){e||g(a.CREATE_INSTANCE_ERROR,"iSystemSettings should be passed to class instance"),this.#si=new Map,t||(t=document.createElement("div"),document.body.appendChild(t)),this.#ii=new Ae(e,this.#si,t),this.registerStage(be,Se),this.#ii.iLoader.addEventListener("loadstart",this.#ri),this.#ii.iLoader.addEventListener("progress",this.#ni),this.#ii.iLoader.addEventListener("load",this.#ai)}get iSystem(){return this.#ii}registerStage(e,t){if(e&&"string"==typeof e&&e.trim().length>0){const s=new t;s._register(e,this.iSystem),this.#si.set(e,s)}else g(a.CREATE_INSTANCE_ERROR,"valid class name should be provided")}preloadAllData(){return this.#ii.iLoader.preload()}#ri=e=>{this.#ii.startGameStage(be,{total:e.total})};#ni=e=>{const t=e.loaded,s=e.total;this.#si.get(be)._progress(t,s)};#ai=()=>{this.#ii.stopGameStage(be)}}class we extends b{z=0;originalXPos;skipShifts=0;constructor(e,t,s,i,r){super(e,t,s,i,r),this.originalXPos=e}rotate=()=>{const e=Math.PI/40,t=this.width,s=this,i=s.rotation;i<Math.PI/2?(s.rotation+=e,this.x=this.originalXPos+(t-t*Math.cos(s.rotation))/2):i<Math.PI||i<3*Math.PI/2||i<2*Math.PI?(this.rotation+=e,this.x=this.originalXPos+(t-t*Math.cos(s.rotation))/2):this.rotation=0}}class ve extends f{z=0;originalXPos;#re;#ne;#ae;#oe;#le;#he;#ce;#de;#$;constructor(e,t,s,i,r,n,a,o){super("text",e,t),this.originalXPos=e,this.#he=s,this.#re=i,this.#oe=r,this.#ce,n?(this._textureStorage=n,this.#de=a,this._textMetrics=o):(this.#de=document.createElement("canvas"),this.#ue())}get boundariesBox(){const e=this.textMetrics?Math.floor(this.textMetrics.width):300,t=this.textMetrics?Math.floor(this.textMetrics.fontBoundingBoxAscent+this.textMetrics.fontBoundingBoxDescent):30;return new y(this.x,this.y-t,e,t)}get vertices(){const e=this.boundariesBox;return this._calculateRectVertices(e.width,e.height)}get text(){return this.#he}set text(e){e!==this.#he&&(this.#he=e,this.#ue())}get font(){return this.#re}set font(e){e!==this.#re&&(this.#re=e,this.#ue())}get textAlign(){return this.#ne}set textAlign(e){e!==this.#ne&&(this.#ne=e,this.#ue())}get textBaseline(){return this.#ae}set textBaseline(e){e!==this.#ae&&(this.#ae=e,this.#ue())}get fillStyle(){return this.#oe}set fillStyle(e){e!==this.#oe&&(this.#oe=e,this.#ue())}get strokeStyle(){return this.#le}set strokeStyle(e){e!==this.#le&&(this.#le=e,this.#ue())}get textMetrics(){return this.#ce}set _textMetrics(e){this.#ce=e}get _textureStorage(){return this.#$}set _textureStorage(e){this.#$=e}get _textureCanvas(){return this.#de}#ue(){const e=this.#de.getContext("2d",{willReadFrequently:!0});if(!e)throw new Error("error creating texture");{e.font=this.font,this._textMetrics=e.measureText(this.text);const t=this.boundariesBox.width,s=this.boundariesBox.height;e.canvas.width=t,e.canvas.height=s,e.clearRect(0,0,t,s),e.font=this.font,e.textBaseline="bottom",this.fillStyle&&(e.fillStyle=this.fillStyle,e.fillText(this.text,0,s)),this.strokeStyle&&(e.strokeStyle=this.strokeStyle,e.strokeText(this.text,0,s)),this.#$&&(this.#$=void 0)}}rotateAnticlockwise=()=>{const e=Math.PI/40,t=this.boundariesBox.width;this.rotation+=e,this.x=this.originalXPos+(t-t*Math.cos(this.rotation))/2};rotateClockWise=()=>{const e=Math.PI/40,t=this.boundariesBox.width;this.rotation-=e,this.x=this.originalXPos+(t-t*Math.cos(this.rotation))/2};clone=(e,t)=>new ve(e,t,this.text,this.font,this.fillStyle,this._textureStorage,this.#de,this.textMetrics)}const Ie=(e,t,s,i,r)=>new we(e,t,s,i,r),Ce=(e,t,s,i,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset,o=e.x-n,l=e.y-a,h=e.z,c=[1,1,1],d=e.rotation,{u_translation:u,u_rotation:g,u_scale:m,u_resolution:E,u_color:f,a_position:_,u_fade_min:p}=(e.blendFunc?e.blendFunc:(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),r);let T=0;t.useProgram(i),t.uniform4f(E,t.canvas.width,t.canvas.height,1e3,1),t.uniform3f(u,o,l,h),t.uniform3f(m,c[0],c[1],c[2]),t.uniform1f(g,d),t.uniform1f(p,0),t.enableVertexAttribArray(_),t.bindBuffer(t.ARRAY_BUFFER,t.createBuffer());const x=0+e.width,A=0+e.height;t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,h,x,0,h,0,A,h,0,A,h,x,0,h,x,A,h]),t.STATIC_DRAW),T+=6;const R=t.FLOAT;t.vertexAttribPointer(_,3,R,!1,0,0);const S=e.bgColor.replace("rgba(","").replace(")","").split(",").map((e=>Number(e.trim())));return t.uniform4f(f,S[0]/255,S[1]/255,S[2]/255,S[3]),Promise.resolve([6,t.TRIANGLES])},Oe=(e,t,s,i,r)=>new ve(e,t,s,i,r),Pe=(e,t,s,i,r)=>{const{u_translation:n,u_rotation:a,u_scale:o,u_resolution:l,a_position:h,a_texCoord:c,u_image:d}=r,{width:u,height:g}=e.boundariesBox,[m,E]=(e.text,!0===e.isOffsetTurnedOff?[0,0]:s.worldOffset),f=e.x-m,_=e.y-E-g,p=e.z,T=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],x=e.rotation,A=[1,1,1],R=0+u,S=0+g,b=[0,0,p,R,0,p,0,S,p,0,S,p,R,0,p,R,S,p];let y=0;t.useProgram(i),t.uniform4f(l,t.canvas.width,t.canvas.height,1e3,1),t.uniform3f(n,f,_,p),t.uniform3f(o,A[0],A[1],A[2]),t.uniform1f(a,x),t.bindBuffer(t.ARRAY_BUFFER,t.createBuffer()),t.bufferData(t.ARRAY_BUFFER,new Float32Array(b),t.STATIC_DRAW),t.enableVertexAttribArray(h);const w=t.FLOAT;t.vertexAttribPointer(h,3,w,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,t.createBuffer()),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(c),t.vertexAttribPointer(c,2,t.FLOAT,!1,0,0),y+=6,t.blendFunc(T[0],T[1]);let v=e._textureStorage;return v||(v=new he(t.createTexture()),e._textureStorage=v),!0===v._isTextureRecalculated?(v._isTextureRecalculated=!1,t.activeTexture(t.TEXTURE0+0),t.bindTexture(t.TEXTURE_2D,v._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e._textureCanvas),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST)):(t.activeTexture(t.TEXTURE0+0),t.bindTexture(t.TEXTURE_2D,v._texture)),t.uniform1i(d,v._textureIndex),t.depthMask(!1),Promise.resolve([6,t.TRIANGLES])};class Me extends Re{#oi;#li;#hi;#ci=0;#di=0;#ui=1;#gi="";#mi;#Ei=[];#fi="";#_i=!1;#pi=!1;#Ti=!1;#xi=0;#Ai=0;#Ri;#Si;#bi=new Map;register(){const e=this.systemSettings.customSettings;this.iLoader.registerLoader("Words",((e,t)=>fetch(t).then((e=>e.text())))),this.iLoader.addWords("englishNouns",e.words_list_url),this.#ci=e.letterNum,this.#di=e.attempts,this.#li=e.letterCardSize,this.#oi=e.letterCardSpaces,this.#hi=e.shiftSize}init(){this.#yi()}start(){this.registerEventListeners()}stop(){this.unregisterEventListeners()}registerEventListeners(){this.canvasHtmlElement.addEventListener("mousemove",this.#wi),document.addEventListener("click",this.#vi),document.addEventListener("keydown",this.#Ii)}#wi=e=>{};#vi=e=>{const t=e.target.dataset;if(t.action)switch(t.action){case"input":if(this.#_i||this.#pi||this.#Ti)return!1;const e=t.value;this.#Ci(e);break;case"clear":if(this.#_i||this.#pi||this.#Ti)return!1;this.#Oi();break;case"confirm":if(this.#_i||this.#pi||this.#Ti)return!1;this.#Pi();break;case"next_screen":this.#Mi(),this.#Di();break;case"game_over":!1===this.#_i&&!1===this.#pi&&this.#Bi();break;case"reset":!1===this.#_i&&!1===this.#pi?(this.#Bi(!1),this.#Di()):this.#Di()}else console.log("clicked something else")};#Li=()=>new Promise(((e,t)=>{const s=this.#Ei.length;if(s>0){for(let e=0;e<s;e++){const t=this.#Ei[e];for(let e=0;e<t.length;e++){const s=t[e];s.card.destroy(),delete s.card,s.letter&&(s.letter.destroy(),delete s.letter)}}e()}else e()}));#Ni=()=>{this.#ci;const e=this.#li;this.#oi;for(let t=0;t<this.#di;t++){const s=[],i=t*e+(t>0?t*this.#oi:0)+this.#hi;for(let t=0;t<this.#ci;t++){const r=t*e+(t>0?t*this.#oi:0),n=this.draw.rotateYObject(r,i,e,e,"rgba(0, 0, 0, 1)");s.push({letter:null,card:n})}this.#Ei[t]=s}};#Wi=e=>this.#mi.find((t=>t===e));#Gi=e=>{const t=this.#ci,s=this.#ui-1;let i=[],r=[],n=[];for(let a=0;a<t;a++){const t=e[a],o=this.#fi[a],l=this.#Ei[s][a];t===o&&(i.push(a),r.push(a),l.color="yellow",l.index=a,n.push(l))}for(let a=0;a<t;a++)if(!i.includes(a)){const t=e[a],o=this.#Ei[s][a],l=this.#fi.split("").findIndex(((e,s)=>e===t&&!r.includes(s)));if(-1!==l)i.push(a),r.push(l),o.color="light-grey",o.index=a,n.push(o);else{const e=-1===this.#fi.indexOf(t);o.color="dark-grey",o.index=a,n.push(o),e&&this.#ki(t)}}return n.sort(((e,t)=>e.index-t.index)),n};#Fi(){this.#ui===this.#di?this.#Bi():(this.#ui+=1,this.#gi="")}#ji=()=>{this.#xi+=1,this.#_i&&(this.#Ai+=1,document.getElementById("wins").innerText=this.#Ai),document.getElementById("games").innerText=this.#xi};#ki=e=>{document.querySelector(`[data-value="${e}"]`).classList.add("marked")};#Ui=()=>{const e=document.getElementsByTagName("button");for(const t of e)t.classList.remove("marked")};#Yi=e=>{console.log("---\x3e>>>error"),console.log(e)};unregisterEventListeners(){}#yi=()=>{this.#bi.set("q",this.draw.rotateYText(0,0,"q","50px sans-serif","white")),this.#bi.set("w",this.draw.rotateYText(0,0,"w","50px sans-serif","white")),this.#bi.set("e",this.draw.rotateYText(0,0,"e","50px sans-serif","white")),this.#bi.set("r",this.draw.rotateYText(0,0,"r","50px sans-serif","white")),this.#bi.set("t",this.draw.rotateYText(0,0,"t","50px sans-serif","white")),this.#bi.set("y",this.draw.rotateYText(0,0,"y","50px sans-serif","white")),this.#bi.set("u",this.draw.rotateYText(0,0,"u","50px sans-serif","white")),this.#bi.set("i",this.draw.rotateYText(0,0,"i","50px sans-serif","white")),this.#bi.set("o",this.draw.rotateYText(0,0,"o","50px sans-serif","white")),this.#bi.set("p",this.draw.rotateYText(0,0,"p","50px sans-serif","white")),this.#bi.set("a",this.draw.rotateYText(0,0,"a","50px sans-serif","white")),this.#bi.set("s",this.draw.rotateYText(0,0,"s","50px sans-serif","white")),this.#bi.set("d",this.draw.rotateYText(0,0,"d","50px sans-serif","white")),this.#bi.set("f",this.draw.rotateYText(0,0,"f","50px sans-serif","white")),this.#bi.set("g",this.draw.rotateYText(0,0,"g","50px sans-serif","white")),this.#bi.set("h",this.draw.rotateYText(0,0,"h","50px sans-serif","white")),this.#bi.set("j",this.draw.rotateYText(0,0,"j","50px sans-serif","white")),this.#bi.set("k",this.draw.rotateYText(0,0,"k","50px sans-serif","white")),this.#bi.set("l",this.draw.rotateYText(0,0,"l","50px sans-serif","white")),this.#bi.set("z",this.draw.rotateYText(0,0,"z","50px sans-serif","white")),this.#bi.set("x",this.draw.rotateYText(0,0,"x","50px sans-serif","white")),this.#bi.set("c",this.draw.rotateYText(0,0,"c","50px sans-serif","white")),this.#bi.set("v",this.draw.rotateYText(0,0,"v","50px sans-serif","white")),this.#bi.set("b",this.draw.rotateYText(0,0,"b","50px sans-serif","white")),this.#bi.set("n",this.draw.rotateYText(0,0,"n","50px sans-serif","white")),this.#bi.set("m",this.draw.rotateYText(0,0,"m","50px sans-serif","white")),setTimeout((()=>{for(const e of this.#bi.values())e.destroy()}),500)};#Ci=e=>{const t=-this.#hi,s=this.#gi.length,i=document.getElementById("confirm"),r=this.#ui-1,n=this.#Ei[r][s],a=n?n.card:null;if(s!==this.#ci){this.#gi+=e;const r=a.x+a.width/3.2,o=a.y+a.height-a.height/10,l=this.#bi.get(e).clone(r,o);this.addRenderObject(l),n.letter=l,n.letter.y+=t,n.card.y+=t,setTimeout((()=>{n.letter&&(n.letter.y-=t),n.card.y-=t}),100),s+1===this.#ci&&(i.disabled=!1)}};#Oi=()=>{const e=this.#gi.length,t=document.getElementById("confirm"),s=this.#ui-1,i=this.#Ei[s][e-1];e>0&&(i.letter.destroy(),i.letter=null,this.#gi=this.#gi.slice(0,-1)),!1===t.disabled&&(t.disabled=!0)};#Pi=()=>{const e=this.#gi,t=document.getElementById("confirm");if(this.#Wi(e)){this.#Ti=!0;const s=this.#Gi(e);s.sort(),this.#Vi(s).then((()=>{this.#Ti=!1,e===this.#fi?(this.#_i=!0,setTimeout((()=>this.#zi()),500),this.#ji()):(this.#Fi(),t.disabled=!0)}))}else alert("Введите английское существительное!")};#Ii=e=>{const t=e.key;if(this.#_i||this.#pi||this.#Ti)return!1;switch(t){case"q":case"w":case"e":case"r":case"t":case"y":case"u":case"i":case"o":case"p":case"a":case"s":case"d":case"f":case"g":case"h":case"j":case"k":case"l":case"z":case"x":case"c":case"v":case"b":case"n":case"m":this.#Ci(t);break;case"Backspace":this.#Oi();break;case"Enter":console.log("confirm"),this.#Pi()}};#Xi=e=>{const t=e.length;return e[Math.floor(Math.random()*t)]};#Vi=async e=>{for(let t=0;t<e.length;t++){const s=e[t];await this.#Hi(s)}return Promise.resolve()};#Hi=async e=>new Promise(((t,s)=>{const i=e.color,r=e.card,n=e.letter,a=setInterval((()=>{if(r.rotation>=Math.PI&&(clearInterval(a),t()),r.rotation>=Math.PI/2)switch(n.rotateClockWise(),i){case"yellow":n.fillStyle="rgba(0, 0, 0, 1)",r.bgColor="rgba(253, 208, 53, 1)";break;case"light-grey":n.fillStyle="rgba(0, 0, 0, 1)",r.bgColor="rgba(211, 211, 211, 1)";break;case"dark-grey":r.bgColor="rgba(51, 51, 51, 1)"}else n.rotateAnticlockwise();r.rotate()}),15)}));#Mi=()=>{document.getElementById("first_screen").style.display="none",document.getElementById("second_screen").style.display="block"};#Bi=(e=!0)=>{const t=this.systemSettings.customSettings.yandex_api_key;fetch("https://dictionary.yandex.net/api/v1/dicservice.json/lookup?key="+t+"&lang=en-ru&text="+this.#fi).then((e=>e.json())).then((t=>{const s=t.def.find((e=>"noun"===e.pos)),i=s?s.tr:null;let r="";i&&i.forEach(((e,t)=>{r+=e.text+(t!==i.length-1?", ":".")})),e&&this.#Ki("<h3>Вы проиграли!!!</h3><p>Загаданное слово: </p><p><b>"+this.#fi+(i?"</b> - "+r+"</p>":""))})),this.#pi=!0,this.#ji()};#zi=()=>{const e=this.systemSettings.customSettings.yandex_api_key;fetch("https://dictionary.yandex.net/api/v1/dicservice.json/lookup?key="+e+"&lang=en-ru&text="+this.#fi).then((e=>e.json())).then((e=>{const t=e.def.find((e=>"noun"===e.pos)),s=t?t.tr:null;let i="";s&&s.forEach(((e,t)=>{i+=e.text+(t!==s.length-1?", ":".")})),this.#Ki("<h3>Вы победили!!!</h3><p><b>"+this.#fi+(s?"</b> - "+i+"</p>":""))}))};#Ki=e=>{const t=document.getElementById("popup"),s=document.getElementById("game");document.getElementById("message").innerHTML=e,document.getElementById("overlay").style.display="block",t.style.left=s.offsetLeft+"px",t.style.display="block",window.innerWidth-60>t.offsetWidth&&(t.style.left=window.innerWidth/2-t.offsetWidth/2+"px"),t.style.top=window.innerHeight/2-t.offsetHeight/2+"px"};#Zi=()=>{document.getElementById("popup").style.display="none",document.getElementById("overlay").style.display="none"};#Di=()=>{console.log("---\x3e>>start game"),document.getElementById("reset").blur();const e=document.getElementById("contactChoice1"),t=document.getElementById("contactChoice2"),s=document.getElementById("contactChoice4"),i=document.getElementById("confirm");this.#Zi(),i.disbled=!0,e.checked?this.#ci=3:t.checked?this.#ci=4:s.checked&&(this.#ci=6);const r=this.#ci,n=this.#li,a=this.#oi,o=this.#di,l=r*n+(r-1)*a,h=o*n+(o-1)*a+this.#hi;this.#Ri=l,this.#Si=h,this.systemSettings.canvasMaxSize.width=l,this.systemSettings.canvasMaxSize.height=h,this.iSystem.iRender.fixCanvasSize();const c=this.iLoader.getWords("englishNouns");this.#mi=c.split("\r\n").filter((e=>e.length===r)),this.#Ui(),this.#ui=1,this.#gi="",this.#_i=!1,this.#pi=!1,this.#Ti=!1,this.#fi=this.#Xi(this.#mi),this.#Li().then((()=>this.#Ni()))}}const De=["u_translation","u_rotation","u_scale","u_resolution","u_fade_min","u_fade_max","u_color"],Be=["a_position"],Le=["u_translation","u_rotation","u_scale","u_resolution","u_image"],Ne=["a_position","a_texCoord"];U.customSettings={letterNum:5,attempts:6,letterCardSize:70,letterCardSpaces:3,shiftSize:2,yandex_api_key:"dict.1.1.20240616T070649Z.78c07cd3af68b4d6.c71c1cb194341c724097b0e1e1656e2a4b37f81f",words_list_url:"/sites/default/files/words.txt"},document.addEventListener("DOMContentLoaded",(function(e){const t=new ye(U,document.getElementById("game"));t.iSystem.iExtension.registerAndCompileWebGlProgram("rotateYProgram","\n    precision mediump float;\n\n    attribute vec4 a_position;\n\n    uniform vec3 u_translation;\n    uniform float u_rotation;\n    uniform vec3 u_scale;\n\n    uniform vec4 u_resolution;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat4 projection = mat4(\n            2.0 / u_resolution.x, 0, 0, 0,\n            0, -2.0 / u_resolution.y, 0, 0,\n            0, 0, 2.0 / u_resolution.z, 0,\n            -1, 1, 0, 1\n        );\n\n        mat4 translationMatrix = mat4(\n            1, 0, 0, 0,\n            0, 1, 0, 0,\n            0, 0, 1, 0,\n            u_translation.x,  u_translation.y, u_translation.z, 1\n        );\n        // y-rotation\n        mat4 rotationMatrix = mat4(\n            c, 0, -s, 0,\n            0, 1, 0, 0,\n            s, 0, c, 0,\n            0, 0, 0, 1\n        );\n        \n        mat4 scalingMatrix = mat4(\n            u_scale.x, 0, 0, 0,\n            0, u_scale.y, 0, 0,\n            0, 0, u_scale.z, 0,\n            0, 0, 0, 1\n        );\n        mat4 matrix = projection * translationMatrix * rotationMatrix * scalingMatrix;\n        \n        gl_Position = matrix * a_position;\n    }\n","\n    precision mediump float;\n\n    uniform vec4 u_color;\n    uniform float u_fade_min; \n    uniform float u_fade_max;\n    uniform vec4 u_resolution;\n    uniform vec3 u_translation;\n\n    void main(void) {\n        vec4 p = u_color;\n        if (u_fade_min > 0.0) {\n            vec2 fix_tr = vec2(u_translation.x, u_resolution.y - u_translation.y); \n            float distance = distance(fix_tr.xy, gl_FragCoord.xy);\n            if (u_fade_min <= distance && distance <= u_fade_max) {\n                float percent = ((distance - u_fade_max) / (u_fade_min - u_fade_max)) * 100.0;\n                p.a = u_color.a * (percent / 100.0);\n            }\n        }\n\n        gl_FragColor = p;\n    }\n",De,Be),t.iSystem.iExtension.registerDrawObject("rotateYObject",Ie),t.iSystem.iExtension.registerObjectRender(we.name,Ce,"rotateYProgram"),t.iSystem.iExtension.registerAndCompileWebGlProgram("rotateYTextProgram","\n    attribute vec2 a_texCoord;\n\n    attribute vec4 a_position;\n\n    uniform vec3 u_translation;\n    uniform float u_rotation;\n    uniform vec3 u_scale;\n\n    uniform vec4 u_resolution;\n\n    varying vec2 v_texCoord;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat4 projection = mat4(\n            2.0 / u_resolution.x, 0, 0, 0,\n            0, -2.0 / u_resolution.y, 0, 0,\n            0, 0, 2.0 / u_resolution.z, 0,\n            -1, 1, 0, 1\n        );\n        \n        mat4 translationMatrix = mat4(\n            1, 0, 0, 0,\n            0, 1, 0, 0,\n            0, 0, 1, 0,\n            u_translation.x,  u_translation.y, u_translation.z, 1\n        );\n        // y-rotation\n        mat4 rotationMatrix = mat4(\n            c, 0, -s, 0,\n            0, 1, 0, 0,\n            s, 0, c, 0,\n            0, 0, 0, 1\n        );\n        \n        mat4 scalingMatrix = mat4(\n            u_scale.x, 0, 0, 0,\n            0, u_scale.y, 0, 0,\n            0, 0, u_scale.z, 0,\n            0, 0, 0, 1\n        );\n        mat4 matrix = projection * translationMatrix * rotationMatrix * scalingMatrix;\n        \n        gl_Position = matrix * a_position;\n        \n        v_texCoord = a_texCoord;\n    }","\n    precision mediump float;\n\n    uniform sampler2D u_image;\n\n    //texCoords passed in from the vertex shader\n    varying vec2 v_texCoord;\n    void main() {\n        vec4 color = texture2D(u_image, v_texCoord);\n        gl_FragColor = color;\n    }",Le,Ne),t.iSystem.iExtension.registerDrawObject("rotateYText",Oe),t.iSystem.iExtension.registerObjectRender(ve.name,Pe,"rotateYTextProgram"),t.registerStage("WordsGame",Me),t.preloadAllData().then((()=>{t.iSystem.startGameStage("WordsGame")}))}));